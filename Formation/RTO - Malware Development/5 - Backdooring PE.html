
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Backdooring PE Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="4 - Function Call Obfuscation.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <a target="_blank" href="https://twitter.com/OtterHacker">
            
                    
                    Follow On Twitter
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    Formation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" >
            
                <span>
            
                    
                    Malware Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1.1" data-path="0 - Introduction.html">
            
                <a href="0 - Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.2" data-path="1 - PE.html">
            
                <a href="1 - PE.html">
            
                    
                    PE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.3" data-path="2 - Payload Storage.html">
            
                <a href="2 - Payload Storage.html">
            
                    
                    Payload Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.4" data-path="3 - Payload Encryption.html">
            
                <a href="3 - Payload Encryption.html">
            
                    
                    Payload Encryption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.5" data-path="4 - Function Call Obfuscation.html">
            
                <a href="4 - Function Call Obfuscation.html">
            
                    
                    Function Call Obfuscation
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.1.6" data-path="5 - Backdooring PE.html">
            
                <a href="5 - Backdooring PE.html">
            
                    
                    Backdooring PE
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Malware
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" >
            
                <span>
            
                    
                    Docs
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1.1" data-path="../../Malware/Docs/Code snippet.html">
            
                <a href="../../Malware/Docs/Code snippet.html">
            
                    
                    Code Snippet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.2" data-path="../../Malware/Docs/Dumpbin.html">
            
                <a href="../../Malware/Docs/Dumpbin.html">
            
                    
                    Dumpbin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.3" data-path="../../Malware/Docs/NTStructure.html">
            
                <a href="../../Malware/Docs/NTStructure.html">
            
                    
                    NTStructure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.4" data-path="../../Malware/Docs/Passing arguments.html">
            
                <a href="../../Malware/Docs/Passing arguments.html">
            
                    
                    Passing Arguments
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../Malware/CoffLoader.html">
            
                <a href="../../Malware/CoffLoader.html">
            
                    
                    COFF Loader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../Malware/Elastic EDR.html">
            
                <a href="../../Malware/Elastic EDR.html">
            
                    
                    Elastic EDR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../../Malware/ETW.html">
            
                <a href="../../Malware/ETW.html">
            
                    
                    ETW
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../../Malware/Function hooking.html">
            
                <a href="../../Malware/Function hooking.html">
            
                    
                    Function Hooking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../../Malware/Kernel callback.html">
            
                <a href="../../Malware/Kernel callback.html">
            
                    
                    Kernel Callback
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../../Malware/Module stomping.html">
            
                <a href="../../Malware/Module stomping.html">
            
                    
                    Module Stomping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../../Malware/Reflective DLL injection.html">
            
                <a href="../../Malware/Reflective DLL injection.html">
            
                    
                    Reflective DLL Injection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Pentest
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" >
            
                <span>
            
                    
                    Cloud
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.1" data-path="../../Pentest/Cloud/Azure.html">
            
                <a href="../../Pentest/Cloud/Azure.html">
            
                    
                    Azure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2" >
            
                <span>
            
                    
                    Configuration Review
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.1" data-path="../../Pentest/Configuration review/Database.html">
            
                <a href="../../Pentest/Configuration review/Database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.2" data-path="../../Pentest/Configuration review/Kubernetes.html">
            
                <a href="../../Pentest/Configuration review/Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3" data-path="../../Pentest/Configuration review/KubernetesCIS.html">
            
                <a href="../../Pentest/Configuration review/KubernetesCIS.html">
            
                    
                    KubernetesCIS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.3" >
            
                <span>
            
                    
                    Services
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.3.1" data-path="../../Pentest/Services/AD.html">
            
                <a href="../../Pentest/Services/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.2" >
            
                <span>
            
                    
                    Databases
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.3.2.1" data-path="../../Pentest/Services/Oracle database.html">
            
                <a href="../../Pentest/Services/Oracle database.html">
            
                    
                    Oracle Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.2.2" data-path="../../Pentest/Services/MSSQL.html">
            
                <a href="../../Pentest/Services/MSSQL.html">
            
                    
                    MSSQL
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.3.3" data-path="../../Pentest/Services/DNS.html">
            
                <a href="../../Pentest/Services/DNS.html">
            
                    
                    DNS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.4" data-path="../../Pentest/Services/IPMI.html">
            
                <a href="../../Pentest/Services/IPMI.html">
            
                    
                    IPMI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.5" data-path="../../Pentest/Services/Kerberos.html">
            
                <a href="../../Pentest/Services/Kerberos.html">
            
                    
                    Kerberos
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.6" data-path="../../Pentest/Services/LDAP.html">
            
                <a href="../../Pentest/Services/LDAP.html">
            
                    
                    LDAP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.7" data-path="../../Pentest/Services/Memcached.html">
            
                <a href="../../Pentest/Services/Memcached.html">
            
                    
                    Memcached
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.8" data-path="../../Pentest/Services/NFS.html">
            
                <a href="../../Pentest/Services/NFS.html">
            
                    
                    NFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.9" data-path="../../Pentest/Services/RPC.html">
            
                <a href="../../Pentest/Services/RPC.html">
            
                    
                    RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.10" data-path="../../Pentest/Services/SMB.html">
            
                <a href="../../Pentest/Services/SMB.html">
            
                    
                    SMB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.11" data-path="../../Pentest/Services/SNMP.html">
            
                <a href="../../Pentest/Services/SNMP.html">
            
                    
                    SNMP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.12" data-path="../../Pentest/Services/Tomcat.html">
            
                <a href="../../Pentest/Services/Tomcat.html">
            
                    
                    Tomcat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.13" data-path="../../Pentest/Services/WebDAV.html">
            
                <a href="../../Pentest/Services/WebDAV.html">
            
                    
                    WebDAV
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4" >
            
                <span>
            
                    
                    Techniques
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.1" data-path="../../Pentest/Techniques/Abuse tokens.html">
            
                <a href="../../Pentest/Techniques/Abuse tokens.html">
            
                    
                    Abuse Tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.2" data-path="../../Pentest/Techniques/Buffer overflow.html">
            
                <a href="../../Pentest/Techniques/Buffer overflow.html">
            
                    
                    Buffer Overflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.3" data-path="../../Pentest/Techniques/Command injection.html">
            
                <a href="../../Pentest/Techniques/Command injection.html">
            
                    
                    Command Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.4" data-path="../../Pentest/Techniques/Data exfiltration.html">
            
                <a href="../../Pentest/Techniques/Data exfiltration.html">
            
                    
                    Data Exfiltration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.5" data-path="../../Pentest/Techniques/Exploit handles.html">
            
                <a href="../../Pentest/Techniques/Exploit handles.html">
            
                    
                    Exploit handles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.6" data-path="../../Pentest/Techniques/Filtering.html">
            
                <a href="../../Pentest/Techniques/Filtering.html">
            
                    
                    Filtering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.7" data-path="../../Pentest/Techniques/Kioske escape.html">
            
                <a href="../../Pentest/Techniques/Kioske escape.html">
            
                    
                    Kioske Escape
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.8" data-path="../../Pentest/Techniques/LFI.html">
            
                <a href="../../Pentest/Techniques/LFI.html">
            
                    
                    LFI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.9" data-path="../../Pentest/Techniques/Password spraying.html">
            
                <a href="../../Pentest/Techniques/Password spraying.html">
            
                    
                    Password Spraying
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.10" data-path="../../Pentest/Techniques/Pivoting.html">
            
                <a href="../../Pentest/Techniques/Pivoting.html">
            
                    
                    Pivoting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.11" >
            
                <span>
            
                    
                    Privilege Escalation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.11.1" data-path="../../Pentest/Techniques/Privileges escalation/Windows.html">
            
                <a href="../../Pentest/Techniques/Privileges escalation/Windows.html">
            
                    
                    Windows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.11.2" data-path="../../Pentest/Techniques/Privileges escalation/Linux.html">
            
                <a href="../../Pentest/Techniques/Privileges escalation/Linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4.12" data-path="../../Pentest/Techniques/Reverse shell.html">
            
                <a href="../../Pentest/Techniques/Reverse shell.html">
            
                    
                    Reverse Shell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.13" data-path="../../Pentest/Techniques/Shellshock.html">
            
                <a href="../../Pentest/Techniques/Shellshock.html">
            
                    
                    Shellshock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.14" data-path="../../Pentest/Techniques/SQL injection.html">
            
                <a href="../../Pentest/Techniques/SQL injection.html">
            
                    
                    SQL Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.15" data-path="../../Pentest/Techniques/SSTI.html">
            
                <a href="../../Pentest/Techniques/SSTI.html">
            
                    
                    SSTI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.5" >
            
                <span>
            
                    
                    Technology
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.5.1" data-path="../../Pentest/Technology/AD.html">
            
                <a href="../../Pentest/Technology/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.2" data-path="../../Pentest/Technology/IOS.html">
            
                <a href="../../Pentest/Technology/IOS.html">
            
                    
                    IOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.3" data-path="../../Pentest/Technology/NAC.html">
            
                <a href="../../Pentest/Technology/NAC.html">
            
                    
                    NAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.4" data-path="../../Pentest/Technology/Port Knocking.html">
            
                <a href="../../Pentest/Technology/Port Knocking.html">
            
                    
                    Port Knocking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.5" data-path="../../Pentest/Technology/SAML.html">
            
                <a href="../../Pentest/Technology/SAML.html">
            
                    
                    SAML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.6" data-path="../../Pentest/Technology/SAP.html">
            
                <a href="../../Pentest/Technology/SAP.html">
            
                    
                    SAP
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.6" >
            
                <span>
            
                    
                    Tools
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.6.1" data-path="../../Pentest/Tools/BloundHound.html">
            
                <a href="../../Pentest/Tools/BloundHound.html">
            
                    
                    BloundHound
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.2" data-path="../../Pentest/Tools/CME.html">
            
                <a href="../../Pentest/Tools/CME.html">
            
                    
                    CME
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.3" data-path="../../Pentest/Tools/Curl.html">
            
                <a href="../../Pentest/Tools/Curl.html">
            
                    
                    Curl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.4" data-path="../../Pentest/Tools/Ffuf.html">
            
                <a href="../../Pentest/Tools/Ffuf.html">
            
                    
                    FFUF
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.5" data-path="../../Pentest/Tools/Find.html">
            
                <a href="../../Pentest/Tools/Find.html">
            
                    
                    Find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.6" data-path="../../Pentest/Tools/Hydra.html">
            
                <a href="../../Pentest/Tools/Hydra.html">
            
                    
                    Hydra
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.7" data-path="../../Pentest/Tools/PowerView.html">
            
                <a href="../../Pentest/Tools/PowerView.html">
            
                    
                    PowerView
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.8" data-path="../../Pentest/Tools/Powershell.html">
            
                <a href="../../Pentest/Tools/Powershell.html">
            
                    
                    Powershell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.9" data-path="../../Pentest/Tools/Responder.html">
            
                <a href="../../Pentest/Tools/Responder.html">
            
                    
                    Responder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.10" data-path="../../Pentest/Tools/Rubeus.html">
            
                <a href="../../Pentest/Tools/Rubeus.html">
            
                    
                    Rubeus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.11" data-path="../../Pentest/Tools/Strace.html">
            
                <a href="../../Pentest/Tools/Strace.html">
            
                    
                    Strace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.12" data-path="../../Pentest/Tools/Wfuzz.html">
            
                <a href="../../Pentest/Tools/Wfuzz.html">
            
                    
                    Wfuzz
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" >
            
                <span>
            
                    
                    Rainy Sunday
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../../Serveur/KMS/KMS.html">
            
                <a href="../../Serveur/KMS/KMS.html">
            
                    
                    KMS Activation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../../Serveur/LicenceKey.html">
            
                <a href="../../Serveur/LicenceKey.html">
            
                    
                    Licence Key
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Backdooring PE</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="backdooring-pe">Backdooring PE</h1>
<h1 id="table-of-content">Table of content</h1>
<!-- toc -->
<ul>
<li><a href="#trojans-what-is-is-">Trojans, what is is ?</a></li>
<li><a href="#use-case">Use case</a></li>
<li><a href="#how-to-backdoor-pe-files">How to backdoor PE files</a></li>
<li><a href="#hands-on">Hands on</a><ul>
<li><a href="#find-the-code-cave">Find the code cave</a></li>
<li><a href="#jump-on-your-code-cave">Jump on your code cave</a></li>
<li><a href="#save-the-program-state">Save the program state</a></li>
<li><a href="#paste-the-shellcode">Paste the shellcode</a></li>
<li><a href="#restore-the-machine-state">Restore the machine state</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1 id="trojans-what-is-is-">Trojans, what is is ?</h1>
<p><code>Trojans</code> are regular programs mimicking a legit program and running a malware in the foreground.</p>
<p>The purpose is to convince the victim the program she used is a legit one and she can use it.</p>
<h1 id="use-case">Use case</h1>
<p>You have access to a file server used by a company.</p>
<p>You can backdoor one of their legit program to turn it into a trojan and make it execute your malware.</p>
<p>If you target an executable that need high privileges, such as <code>PsExec</code> you can use it for privileges escalation and move laterally.</p>
<h1 id="how-to-backdoor-pe-files">How to backdoor PE files</h1>
<ol>
<li><p><code>Code cave</code> : spare space in a <code>PE</code> file such as a text segment that is not occupied by data. The downsize is the avalaible size you get to inject your malware (few hundred bytes of space).</p>
</li>
<li><p><code>New section</code> : it is the most powerfull method cause it gives you the freedom to create a size on any size you need. The downsize is that you have to set the section as executable and <code>EDR</code> can easily spot it.</p>
</li>
<li><p><code>Extending section</code> : you pick some section and increase its size to host your code. It can be done with the <code>text</code> section but need more effort</p>
</li>
</ol>
<p>These methods can be combined : you find a little <code>code cave</code> in the <code>text</code> section and then you load your shellcode in it. 
Your shellcode will then load additional code from another section or resources. This section does not need to be set as executable and thus, it limits the detection.</p>
<h1 id="hands-on">Hands on</h1>
<h2 id="find-the-code-cave">Find the code cave</h2>
<p>You can use a decompiler or a debugger to find free space in the <code>.text</code> section.</p>
<p>Usually, there is free space at the end of the program:</p>
<p><img src="img/5-BackdooringPE/CodeCave.png" alt="Code cave"></p>
<h2 id="jump-on-your-code-cave">Jump on your code cave</h2>
<p>The program must be patched to jump on the code cave. Thus, locate the address of the code cave, and replace one instruction with :</p>
<pre><code class="lang-asm">jmp ${codeCaveAddress}
</code></pre>
<p>Do not forget to save the instruction erased to restore them at the end of you shellcode.</p>
<p>To avoid program disruption, the shellcode must return to the primary address or the program will crash.</p>
<h2 id="save-the-program-state">Save the program state</h2>
<p>The shellcode will change the program state (register, stack, etc...). Thus, the state must be saved before executing the shellcode.</p>
<p>The first shellcode instruction must be :</p>
<ul>
<li><code>pushad</code> : push all registers on the stack</li>
<li><code>pushfd</code> : push all flags on the stack </li>
</ul>
<h2 id="paste-the-shellcode">Paste the shellcode</h2>
<p>The shellcode can be pasted on the <code>code cave</code>.</p>
<h2 id="restore-the-machine-state">Restore the machine state</h2>
<p>At the end of the shellcode, the stack, register and flag state must be restored :</p>
<ul>
<li><code>popfd</code> : restore the flags from the stack</li>
<li><code>popad</code> : restore the registers from the stack</li>
</ul>
<p>Then you need to restore the instructions replaced by the originel <code>jump</code>.</p>
<p>Finally, jump just after the initial <code>jump</code>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="4 - Function Call Obfuscation.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Function Call Obfuscation">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Backdooring PE","level":"2.1.1.6","depth":3,"next":{"title":"Malware","level":"3.1","depth":1,"ref":"","articles":[{"title":"Docs","level":"3.1.1","depth":2,"ref":"","articles":[{"title":"Code Snippet","level":"3.1.1.1","depth":3,"path":"Malware/Docs/Code snippet.md","ref":"Malware/Docs/Code snippet.md","articles":[]},{"title":"Dumpbin","level":"3.1.1.2","depth":3,"path":"Malware/Docs/Dumpbin.md","ref":"Malware/Docs/Dumpbin.md","articles":[]},{"title":"NTStructure","level":"3.1.1.3","depth":3,"path":"Malware/Docs/NTStructure.md","ref":"Malware/Docs/NTStructure.md","articles":[]},{"title":"Passing Arguments","level":"3.1.1.4","depth":3,"path":"Malware/Docs/Passing arguments.md","ref":"Malware/Docs/Passing arguments.md","articles":[]}]},{"title":"COFF Loader","level":"3.1.2","depth":2,"path":"Malware/CoffLoader.md","ref":"Malware/CoffLoader.md","articles":[]},{"title":"Elastic EDR","level":"3.1.3","depth":2,"path":"Malware/Elastic EDR.md","ref":"Malware/Elastic EDR.md","articles":[]},{"title":"ETW","level":"3.1.4","depth":2,"path":"Malware/ETW.md","ref":"Malware/ETW.md","articles":[]},{"title":"Function Hooking","level":"3.1.5","depth":2,"path":"Malware/Function hooking.md","ref":"Malware/Function hooking.md","articles":[]},{"title":"Kernel Callback","level":"3.1.6","depth":2,"path":"Malware/Kernel callback.md","ref":"Malware/Kernel callback.md","articles":[]},{"title":"Module Stomping","level":"3.1.7","depth":2,"path":"Malware/Module stomping.md","ref":"Malware/Module stomping.md","articles":[]},{"title":"Reflective DLL Injection","level":"3.1.8","depth":2,"path":"Malware/Reflective DLL injection.md","ref":"Malware/Reflective DLL injection.md","articles":[]}]},"previous":{"title":"Function Call Obfuscation","level":"2.1.1.5","depth":3,"path":"Formation/RTO - Malware Development/4 - Function Call Obfuscation.md","ref":"Formation/RTO - Malware Development/4 - Function Call Obfuscation.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-sharing","collapsible-chapters@git+https://gitlab.dqr/gitbook-plugin/collapsible-chapters.git#main","copy-code-button@git+https://gitlab.dqr/gitbook-plugin/copy-code-button.git#main","hide-published-with","search-plus","simple-page-toc"],"pluginsConfig":{"github":{"url":"https://github.com/YoannDqr"},"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"hide-published-with":{},"fontsettings":{"theme":"white","family":"sans","size":2},"twitter":{"url":"https://twitter.com/HackerOtter"},"highlight":{},"copy-code-button":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Formation/RTO - Malware Development/5 - Backdooring PE.md","mtime":"2022-09-10T18:42:33.554Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-10-08T22:01:09.081Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

