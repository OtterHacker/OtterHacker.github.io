
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Database Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Kubernetes.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <a target="_blank" href="https://twitter.com/HackerOtter">
            
                    
                    Follow On Twitter
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    Formation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" >
            
                <span>
            
                    
                    Malware Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1.1" data-path="../../Formation/RTO - Malware Development/0 - Introduction.html">
            
                <a href="../../Formation/RTO - Malware Development/0 - Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.2" data-path="../../Formation/RTO - Malware Development/1 - PE.html">
            
                <a href="../../Formation/RTO - Malware Development/1 - PE.html">
            
                    
                    PE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.3" data-path="../../Formation/RTO - Malware Development/2 - Payload Storage.html">
            
                <a href="../../Formation/RTO - Malware Development/2 - Payload Storage.html">
            
                    
                    Payload Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.4" data-path="../../Formation/RTO - Malware Development/3 - Payload Encryption.html">
            
                <a href="../../Formation/RTO - Malware Development/3 - Payload Encryption.html">
            
                    
                    Payload Encryption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.5" data-path="../../Formation/RTO - Malware Development/4 - Function Call Obfuscation.html">
            
                <a href="../../Formation/RTO - Malware Development/4 - Function Call Obfuscation.html">
            
                    
                    Function Call Obfuscation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.6" data-path="../../Formation/RTO - Malware Development/5 - Backdooring PE.html">
            
                <a href="../../Formation/RTO - Malware Development/5 - Backdooring PE.html">
            
                    
                    Backdooring PE
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Malware
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" >
            
                <span>
            
                    
                    Docs
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1.1" data-path="../../Malware/Docs/Code snippet.html">
            
                <a href="../../Malware/Docs/Code snippet.html">
            
                    
                    Code Snippet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.2" data-path="../../Malware/Docs/Dumpbin.html">
            
                <a href="../../Malware/Docs/Dumpbin.html">
            
                    
                    Dumpbin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.3" data-path="../../Malware/Docs/NTStructure.html">
            
                <a href="../../Malware/Docs/NTStructure.html">
            
                    
                    NTStructure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.4" data-path="../../Malware/Docs/Passing arguments.html">
            
                <a href="../../Malware/Docs/Passing arguments.html">
            
                    
                    Passing Arguments
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../Malware/CoffLoader.html">
            
                <a href="../../Malware/CoffLoader.html">
            
                    
                    COFF Loader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../Malware/Docs/Dumpbin.html">
            
                <a href="../../Malware/Docs/Dumpbin.html">
            
                    
                    Dumpbin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../../Malware/Elastic EDR.html">
            
                <a href="../../Malware/Elastic EDR.html">
            
                    
                    Elastic EDR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../../Malware/ETW.html">
            
                <a href="../../Malware/ETW.html">
            
                    
                    ETW
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../../Malware/Function hooking.html">
            
                <a href="../../Malware/Function hooking.html">
            
                    
                    Function Hooking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../../Malware/Kernel callback.html">
            
                <a href="../../Malware/Kernel callback.html">
            
                    
                    Kernel Callback
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../../Malware/Module stomping.html">
            
                <a href="../../Malware/Module stomping.html">
            
                    
                    Module Stomping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="../../Malware/Reflective DLL injection.html">
            
                <a href="../../Malware/Reflective DLL injection.html">
            
                    
                    Reflective DLL Injection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Pentest
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" >
            
                <span>
            
                    
                    Cloud
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.1" data-path="../Cloud/Azure.html">
            
                <a href="../Cloud/Azure.html">
            
                    
                    Azure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2" >
            
                <span>
            
                    
                    Configuration Review
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="4.1.2.1" data-path="Database.html">
            
                <a href="Database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.2" data-path="Kubernetes.html">
            
                <a href="Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3" data-path="KubernetesCIS.html">
            
                <a href="KubernetesCIS.html">
            
                    
                    KubernetesCIS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.3" >
            
                <span>
            
                    
                    Services
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.3.1" data-path="../Services/AD.html">
            
                <a href="../Services/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.2" data-path="../Services/DNS.html">
            
                <a href="../Services/DNS.html">
            
                    
                    DNS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.3" data-path="../Services/IPMI.html">
            
                <a href="../Services/IPMI.html">
            
                    
                    IPMI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.4" data-path="../Services/Kerberos.html">
            
                <a href="../Services/Kerberos.html">
            
                    
                    Kerberos
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.5" data-path="../Services/LDAP.html">
            
                <a href="../Services/LDAP.html">
            
                    
                    LDAP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.6" data-path="../Services/Memcached.html">
            
                <a href="../Services/Memcached.html">
            
                    
                    Memcached
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.7" data-path="../Services/NFS.html">
            
                <a href="../Services/NFS.html">
            
                    
                    NFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.8" data-path="../Services/Oracle database.html">
            
                <a href="../Services/Oracle database.html">
            
                    
                    Oracle Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.9" data-path="../Services/RPC.html">
            
                <a href="../Services/RPC.html">
            
                    
                    RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.10" data-path="../Services/SMB.html">
            
                <a href="../Services/SMB.html">
            
                    
                    SMB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.11" data-path="../Services/SNMP.html">
            
                <a href="../Services/SNMP.html">
            
                    
                    SNMP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.12" data-path="../Services/Tomcat.html">
            
                <a href="../Services/Tomcat.html">
            
                    
                    Tomcat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.13" data-path="../Services/WebDAV.html">
            
                <a href="../Services/WebDAV.html">
            
                    
                    WebDAV
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4" >
            
                <span>
            
                    
                    Techniques
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.1" data-path="../Techniques/Abuse tokens.html">
            
                <a href="../Techniques/Abuse tokens.html">
            
                    
                    Abuse Tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.2" data-path="../Techniques/Buffer overflow.html">
            
                <a href="../Techniques/Buffer overflow.html">
            
                    
                    Buffer Overflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.3" data-path="../Techniques/Command injection.html">
            
                <a href="../Techniques/Command injection.html">
            
                    
                    Command Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.4" data-path="../Techniques/Data exfiltration.html">
            
                <a href="../Techniques/Data exfiltration.html">
            
                    
                    Data Exfiltration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.5" data-path="../Techniques/Exploit handles.html">
            
                <a href="../Techniques/Exploit handles.html">
            
                    
                    Exploit handles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.6" data-path="../Techniques/Filtering.html">
            
                <a href="../Techniques/Filtering.html">
            
                    
                    Filtering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.7" data-path="../Techniques/Kioske escape.html">
            
                <a href="../Techniques/Kioske escape.html">
            
                    
                    Kioske Escape
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.8" data-path="../Techniques/LFI.html">
            
                <a href="../Techniques/LFI.html">
            
                    
                    LFI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.9" data-path="../Techniques/Password spraying.html">
            
                <a href="../Techniques/Password spraying.html">
            
                    
                    Password Spraying
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.10" data-path="../Techniques/Pivoting.html">
            
                <a href="../Techniques/Pivoting.html">
            
                    
                    Pivoting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.11" >
            
                <span>
            
                    
                    Privilege Escalation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.11.1" data-path="../Techniques/Privileges escalation/Windows.html">
            
                <a href="../Techniques/Privileges escalation/Windows.html">
            
                    
                    Windows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.11.2" data-path="../Techniques/Privileges escalation/Linux.html">
            
                <a href="../Techniques/Privileges escalation/Linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4.12" data-path="../Techniques/Reverse shell.html">
            
                <a href="../Techniques/Reverse shell.html">
            
                    
                    Reverse Shell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.13" data-path="../Techniques/Shellshock.html">
            
                <a href="../Techniques/Shellshock.html">
            
                    
                    Shellshock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.14" data-path="../Techniques/SQL injection.html">
            
                <a href="../Techniques/SQL injection.html">
            
                    
                    SQL Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.15" data-path="../Techniques/SSTI.html">
            
                <a href="../Techniques/SSTI.html">
            
                    
                    SSTI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.5" >
            
                <span>
            
                    
                    Technology
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.5.1" data-path="../Technology/AD.html">
            
                <a href="../Technology/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.2" data-path="../Technology/IOS.html">
            
                <a href="../Technology/IOS.html">
            
                    
                    IOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.3" data-path="../Technology/NAC.html">
            
                <a href="../Technology/NAC.html">
            
                    
                    NAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.4" data-path="../Technology/Port Knocking.html">
            
                <a href="../Technology/Port Knocking.html">
            
                    
                    Port Knocking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.5" data-path="../Technology/SAML.html">
            
                <a href="../Technology/SAML.html">
            
                    
                    SAML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.6" data-path="../Technology/SAP.html">
            
                <a href="../Technology/SAP.html">
            
                    
                    SAP
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.6" >
            
                <span>
            
                    
                    Tools
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.6.1" data-path="../Tools/BloundHound.html">
            
                <a href="../Tools/BloundHound.html">
            
                    
                    BloundHound
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.2" data-path="../Tools/CME.html">
            
                <a href="../Tools/CME.html">
            
                    
                    CME
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.3" data-path="../Tools/Curl.html">
            
                <a href="../Tools/Curl.html">
            
                    
                    Curl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.4" data-path="../Tools/Ffuf.html">
            
                <a href="../Tools/Ffuf.html">
            
                    
                    FFUF
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.5" data-path="../Tools/Find.html">
            
                <a href="../Tools/Find.html">
            
                    
                    Find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.6" data-path="../Tools/Hydra.html">
            
                <a href="../Tools/Hydra.html">
            
                    
                    Hydra
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.7" data-path="../Tools/PowerView.html">
            
                <a href="../Tools/PowerView.html">
            
                    
                    PowerView
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.8" data-path="../Tools/Powershell.html">
            
                <a href="../Tools/Powershell.html">
            
                    
                    Powershell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.9" data-path="../Tools/Responder.html">
            
                <a href="../Tools/Responder.html">
            
                    
                    Responder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.10" data-path="../Tools/Strace.html">
            
                <a href="../Tools/Strace.html">
            
                    
                    Strace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.11" data-path="../Tools/Wfuzz.html">
            
                <a href="../Tools/Wfuzz.html">
            
                    
                    Wfuzz
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" >
            
                <span>
            
                    
                    Rainy Sunday
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../../Serveur/KMS/KMS.html">
            
                <a href="../../Serveur/KMS/KMS.html">
            
                    
                    KMS Activation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../../Serveur/LicenceKey.html">
            
                <a href="../../Serveur/LicenceKey.html">
            
                    
                    Licence Key
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Database</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="database">Database</h1>
<h1 id="table-of-content">Table of content</h1>
<!-- toc -->
<ul>
<li><a href="#mssql">MSSQL</a><ul>
<li><a href="#mssql-azure-managed">MSSQL Azure managed</a></li>
<li><a href="#configuration-review">Configuration review</a><ul>
<li><a href="#retrieve-server-options">Retrieve server options</a></li>
<li><a href="#transparent-data-encryption">Transparent data encryption</a></li>
<li><a href="#encrypted-connections">Encrypted connections</a></li>
</ul>
</li>
<li><a href="#activate-options">Activate options</a><ul>
<li><a href="#xp_cmd_shell">xp_cmd_shell</a></li>
<li><a href="#sp_execute_external_script">sp_execute_external_script</a></li>
<li><a href="#ole-automation-procedures">Ole automation procedures</a></li>
</ul>
</li>
<li><a href="#run-external-script">Run external script</a></li>
<li><a href="#file-system">File system</a><ul>
<li><a href="#enumerate-the-files">Enumerate the files</a></li>
<li><a href="#read-file-content">Read file content</a></li>
</ul>
</li>
<li><a href="#retrieve-role-information">Retrieve role information</a></li>
<li><a href="#references">References</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1 id="mssql">MSSQL</h1>
<h2 id="mssql-azure-managed">MSSQL Azure managed</h2>
<p>There is a <code>database gateway</code> exposed on the common <code>MSSQL</code> port 1433, but when a connection is made, the connection is redirected to another server on port <code>1000X</code></p>
<h2 id="configuration-review">Configuration review</h2>
<h3 id="retrieve-server-options">Retrieve server options</h3>
<p>To retrieve server options, use the following <code>SQL</code>command</p>
<pre><code class="lang-SQL"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">sys</span>.configurations
</code></pre>
<p>It will display the status of options such as <code>xp_cmd_shell</code> or <code>sp_execute_external_script</code></p>
<h3 id="transparent-data-encryption">Transparent data encryption</h3>
<p>It is possible to set transparent data encryption. To verify if data encryption is used :</p>
<pre><code class="lang-SQL"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">sys</span>.dm_database_encryption_keys
</code></pre>
<p>To enable data encryption on a specific database:</p>
<pre><code class="lang-SQL"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">DATABASE</span> [database_name] <span class="hljs-keyword">SET</span> ENCRYPTION <span class="hljs-keyword">ON</span>;
</code></pre>
<h3 id="encrypted-connections">Encrypted connections</h3>
<p>Use the following <code>SQL</code> request to check the encryption status of the <code>SQL</code> connections</p>
<pre><code class="lang-SQL"><span class="hljs-keyword">SELECT</span> encrypt_option <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">sys</span>.dm_exec_connections
</code></pre>
<h2 id="activate-options">Activate options</h2>
<h3 id="xpcmdshell">xp_cmd_shell</h3>
<pre><code class="lang-SQL">EXEC sp_configure &apos;<span class="hljs-keyword">show</span> <span class="hljs-keyword">advanced</span> options<span class="hljs-string">&apos;, 1 ; 
GO  
RECONFIGURE;
GO    
EXEC sp_configure &apos;</span>xp_cmdshell<span class="hljs-string">&apos;, 1  
GO   
RECONFIGURE;
GO
</span></code></pre>
<h3 id="spexecuteexternalscript">sp_execute_external_script</h3>
<pre><code class="lang-SQL">EXEC sp_configure &apos;<span class="hljs-keyword">show</span> <span class="hljs-keyword">advanced</span> options<span class="hljs-string">&apos;, 1 ; 
GO  
RECONFIGURE;
EXECUTE sp_configure &apos;</span><span class="hljs-keyword">external</span> scripts enabled<span class="hljs-string">&apos;, 1;
GO
RECONFIGURE;
GO
</span></code></pre>
<h3 id="ole-automation-procedures">Ole automation procedures</h3>
<pre><code class="lang-SQL">sp_configure &apos;<span class="hljs-keyword">show</span> <span class="hljs-keyword">advanced</span> options<span class="hljs-string">&apos;, 1;
GO
RECONFIGURE;
GO
sp_configure &apos;</span>Ole Automation Procedures<span class="hljs-string">&apos;, 1;
GO
RECONFIGURE;
GO
</span></code></pre>
<h2 id="run-external-script">Run external script</h2>
<p>On <code>Azure MSSQL</code> it is possible to run external Python or R script with the following command :</p>
<pre><code class="lang-SQL">EXEC sp_execute_external_script @language = N&apos;R&apos;,
@script = N&apos;data.frame(print(system(&quot;cmd.exe /C whoami&quot;, intern=T)))&apos;
</code></pre>
<p>Or, with a python script :</p>
<pre><code class="lang-SQL"><span class="hljs-keyword">EXECUTE</span> sp_configure <span class="hljs-string">&apos;external scripts enabled&apos;</span>, <span class="hljs-number">1</span>;
GO
RECONFIGURE;
GO
EXEC sp_execute_external_script @language = N&apos;Python&apos; , @script = N&apos;import subprocess;
cmd = [&quot;whoami&quot;,&quot;ipconfig&quot;];
a = &quot;&quot;;
for c in cmd:
    a += subprocess.check_output(c.split(&quot; &quot;), shell=True).decode()+&quot;\r\n&quot;;
a = [elt for elt in a.split(&quot;\r\n&quot;) if a.strip() != &quot;&quot;];
a = &quot;\n&quot;.join(a);
print(a);
&apos;
GO
</code></pre>
<h2 id="file-system">File system</h2>
<h3 id="enumerate-the-files">Enumerate the files</h3>
<pre><code class="lang-SQL"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">sys</span>.dm_os_enumerate_filesystem(<span class="hljs-string">&apos;C:\&apos;, &apos;</span>*<span class="hljs-string">&apos;);
</span></code></pre>
<h3 id="read-file-content">Read file content</h3>
<pre><code class="lang-SQL"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> OPENROWSET(<span class="hljs-keyword">BULK</span> N<span class="hljs-string">&apos;C:\Windows\win.ini&apos;</span>, SINGLE_CLOB) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">Contents</span>
</code></pre>
<h2 id="retrieve-role-information">Retrieve role information</h2>
<p>Security Audit Report</p>
<ol>
<li>List all access provisioned to a SQL user or Windows user/group directly</li>
<li>List all access provisioned to a SQL user or Windows user/group through a database or application role</li>
<li>List all access provisioned to the public role</li>
</ol>
<p>Columns Returned:</p>
<ul>
<li><code>UserType</code>: Value will be either <code>SQL User</code>, <code>Windows User</code>, or <code>Windows Group</code>.
This reflects the type of user/group defined for the SQL Server account.</li>
<li><code>DatabaseUserName</code>: Name of the associated user as defined in the database user account. The database user may not be the same as the server user.</li>
<li><code>LoginName</code>: SQL or Windows/Active Directory user account.  This could also be an Active Directory group.</li>
<li><code>Role</code>: The role name. This will be null if the associated permissions to the object are defined at directly on the user account, otherwise this will be the name of the role that the user is a member of.</li>
<li><code>PermissionType</code>: Type of permissions the user/role has on an object. Examples could include <code>CONNECT</code>, <code>EXECUTE</code>, <code>SELECT</code>, <code>DELETE</code>, <code>INSERT</code>, <code>ALTER</code>, <code>CONTROL</code>, <code>TAKE OWNERSHIP</code>, <code>VIEW</code>,<code>DEFINITION</code>, etc. This value may not be populated for all roles.  Some built in roles have implicit permission definitions.</li>
<li><code>PermissionState</code> : Reflects the state of the permission type, examples could include <code>GRANT</code>, <code>DENY</code>, etc. This value may not be populated for all roles.  Some built in roles have implicit permission definitions.</li>
<li><code>ObjectType</code> : Type of object the user/role is assigned permissions on.  Examples could include <code>USER_TABLE</code>, <code>SQL_SCALAR_FUNCTION</code>, <code>SQL_INLINE_TABLE_VALUED_FUNCTION</code>, <code>SQL_STORED_PROCEDURE</code>, <code>VIEW</code>, etc. This value may not be populated for all roles.  Some built in roles have implicit permission definitions.</li>
<li><code>Schema</code> : Name of the schema the object is in.</li>
<li><code>ObjectName</code> : Name of the object that the user/role is assigned permissions on. This value may not be populated for all roles.  Some built in roles have implicit permission definitions.</li>
<li><code>ColumnName</code>: Name of the column of the object that the user/role is assigned permissions on. This value is only populated if the object is a table, view or a table value function.
```SQL
--1) List all access provisioned to a SQL user or Windows user/group directly
SELECT
  [UserType] = CASE princ.[type]<pre><code>                  WHEN &apos;S&apos; THEN &apos;SQL User&apos;
                  WHEN &apos;U&apos; THEN &apos;Windows User&apos;
                  WHEN &apos;G&apos; THEN &apos;Windows Group&apos;
              END,
</code></pre>  [DatabaseUserName] = princ.[name],
  [LoginName]        = ulogin.[name],
  [Role]             = NULL,
  [PermissionType]   = perm.[permission_name],
  [PermissionState]  = perm.[state_desc],
  [ObjectType] = CASE perm.[class]<pre><code>                  WHEN 1 THEN obj.[type_desc]        -- Schema-contained objects
                  ELSE perm.[class_desc]             -- Higher-level objects
              END,
</code></pre>  [Schema] = objschem.[name],
  [ObjectName] = CASE perm.[class]<pre><code>                  WHEN 3 THEN permschem.[name]       -- Schemas
                  WHEN 4 THEN imp.[name]             -- Impersonations
                  ELSE OBJECT_NAME(perm.[major_id])  -- General objects
              END,
</code></pre>  [ColumnName] = col.[name]
FROM
  --Database user
  sys.database_principals            AS princ
  --Login accounts
  LEFT JOIN sys.server_principals    AS ulogin    ON ulogin.[sid] = princ.[sid]
  --Permissions
  LEFT JOIN sys.database_permissions AS perm      ON perm.[grantee_principal_id] = princ.[principal_id]
  LEFT JOIN sys.schemas              AS permschem ON permschem.[schema_id] = perm.[major_id]
  LEFT JOIN sys.objects              AS obj       ON obj.[object_id] = perm.[major_id]
  LEFT JOIN sys.schemas              AS objschem  ON objschem.[schema_id] = obj.[schema_id]
  --Table columns
  LEFT JOIN sys.columns              AS col       ON col.[object_id] = perm.[major_id]<pre><code>                                                  AND col.[column_id] = perm.[minor_id]
</code></pre>  --Impersonations
  LEFT JOIN sys.database_principals  AS imp       ON imp.[principal_id] = perm.[major_id]
WHERE
  princ.[type] IN (&apos;S&apos;,&apos;U&apos;,&apos;G&apos;)
  -- No need for these system accounts
  AND princ.[name] NOT IN (&apos;sys&apos;, &apos;INFORMATION_SCHEMA&apos;)</li>
</ul>
<p>UNION</p>
<p>--2) List all access provisioned to a SQL user or Windows user/group through a database or application role
SELECT
    [UserType] = CASE membprinc.[type]
                        WHEN &apos;S&apos; THEN &apos;SQL User&apos;
                        WHEN &apos;U&apos; THEN &apos;Windows User&apos;
                        WHEN &apos;G&apos; THEN &apos;Windows Group&apos;
                    END,
    [DatabaseUserName] = membprinc.[name],
    [LoginName]        = ulogin.[name],
    [Role]             = roleprinc.[name],
    [PermissionType]   = perm.[permission_name],
    [PermissionState]  = perm.[state_desc],
    [ObjectType] = CASE perm.[class]
                        WHEN 1 THEN obj.[type_desc]        -- Schema-contained objects
                        ELSE perm.[class_desc]             -- Higher-level objects
                    END,
    [Schema] = objschem.[name],
    [ObjectName] = CASE perm.[class]
                        WHEN 3 THEN permschem.[name]       -- Schemas
                        WHEN 4 THEN imp.[name]             -- Impersonations
                        ELSE OBJECT_NAME(perm.[major_id])  -- General objects
                    END,
    [ColumnName] = col.[name]
FROM
    --Role/member associations
    sys.database_role_members          AS members
    --Roles
    JOIN      sys.database_principals  AS roleprinc ON roleprinc.[principal_id] = members.[role_principal_id]
    --Role members (database users)
    JOIN      sys.database_principals  AS membprinc ON membprinc.[principal_id] = members.[member_principal_id]
    --Login accounts
    LEFT JOIN sys.server_principals    AS ulogin    ON ulogin.[sid] = membprinc.[sid]
    --Permissions
    LEFT JOIN sys.database_permissions AS perm      ON perm.[grantee_principal_id] = roleprinc.[principal_id]
    LEFT JOIN sys.schemas              AS permschem ON permschem.[schema_id] = perm.[major_id]
    LEFT JOIN sys.objects              AS obj       ON obj.[object_id] = perm.[major_id]
    LEFT JOIN sys.schemas              AS objschem  ON objschem.[schema_id] = obj.[schema_id]
    --Table columns
    LEFT JOIN sys.columns              AS col       ON col.[object_id] = perm.[major_id]
                                                        AND col.[column_id] = perm.[minor_id]
    --Impersonations
    LEFT JOIN sys.database_principals  AS imp       ON imp.[principal_id] = perm.[major_id]
WHERE
    membprinc.[type] IN (&apos;S&apos;,&apos;U&apos;,&apos;G&apos;)
    -- No need for these system accounts
    AND membprinc.[name] NOT IN (&apos;sys&apos;, &apos;INFORMATION_SCHEMA&apos;)</p>
<p>UNION</p>
<p>--3) List all access provisioned to the public role, which everyone gets by default
SELECT
    [UserType]         = &apos;{All Users}&apos;,
    [DatabaseUserName] = &apos;{All Users}&apos;,
    [LoginName]        = &apos;{All Users}&apos;,
    [Role]             = roleprinc.[name],
    [PermissionType]   = perm.[permission_name],
    [PermissionState]  = perm.[state_desc],
    [ObjectType] = CASE perm.[class]
                        WHEN 1 THEN obj.[type_desc]        -- Schema-contained objects
                        ELSE perm.[class_desc]             -- Higher-level objects
                    END,
    [Schema] = objschem.[name],
    [ObjectName] = CASE perm.[class]
                        WHEN 3 THEN permschem.[name]       -- Schemas
                        WHEN 4 THEN imp.[name]             -- Impersonations
                        ELSE OBJECT_NAME(perm.[major_id])  -- General objects
                    END,
    [ColumnName] = col.[name]
FROM
    --Roles
    sys.database_principals            AS roleprinc
    --Role permissions
    LEFT JOIN sys.database_permissions AS perm      ON perm.[grantee_principal_id] = roleprinc.[principal_id]
    LEFT JOIN sys.schemas              AS permschem ON permschem.[schema_id] = perm.[major_id]
    --All objects
    JOIN      sys.objects              AS obj       ON obj.[object_id] = perm.[major_id]
    LEFT JOIN sys.schemas              AS objschem  ON objschem.[schema_id] = obj.[schema_id]
    --Table columns
    LEFT JOIN sys.columns              AS col       ON col.[object_id] = perm.[major_id]
                                                        AND col.[column_id] = perm.[minor_id]
    --Impersonations
    LEFT JOIN sys.database_principals  AS imp       ON imp.[principal_id] = perm.[major_id]
WHERE
    roleprinc.[type] = &apos;R&apos;
    AND roleprinc.[name] = &apos;public&apos;
    AND obj.[is_ms_shipped] = 0</p>
<p>ORDER BY
    [UserType],
    [DatabaseUserName],
    [LoginName],
    [Role],
    [Schema],
    [ObjectName],
    [ColumnName],
    [PermissionType],
    [PermissionState],
    [ObjectType]
```</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://blog.dbdigger.com/enable-and-work-with-xp_cmdshell-in-sql-server-2008-r2/" target="_blank">https://blog.dbdigger.com/enable-and-work-with-xp_cmdshell-in-sql-server-2008-r2/</a></li>
<li><a href="https://stackoverflow.com/questions/7048839/sql-server-query-to-find-all-permissions-access-for-all-users-in-a-database" target="_blank">https://stackoverflow.com/questions/7048839/sql-server-query-to-find-all-permissions-access-for-all-users-in-a-database</a></li>
<li><a href="https://labs.f-secure.com/assets/BlogFiles/mwri-a-penetration-testers-guide-to-the-azure-cloud-v1.2.pdf" target="_blank">https://labs.f-secure.com/assets/BlogFiles/mwri-a-penetration-testers-guide-to-the-azure-cloud-v1.2.pdf</a></li>
<li><a href="https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-credential-passwords/" target="_blank">https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-credential-passwords/</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="Kubernetes.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Kubernetes">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Database","level":"4.1.2.1","depth":3,"next":{"title":"Kubernetes","level":"4.1.2.2","depth":3,"path":"Pentest/Configuration review/Kubernetes.md","ref":"Pentest/Configuration review/Kubernetes.md","articles":[]},"previous":{"title":"Configuration Review","level":"4.1.2","depth":2,"ref":"","articles":[{"title":"Database","level":"4.1.2.1","depth":3,"path":"Pentest/Configuration review/Database.md","ref":"Pentest/Configuration review/Database.md","articles":[]},{"title":"Kubernetes","level":"4.1.2.2","depth":3,"path":"Pentest/Configuration review/Kubernetes.md","ref":"Pentest/Configuration review/Kubernetes.md","articles":[]},{"title":"KubernetesCIS","level":"4.1.2.3","depth":3,"path":"Pentest/Configuration review/KubernetesCIS.md","ref":"Pentest/Configuration review/KubernetesCIS.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-sharing","collapsible-chapters@git+https://gitlab.dqr/gitbook-plugin/collapsible-chapters.git#main","copy-code-button@git+https://gitlab.dqr/gitbook-plugin/copy-code-button.git#main","hide-published-with","search-plus","simple-page-toc"],"pluginsConfig":{"github":{"url":"https://github.com/YoannDqr"},"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"hide-published-with":{},"fontsettings":{"theme":"white","family":"sans","size":2},"twitter":{"url":"https://twitter.com/HackerOtter"},"highlight":{},"copy-code-button":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Pentest/Configuration review/Database.md","mtime":"2022-07-09T22:01:01.473Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-09-10T18:47:07.570Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

