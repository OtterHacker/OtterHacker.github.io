
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Reflective DLL Injection Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="Remote DLL Injection.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <a target="_blank" href="https://twitter.com/OtterHacker">
            
                    
                    Follow On Twitter
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Articles/Articles.html">
            
                <a href="../Articles/Articles.html">
            
                    
                    Articles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Malware
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" >
            
                <span>
            
                    
                    Docs
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="Docs/Code snippet.html">
            
                <a href="Docs/Code snippet.html">
            
                    
                    Code Snippet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="Docs/Dumpbin.html">
            
                <a href="Docs/Dumpbin.html">
            
                    
                    Dumpbin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.3" data-path="Docs/NTStructure.html">
            
                <a href="Docs/NTStructure.html">
            
                    
                    NTStructure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.4" data-path="Docs/Passing arguments.html">
            
                <a href="Docs/Passing arguments.html">
            
                    
                    Passing Arguments
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" >
            
                <span>
            
                    
                    Basics
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="Introduction/0 - Introduction.html">
            
                <a href="Introduction/0 - Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="Introduction/1 - PE.html">
            
                <a href="Introduction/1 - PE.html">
            
                    
                    PE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.3" data-path="Introduction/2 - Payload Storage.html">
            
                <a href="Introduction/2 - Payload Storage.html">
            
                    
                    Payload Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.4" data-path="Introduction/3 - Payload Encryption.html">
            
                <a href="Introduction/3 - Payload Encryption.html">
            
                    
                    Payload Encryption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.5" data-path="Introduction/4 - Function Call Obfuscation.html">
            
                <a href="Introduction/4 - Function Call Obfuscation.html">
            
                    
                    Function Call Obfuscation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.6" data-path="../Formation/RTO - Malware Development/5 - Backdooring PE.md">
            
                <span>
            
                    
                    Backdooring PE
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="CoffLoader.html">
            
                <a href="CoffLoader.html">
            
                    
                    COFF Loader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="Elastic EDR.html">
            
                <a href="Elastic EDR.html">
            
                    
                    Elastic EDR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="ETW.html">
            
                <a href="ETW.html">
            
                    
                    ETW
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="Function hooking.html">
            
                <a href="Function hooking.html">
            
                    
                    Function Hooking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="Kernel callback.html">
            
                <a href="Kernel callback.html">
            
                    
                    Kernel Callback
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="Module stomping.html">
            
                <a href="Module stomping.html">
            
                    
                    Module Stomping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="Remote DLL Injection.html">
            
                <a href="Remote DLL Injection.html">
            
                    
                    Remote DLL Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.10" data-path="Reflective DLL injection.html">
            
                <a href="Reflective DLL injection.html">
            
                    
                    Reflective DLL Injection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Pentest
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" >
            
                <span>
            
                    
                    Cloud
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="../Pentest/Cloud/Azure.html">
            
                <a href="../Pentest/Cloud/Azure.html">
            
                    
                    Azure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" >
            
                <span>
            
                    
                    Configuration Review
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.2.1" data-path="../Pentest/Configuration review/Database.html">
            
                <a href="../Pentest/Configuration review/Database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.2" data-path="../Pentest/Configuration review/Kubernetes.html">
            
                <a href="../Pentest/Configuration review/Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2.3" data-path="../Pentest/Configuration review/KubernetesCIS.html">
            
                <a href="../Pentest/Configuration review/KubernetesCIS.html">
            
                    
                    KubernetesCIS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3" >
            
                <span>
            
                    
                    Services
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.3.1" data-path="../Pentest/Services/AD.html">
            
                <a href="../Pentest/Services/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.2" >
            
                <span>
            
                    
                    Databases
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.3.2.1" data-path="../Pentest/Services/Oracle database.html">
            
                <a href="../Pentest/Services/Oracle database.html">
            
                    
                    Oracle Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.2.2" data-path="../Pentest/Services/MSSQL.html">
            
                <a href="../Pentest/Services/MSSQL.html">
            
                    
                    MSSQL
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.3.3" data-path="../Pentest/Services/DNS.html">
            
                <a href="../Pentest/Services/DNS.html">
            
                    
                    DNS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.4" data-path="../Pentest/Services/IPMI.html">
            
                <a href="../Pentest/Services/IPMI.html">
            
                    
                    IPMI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.5" data-path="../Pentest/Services/Kerberos.html">
            
                <a href="../Pentest/Services/Kerberos.html">
            
                    
                    Kerberos
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.6" data-path="../Pentest/Services/LDAP.html">
            
                <a href="../Pentest/Services/LDAP.html">
            
                    
                    LDAP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.7" data-path="../Pentest/Services/Memcached.html">
            
                <a href="../Pentest/Services/Memcached.html">
            
                    
                    Memcached
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.8" data-path="../Pentest/Services/NFS.html">
            
                <a href="../Pentest/Services/NFS.html">
            
                    
                    NFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.9" data-path="../Pentest/Services/RPC.html">
            
                <a href="../Pentest/Services/RPC.html">
            
                    
                    RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.10" data-path="../Pentest/Services/SMB.html">
            
                <a href="../Pentest/Services/SMB.html">
            
                    
                    SMB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.11" data-path="../Pentest/Services/SNMP.html">
            
                <a href="../Pentest/Services/SNMP.html">
            
                    
                    SNMP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.12" data-path="../Pentest/Services/Tomcat.html">
            
                <a href="../Pentest/Services/Tomcat.html">
            
                    
                    Tomcat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3.13" data-path="../Pentest/Services/WebDAV.html">
            
                <a href="../Pentest/Services/WebDAV.html">
            
                    
                    WebDAV
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.4" >
            
                <span>
            
                    
                    Techniques
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.4.1" data-path="../Pentest/Techniques/ADCS abuses.html">
            
                <a href="../Pentest/Techniques/ADCS abuses.html">
            
                    
                    Abuse ADCS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.2" data-path="../Pentest/Techniques/Abuse tokens.html">
            
                <a href="../Pentest/Techniques/Abuse tokens.html">
            
                    
                    Abuse Tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.3" data-path="../Pentest/Techniques/Trusts abuses.html">
            
                <a href="../Pentest/Techniques/Trusts abuses.html">
            
                    
                    Abuse Trusts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.4" data-path="../Pentest/Techniques/Buffer overflow.html">
            
                <a href="../Pentest/Techniques/Buffer overflow.html">
            
                    
                    Buffer Overflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.5" data-path="../Pentest/Techniques/Command injection.html">
            
                <a href="../Pentest/Techniques/Command injection.html">
            
                    
                    Command Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.6" data-path="../Pentest/Techniques/Data exfiltration.html">
            
                <a href="../Pentest/Techniques/Data exfiltration.html">
            
                    
                    Data Exfiltration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.7" data-path="../Pentest/Techniques/Exploit handles.html">
            
                <a href="../Pentest/Techniques/Exploit handles.html">
            
                    
                    Exploit handles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.8" data-path="../Pentest/Techniques/Filtering.html">
            
                <a href="../Pentest/Techniques/Filtering.html">
            
                    
                    Filtering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.9" data-path="../Pentest/Techniques/Kioske escape.html">
            
                <a href="../Pentest/Techniques/Kioske escape.html">
            
                    
                    Kioske Escape
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.10" data-path="../Pentest/Techniques/LFI.html">
            
                <a href="../Pentest/Techniques/LFI.html">
            
                    
                    LFI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.11" data-path="../Pentest/Techniques/Password spraying.html">
            
                <a href="../Pentest/Techniques/Password spraying.html">
            
                    
                    Password Spraying
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.12" data-path="../Pentest/Techniques/Pivoting.html">
            
                <a href="../Pentest/Techniques/Pivoting.html">
            
                    
                    Pivoting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.13" >
            
                <span>
            
                    
                    Privilege Escalation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.4.13.1" data-path="../Pentest/Techniques/Privileges escalation/Windows.html">
            
                <a href="../Pentest/Techniques/Privileges escalation/Windows.html">
            
                    
                    Windows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.13.2" data-path="../Pentest/Techniques/Privileges escalation/Linux.html">
            
                <a href="../Pentest/Techniques/Privileges escalation/Linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.4.14" data-path="../Pentest/Techniques/Reverse shell.html">
            
                <a href="../Pentest/Techniques/Reverse shell.html">
            
                    
                    Reverse Shell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.15" data-path="../Pentest/Techniques/Shellshock.html">
            
                <a href="../Pentest/Techniques/Shellshock.html">
            
                    
                    Shellshock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.16" data-path="../Pentest/Techniques/SQL injection.html">
            
                <a href="../Pentest/Techniques/SQL injection.html">
            
                    
                    SQL Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4.17" data-path="../Pentest/Techniques/SSTI.html">
            
                <a href="../Pentest/Techniques/SSTI.html">
            
                    
                    SSTI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.5" >
            
                <span>
            
                    
                    Technology
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.5.1" data-path="../Pentest/Technology/AD.html">
            
                <a href="../Pentest/Technology/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.2" data-path="../Pentest/Technology/IOS.html">
            
                <a href="../Pentest/Technology/IOS.html">
            
                    
                    IOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.3" data-path="../Pentest/Technology/NAC.html">
            
                <a href="../Pentest/Technology/NAC.html">
            
                    
                    NAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.4" data-path="../Pentest/Technology/Port Knocking.html">
            
                <a href="../Pentest/Technology/Port Knocking.html">
            
                    
                    Port Knocking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.5" data-path="../Pentest/Technology/SAML.html">
            
                <a href="../Pentest/Technology/SAML.html">
            
                    
                    SAML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5.6" data-path="../Pentest/Technology/SAP.html">
            
                <a href="../Pentest/Technology/SAP.html">
            
                    
                    SAP
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.6" >
            
                <span>
            
                    
                    Tools
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.6.1" data-path="../Pentest/Tools/BloundHound.html">
            
                <a href="../Pentest/Tools/BloundHound.html">
            
                    
                    BloundHound
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.2" data-path="../Pentest/Tools/CME.html">
            
                <a href="../Pentest/Tools/CME.html">
            
                    
                    CME
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.3" data-path="../Pentest/Tools/Curl.html">
            
                <a href="../Pentest/Tools/Curl.html">
            
                    
                    Curl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.4" data-path="../Pentest/Tools/Ffuf.html">
            
                <a href="../Pentest/Tools/Ffuf.html">
            
                    
                    FFUF
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.5" data-path="../Pentest/Tools/Find.html">
            
                <a href="../Pentest/Tools/Find.html">
            
                    
                    Find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.6" data-path="../Pentest/Tools/Hydra.html">
            
                <a href="../Pentest/Tools/Hydra.html">
            
                    
                    Hydra
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.7" data-path="../Pentest/Tools/PowerView.html">
            
                <a href="../Pentest/Tools/PowerView.html">
            
                    
                    PowerView
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.8" data-path="../Pentest/Tools/Powershell.html">
            
                <a href="../Pentest/Tools/Powershell.html">
            
                    
                    Powershell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.9" data-path="../Pentest/Tools/Responder.html">
            
                <a href="../Pentest/Tools/Responder.html">
            
                    
                    Responder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.10" data-path="../Pentest/Tools/Rubeus.html">
            
                <a href="../Pentest/Tools/Rubeus.html">
            
                    
                    Rubeus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.11" data-path="../Pentest/Tools/Strace.html">
            
                <a href="../Pentest/Tools/Strace.html">
            
                    
                    Strace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6.12" data-path="../Pentest/Tools/Wfuzz.html">
            
                <a href="../Pentest/Tools/Wfuzz.html">
            
                    
                    Wfuzz
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Rainy Sunday
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Serveur/KMS/KMS.html">
            
                <a href="../Serveur/KMS/KMS.html">
            
                    
                    KMS Activation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../Serveur/LicenceKey.html">
            
                <a href="../Serveur/LicenceKey.html">
            
                    
                    Licence Key
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Reflective DLL Injection</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="reflective-dll-injection">Reflective DLL Injection</h1>
<h1 id="table-of-content">Table of content</h1>
<!-- toc -->
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#blueprint">Blueprint</a></li>
<li><a href="#store-the-dll-content-in-memory">Store the DLL content in memory</a></li>
<li><a href="#inject-the-dll">Inject the DLL</a></li>
<li><a href="#perform-image-base-relocations">Perform image base relocations</a><ul>
<li><a href="#symbol-table">Symbol Table</a></li>
<li><a href="#perform-relocation">Perform relocation</a></li>
</ul>
</li>
<li><a href="#process-imported-functions">Process imported functions</a><ul>
<li><a href="#import-directory-table">Import Directory Table</a></li>
<li><a href="#iat-and-ilt">IAT and ILT</a></li>
<li><a href="#fill-the-iat">Fill the IAT</a></li>
<li><a href="#delayed-import-table">Delayed Import Table</a></li>
</ul>
</li>
<li><a href="#tls-callback-et-dll-main">TLS Callback et DLL Main</a><ul>
<li><a href="#tls-callback">TLS Callback</a></li>
<li><a href="#dll-main">DLL Main</a></li>
</ul>
</li>
<li><a href="#getprocaddress">GetProcAddress</a></li>
</ul>
<!-- tocstop -->
<h1 id="overview">Overview</h1>
<p>The <code>Reflective DLL Injection</code> is a process injection technique that allows an attacker to inject <code>DLL</code> stored in memory rather than from the disk.</p>
<p>Indeed, any <code>DLL</code> stored on disk can be easily loaded using the <code>LoadLibrary</code> <code>Windows API</code>. However, this <code>API</code> does not work when the <code>DLL</code> content is stored in memory.</p>
<p>Moreover, the <code>LoadLibrary</code> <code>API</code> raises some kernel events as it is shown in the following figure:</p>
<p><img src="img/ReflectiveDLL/loadlibrarySysmon.jpg" alt="LoadLibrary Sysmon"></p>
<p>Using a <code>Reflective DLL Injection</code> is a way to reimplement a custom <code>LoadLibrary</code> function that will not raise any kernel events hence limiting detection from the <code>Blue Team</code>.</p>
<h1 id="blueprint">Blueprint</h1>
<p>The <code>Reflective DLL Injection</code> can be done through the following steps:</p>
<ol>
<li>Store the <code>DLL</code> content in memory</li>
<li>Parse the <code>DLL</code> header to retrieve the <code>SizeOfImage</code> value</li>
<li>Allocate a memory space whose size is equal to the <code>DLL SizeOfImage</code></li>
<li>Copy each header and section in the allocated memory space</li>
<li>Perform image base relocations if needed</li>
<li>Load dependencies <code>DLL</code> <em>ie <code>DLL</code> used by the loaded <code>DLL</code></em></li>
<li>Resolve imported functions and populate the <code>Import Address Table (IAT)</code></li>
<li>Protect memory sections according to <code>DLL</code>&apos;s sections needs</li>
<li>Run the <code>DLL TLS callbacks</code></li>
<li>Run the <code>DLL</code> main function</li>
<li>Enjoy !</li>
</ol>
<h1 id="store-the-dll-content-in-memory">Store the DLL content in memory</h1>
<p>This step is quite simple. The goal is to get a buffer with the whole <code>DLL</code> file&apos;s content in it. The following code can be used to load a full file in memory:</p>
<pre><code class="lang-c"><span class="hljs-function">BOOL <span class="hljs-title">FileExistsW</span><span class="hljs-params">(LPCWSTR szPath)</span></span>{
    DWORD dwAttrib = GetFileAttributesW(szPath);
    <span class="hljs-keyword">return</span> (dwAttrib != INVALID_FILE_ATTRIBUTES &amp;&amp; !(dwAttrib &amp; FILE_ATTRIBUTE_DIRECTORY));
}

<span class="hljs-function">PBYTE <span class="hljs-title">ReadFileW</span><span class="hljs-params">(LPCWSTR filename, PDWORD fileSize)</span> </span>{

    <span class="hljs-comment">// Open the file with read permissions</span>
    HANDLE hFile = CreateFileW(filename, GENERIC_READ, FILE_SHARE_READ, <span class="hljs-literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (hFile == INVALID_HANDLE_VALUE) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    }

    <span class="hljs-comment">// Retrieve the file size</span>
    *fileSize = GetFileSize(hFile, <span class="hljs-literal">NULL</span>);
    DWORD sizeRead = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// Allocate size in heap to contains the file content</span>
    PBYTE content = (PBYTE)<span class="hljs-built_in">malloc</span>(*fileSize);

    <span class="hljs-comment">// Populate the allocated buffer with the file content</span>
    DWORD result = ReadFile(hFile, content, *fileSize, &amp;sizeRead, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (!result || sizeRead != *fileSize) {
        DEBUG(<span class="hljs-string">&quot;[x] Error during %ls file read\n&quot;</span>, filename);
        <span class="hljs-built_in">free</span>(content);
        content = <span class="hljs-literal">NULL</span>;
    }
    CloseHandle(hFile);

    <span class="hljs-comment">// Return the buffer</span>
    <span class="hljs-keyword">return</span> content;
}
</code></pre>
<p>So now the whole <code>DLL</code> content is stored in memory and is ready to be injected.</p>
<h1 id="inject-the-dll">Inject the DLL</h1>
<p>To inject whatever in memory you need to know the global size of the thing you want to inject. For <code>PE</code> files, such as <code>DLL</code>, the full file size can be found in the nt headers.</p>
<p>The post goal is not to create a <code>PE</code> parser so each fields of the <code>PE</code> will not be explicitly documented in this post.</p>
<p>The full <code>DLL</code> size can be found with the following code that retrieves the <code>OptionalHeader.SizeOfImage</code>:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// dllContent is the first byte of the DLL stored in memory</span>
<span class="hljs-function">DWORD <span class="hljs-title">getImageSize</span><span class="hljs-params">(PVOID dllContent)</span></span>{
    IMAGE_NT_HEADERS* ntHeaders = (IMAGE_NT_HEADERS*)((PBYTE)dllContent + pe-&gt;dosHeader-&gt;e_lfanew);
    <span class="hljs-keyword">return</span> ntHeaders-&gt;OptionalHeader.SizeOfImage
}
</code></pre>
<p>Then, once the full size is known, a memory page is allocated using <code>VirtualAlloc</code>:</p>
<pre><code class="lang-cpp">PVOID startAddress = VirtualAlloc(
    <span class="hljs-literal">NULL</span>, 
    dllParsed-&gt;ntHeader-&gt;OptionalHeader.SizeOfImage, 
    MEM_COMMIT | MEM_RESERVE, 
    PAGE_READWRITE
);
</code></pre>
<p>So now, the allocated page must be populated with the <code>DLL</code>&apos;s headers and sections:</p>
<pre><code class="lang-cpp">IMAGE_NT_HEADERS* ntHeader = (IMAGE_NT_HEADERS*)((PBYTE)dllContent + pe-&gt;dosHeader-&gt;e_lfanew);

<span class="hljs-comment">// Copy the headers</span>
CopyMemory(startAddress, dllContent, ntHeader-&gt;OptionalHeader.SizeOfHeaders);

<span class="hljs-comment">// Copy the sections</span>
PIMAGE_SECTION_HEADER sectionHeader = IMAGE_FIRST_SECTION(dllParsed-&gt;ntHeader);
<span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; ntHeader-&gt;FileHeader.NumberOfSections; i++, sectionHeader++) {
    CopyMemory(
        (PBYTE)startAddress + sectionHeader-&gt;VirtualAddress, 
        (PBYTE)dllContent + sectionHeader-&gt;PointerToRawData, 
        sectionHeader-&gt;SizeOfRawData
    );
}
</code></pre>
<p>At the end of these steps, the whole <code>DLL</code> is loaded in memory at the address <code>startAddress</code>. </p>
<p>In a better world, this could be the end and the <code>DLL</code> entry point could be run straight away. However, there is a high probability that your <code>DLL</code> has not been loaded to its preferred base address.</p>
<p>Thus, several relocations must be done before being able to run you <code>DLL</code>. </p>
<h1 id="perform-image-base-relocations">Perform image base relocations</h1>
<p>When a <code>PE</code> is compiled, the symbols are referenced as if the <code>PE</code> is loaded at a given base address. This address is the <code>PE</code> preferred loading address or the <code>ImageBase</code> address.</p>
<p>If the <code>PE</code> is not loaded to its preferred <code>ImageBase</code> address, the load address shift breaks all absolute references among the <code>PE</code>.</p>
<p>For example, if the <code>PE</code> has been compiled to reference the data <code>A</code> from the address <code>0x40000</code>, this reference only works if the <code>PE</code> is loaded to the same base address as the one used during compilation. If the <code>PE</code> is loaded to another base address, the reference <code>0x40000</code> will not point to the <code>A</code> data anymore but to an arbitrary data in the process memory space. The <code>A</code> data will be stored at <code>0x4000 + offset</code> where the offset is the difference between the current loading address and the preferred <code>ImageBase</code> address.</p>
<p>The <code>.reloc</code> section contains all the hardcoded absolute references that need fixing if the <code>PE</code> is not loaded at its preferred base address.</p>
<p>In a nutshell, symbols referenced by their absolute address are not hardcoded into the <code>.text</code> section. Their references in the <code>.text</code> section point to the <code>.reloc</code> section. The <code>.reloc</code> section is used as a lookup table between the symbol reference in <code>.text</code> and its absolute definition address.</p>
<h2 id="symbol-table">Symbol Table</h2>
<p>The <code>.reloc</code> section contains the <code>Relocation Table</code>. This table is divided into blocks that represents the base relocation.</p>
<p>The start address for the <code>Relocation Table</code> can be retrieved in the <code>PE</code> <code>DataDirectory</code> located in the <code>NtHeader</code>&apos;s <code>OptionalHeader</code> parameter:</p>
<pre><code class="lang-cpp">PVOID firstRelocationBlock = ntHeader-&gt;OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress
</code></pre>
<p>Each block starts with an <code>IMAGE_BASE_RELOCATION</code> and is followed by any number of offsets and field entries.</p>
<p>The <code>IMAGE_BASE_RELOCATION</code> part can be parsed using the following structure:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _IMAGE_BASE_RELOCATION {
    DWORD   VirtualAddress;
    DWORD   SizeOfBlock;
} IMAGE_BASE_RELOCATION;
</code></pre>
<p>The different relocation entries can be iterated from the <code>VirtualAddress</code> address to the <code>VirtualAddress + SizeOfBlock</code> address. So, once the <code>IMAGE_BASE_RELOCATION</code> object is extracted from the relocation table block, it can be used to access to the relocation entries as the relocation table structure can be seen as follows:</p>
<p><img src="img/ReflectiveDLL/relocationTable.jpg" alt="Relocation table structure"></p>
<p>The different <code>IMAGE_BASE_RELOCATION</code> can be iterated using the following code:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">//pseudo code</span>
IMAGE_BASE_RELOCATION* currentRelocation = <span class="hljs-function">firstRelocationBlock
<span class="hljs-title">while</span><span class="hljs-params">(currentRelocation-&gt;VirtualAddress)</span></span>{
    <span class="hljs-comment">// Process the current relocation block</span>
    ...
    <span class="hljs-comment">// Jump to the next relocation block</span>
    currentRelocation = (PBYTE)currentRelocation + currentRelocation-&gt;SizeOfBlock;
}
</code></pre>
<p>So now, it is needed to access to each relocation block&apos;s entry. These entries can be parsed using the following structure:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _IMAGE_RELOCATION_ENTRY {
    WORD Offset : <span class="hljs-number">12</span>;
    WORD Type : <span class="hljs-number">4</span>;
} IMAGE_RELOCATION_ENTRY;
</code></pre>
<p>Each entry contained in the relocation block can be parsed using the following code:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// pseudo code</span>
<span class="hljs-comment">// IMAGE_BASE_RELOCATION *currentRelocation : the current relocation block</span>
IMAGE_RELOCATION_ENTRY* relocationEntry = &amp;currentRelocation[<span class="hljs-number">1</span>];
<span class="hljs-keyword">while</span> ((DWORD64)relocationEntry &lt; (DWORD64)currentRelocation + currentRelocation-&gt;SizeOfBlock){
    <span class="hljs-comment">// process the relocation</span>
    ...
    <span class="hljs-comment">// jump to the next entry</span>
    relocationEntry++;
}
</code></pre>
<p>So, to summarize, the following code can be used to parse a full relocation table:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">//pseudo code</span>
IMAGE_BASE_RELOCATION* currentRelocation = ntHeader-&gt;OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].<span class="hljs-function">VirtualAddress
<span class="hljs-title">while</span><span class="hljs-params">(currentRelocation-&gt;VirtualAddress)</span></span>{
    <span class="hljs-comment">// process the current relocation block</span>
    IMAGE_RELOCATION_ENTRY* relocationEntry = &amp;currentRelocation[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">while</span> ((DWORD64)relocationEntry &lt; (DWORD64)currentRelocation + currentRelocation-&gt;SizeOfBlock){
        <span class="hljs-comment">// process the relocation</span>
        ...
        <span class="hljs-comment">// jump to the next entry</span>
        relocationEntry++;
    }
    <span class="hljs-comment">// jump to the next relocation block</span>
    currentRelocation = (PBYTE)currentRelocation + currentRelocation-&gt;SizeOfBlock;
}
</code></pre>
<h2 id="perform-relocation">Perform relocation</h2>
<p>Performing a relocation is modifying the <code>Relocation Table</code> entries and add an offset equal to the difference of the <code>PE</code> preferred load address and the real <code>PE</code> load address.</p>
<p>So, the <code>relocation</code> address must be found, and its content must be updated. In order to update the <code>relocation</code> content, the <code>relocation</code> type must be taken into account. Indeed, depending on the relocation type, the modification can be handled differently:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>IMAGE_REL_BASED_ABSOLUTE</td>
<td>0x00</td>
<td>The relocation is skipped. It is often used to pad a block</td>
</tr>
<tr>
<td>IMAGE_REL_BASED_HIGH</td>
<td>0x01</td>
<td>The 16 high bits of the offset is added to the current relocation value</td>
</tr>
<tr>
<td>IMAGE_REL_BASED_LOW</td>
<td>0x03</td>
<td>The 16 low bits of the offset is added to the current relocation value</td>
</tr>
<tr>
<td>IMAGE_REL_BASED_HIGHLOW</td>
<td>0x04</td>
<td>The 32 bits of the offset is added to the current relocation value</td>
</tr>
<tr>
<td>IMAGE_REL_BASED_DIR64</td>
<td>0x10</td>
<td>The 64 bits of the offset is added to the current relocation value</td>
</tr>
</tbody>
</table>
<p>The following code can be used to handle the relocations:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// pseudo code </span>
<span class="hljs-comment">// PVOID startAddress : the actual PE load address</span>
<span class="hljs-comment">// IMAGE_BASE_RELOCATION* currentRelocation : the actual relocation block</span>

<span class="hljs-comment">// Compute the offset</span>
DWORD64 offset = startAddress - ntHeader-&gt;OptionalHeader.ImageBase;

<span class="hljs-comment">// Get the first relocation entry in the block</span>
IMAGE_RELOCATION_ENTRY* relocationEntry = &amp;currentRelocation[<span class="hljs-number">1</span>];

<span class="hljs-comment">// Parse all relocation entry in the relocation block</span>
<span class="hljs-keyword">while</span>(relocationEntry &lt; currentRelocation + currentRelocation-&gt;SizeOfBlock){
    <span class="hljs-comment">// Get the relocation address</span>
    DWORD64 relocationRVA = currentRelocation-&gt;VirtualAddress + relocationEntry-&gt;Offset;
    DWORD64 *relocationAddress = startAddress + relocationRVA;

    <span class="hljs-comment">// Process the relocation</span>
    <span class="hljs-keyword">switch</span>(relocationEntry-&gt;Type){
        <span class="hljs-keyword">case</span> IMAGE_REL_BASED_HIGH:
            <span class="hljs-comment">// 16 high bits</span>
            *relocationAddress += HIWORD(offset);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> IMAGE_REL_BASED_LOW:
            <span class="hljs-comment">// 16 low bits</span>
            *relocationAddress += LOWORD(offset);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> IMAGE_REL_BASED_HIGHLOW:
            <span class="hljs-comment">// 32 bits</span>
            *relocationAddress += (DWORD)offset;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> IMAGE_REL_BASED_DIR64:
            <span class="hljs-comment">// 64 bits</span>
            *relocationAddress += offset;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">break</span>;
    }
    relocationEntry ++;
}
</code></pre>
<p>Thus, at this moment, all relocations had been performed and the program should work whatever its load address.</p>
<p>However, what happens if the <code>DLL</code> uses functions defined in another <code>DLL</code> ? In this case, the <code>DLL</code> must be imported and the functions address must be resolved.</p>
<h1 id="process-imported-functions">Process imported functions</h1>
<p><code>DLL</code> have dependencies. Indeed, the <code>DLL</code> could use functions defined in other <code>DLL</code>. For example, the <code>KERNEL32.DLL</code> has the <code>NTDLL.DLL</code> as dependencies : <code>VirtualAlloc</code> will call <code>NtAllocateVirtualMemory</code>.</p>
<p>Thus, these references must also be resolved.</p>
<h2 id="import-directory-table">Import Directory Table</h2>
<p>The <code>Import Directory Table</code> is located in the <code>.idata</code> section and contains one entry for every <code>DLL</code> used by the <code>PE</code>.</p>
<p>The <code>Import Directory Table</code> entry can be parsed using the following structure:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _IMAGE_IMPORT_DESCRIPTOR {
    <span class="hljs-keyword">union</span> {
        DWORD   Characteristics;
        DWORD   OriginalFirstThunk;
    } DUMMYUNIONNAME;
    DWORD   TimeDateStamp;
    DWORD   ForwarderChain;
    DWORD   Name;
    DWORD   FirstThunk;
} IMAGE_IMPORT_DESCRIPTOR;
</code></pre>
<p>&#xE8;</p>
<p>Once the <code>DLL</code> name is known, it must be loaded using a recursive call or using <code>LoadLibrary</code>. However, the use of <code>LoadLibrary</code> is kind of problematic as it will raise several kernel events.</p>
<p>Then, the <code>ILT</code> must be parsed to fill the <code>IAT</code>.</p>
<h2 id="iat-and-ilt">IAT and ILT</h2>
<p>The <code>IAT</code> is a table that will contain the address of the resolved symbols <em>ie the function addresses resolved through <code>GetProcAddress</code></em>. This table is usually empty when the process start and is filled depending on the <code>ILT</code> information.</p>
<p>The <code>ILT</code> is a lookup table containing information about the imported function such as its name, its ordinal etc... The <code>ILT</code> information is used to resolve the imported function address that will be stored in the <code>IAT</code>.</p>
<p>The <code>ILT</code> and <code>IAT</code> entries can be parsed using the following structure:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _IMAGE_THUNK_DATA {
    <span class="hljs-keyword">union</span> {
        ULONGLONG ForwarderString;
        ULONGLONG Function;       
        ULONGLONG Ordinal;
        ULONGLONG AddressOfData;  
    } u1;
} IMAGE_THUNK_DATA;
</code></pre>
<p>For the <code>ILT</code> the interesting parameters are :</p>
<ul>
<li>The <code>AddressOfData</code> parameter that contains the function name <code>RVA</code>. This address points to the <code>IMAGE_IMPORT_BY_NAME</code> structure that can be used to retrieve the function name as a simple string. This string can then be used with <code>GetProcAddress</code> to retrieve the function address.</li>
<li>The <code>Ordinal</code> parameter that contains the function ordinal and can be used to resolve the function address through <code>GetProcAddress</code></li>
</ul>
<p>For the <code>IAT</code> the interesting parameter is :</p>
<ul>
<li>The <code>Function</code> parameter that will receive the function resolved address</li>
</ul>
<p>Thus, the idea is to parse the while <code>ILT</code>, use the <code>AddressOfData</code> or <code>Ordinal</code> parameter to resolve the function address and write it in the <code>IAT&apos;s Function</code> value.</p>
<h2 id="fill-the-iat">Fill the IAT</h2>
<p>The following code can be used to process the imported functions:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// pseudo code</span>

<span class="hljs-comment">// Get the first Import Directory Table entry</span>
IMAGE_IMPORT_DESCRIPTOR* importDescriptor = startAddress + ntHeaders-&gt;OptionalHeader-&gt;dataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;

<span class="hljs-comment">// Iterate through all Import Directory Table entries</span>
<span class="hljs-keyword">for</span> (SIZE_T i = <span class="hljs-number">0</span>; importDescriptor-&gt;Name; importDescriptor++) {
    <span class="hljs-comment">// Get the IAT and ILT first entry</span>
    PIMAGE_THUNK_DATA iat = startAddress + importDescriptor-&gt;FirstThunk;
    PIMAGE_THUNK_DATA ilt = startAddress + importDescriptor-&gt;OriginalFirstThunk;

    <span class="hljs-comment">// Get the associated DLL name</span>
    <span class="hljs-keyword">char</span>* dllName = startAddress + importDescriptor-&gt;Name;

    <span class="hljs-comment">// Load the DLL</span>
    <span class="hljs-comment">// For clean read, the LoadLibrary function is used</span>
    HMODULE dllHandle = GetModuleHandleA(dllName);
    <span class="hljs-keyword">if</span> (!dllHandle) {
        dllHandle = LoadLibraryExA(dllName, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
        <span class="hljs-keyword">if</span> (!dllHandle) {
            <span class="hljs-keyword">return</span> FALSE;
        }
    }

    <span class="hljs-comment">// Iterate through the ILT entries</span>
    <span class="hljs-keyword">for</span> (; ilt-&gt;u1.Function; iat++, ilt++) {
        <span class="hljs-comment">// Check if the function is given as an ordinal</span>
        <span class="hljs-keyword">if</span> (IMAGE_SNAP_BY_ORDINAL(ilt-&gt;u1.Ordinal)) {
            <span class="hljs-comment">// Resolve function name through its ordinal</span>
            LPCSTR functionOrdinal = (LPCSTR)IMAGE_ORDINAL(ilt-&gt;u1.Ordinal);
            <span class="hljs-comment">// Write function address into the IAT&apos;s corresponding entry</span>
            iat-&gt;u1.Function = (DWORD_PTR)GetProcAddress(dllHandle, functionOrdinal);
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Load the HINT structure from the ILT information </span>
            <span class="hljs-comment">// The HINT structure contains address to the function name</span>
            IMAGE_IMPORT_BY_NAME* hint = startAddress + ilt-&gt;u1.AddressOfData;
            <span class="hljs-comment">// Write function address into the IAT&apos;s correspond entry</span>
            iat-&gt;u1.Function = GetProcAddress(dllHandle, hint-&gt;Name);
        }
    }
}
</code></pre>
<p>At this moment, the <code>DLL</code> dependencies are loaded.</p>
<h2 id="delayed-import-table">Delayed Import Table</h2>
<p>The <code>Delayed Import Table</code> works exactly like the standard <code>Import Directory Table</code>. This table has been added to support an uniform mechanism for applications to delay the <code>DLL</code> until one of its exported functions is used.</p>
<p>To avoid any problem, this table will be processed exactly as the <code>Import Directory Table</code>. The only difference is that this table entries will be parsed using the following structure:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _IMAGE_DELAYLOAD_DESCRIPTOR {
    <span class="hljs-keyword">union</span> {
        DWORD AllAttributes;
        <span class="hljs-keyword">struct</span> {
            DWORD RvaBased : <span class="hljs-number">1</span>;            
            DWORD ReservedAttributes : <span class="hljs-number">31</span>;
        } DUMMYSTRUCTNAME;
    } Attributes;

    DWORD DllNameRVA;                      
    DWORD ModuleHandleRVA;                 
    DWORD ImportAddressTableRVA;           
    DWORD ImportNameTableRVA;              
    DWORD BoundImportAddressTableRVA;      
    DWORD UnloadInformationTableRVA;       
    DWORD TimeDateStamp;                   


} IMAGE_DELAYLOAD_DESCRIPTOR
</code></pre>
<p>The <code>DLLNameRVA</code> value contains the <code>RVA</code> to the <code>DLL</code> name.</p>
<p>The <code>ImportAddressTableRVA</code> contains the <code>IAT</code>&apos;s <code>RVA</code>. Likewise, the <code>ImportNameTableRVA</code> contains the <code>ILT</code>&apos;s <code>RVA</code>.</p>
<p>Besides, nothing changes and the previous code used to parse the <code>Import Directory Table</code> can be used as is.</p>
<h1 id="tls-callback-et-dll-main">TLS Callback et DLL Main</h1>
<h2 id="tls-callback">TLS Callback</h2>
<p>The <code>TLS Callback</code> are function ran before the entry point. They are often used by malware as anti-debug techniques but also by legit <code>DLL</code> to set up the environment.</p>
<p>Before running the <code>DLL main</code>, these callbacks must be run. They can be found in the <code>PE</code> <code>DataDirectory</code> in the <code>Entry TLS</code> parameter. The following code can be used to run these functions:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// pseudo code</span>

<span class="hljs-comment">// Check if any TLS callback is defined</span>
<span class="hljs-keyword">if</span> (dllParsed-&gt;dataDirectory[IMAGE_DIRECTORY_ENTRY_TLS].Size) {

    <span class="hljs-comment">// Get the TLS information</span>
    PIMAGE_TLS_DIRECTORY tlsDir = startAddress + dllParsed-&gt;dataDirectory[IMAGE_DIRECTORY_ENTRY_TLS].VirtualAddress

    <span class="hljs-comment">// Get the TLS function address</span>
    PIMAGE_TLS_CALLBACK* callback = (PIMAGE_TLS_CALLBACK*)(tlsDir-&gt;AddressOfCallBacks);
    <span class="hljs-keyword">for</span> (; *callback; callback++) {
        <span class="hljs-comment">// Call the function</span>
        (*callback)((PVOID)dllParsed-&gt;baseAddress, DLL_PROCESS_ATTACH, <span class="hljs-literal">NULL</span>);
    }
}
</code></pre>
<h2 id="dll-main">DLL Main</h2>
<p>The <code>DLL main</code> function is the function called when the <code>DLL</code> is loaded by the system. The following code is an example of <code>DLL Main</code>:</p>
<pre><code class="lang-cpp"><span class="hljs-function">BOOL WINAPI <span class="hljs-title">DllMain</span><span class="hljs-params">(
    HINSTANCE hinstDLL,  <span class="hljs-comment">// handle to DLL module</span>
    DWORD fdwReason,     <span class="hljs-comment">// reason for calling function</span>
    LPVOID lpvReserved )</span>  <span class="hljs-comment">// reserved</span>
</span>{
    <span class="hljs-comment">// Perform actions based on the reason for calling.</span>
    <span class="hljs-keyword">switch</span>( fdwReason ) 
    { 
        <span class="hljs-keyword">case</span> DLL_PROCESS_ATTACH:
         <span class="hljs-comment">// Initialize once for each new process.</span>
         <span class="hljs-comment">// Return FALSE to fail DLL load.</span>
            <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> DLL_THREAD_ATTACH:
         <span class="hljs-comment">// Do thread-specific initialization.</span>
            <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> DLL_THREAD_DETACH:
         <span class="hljs-comment">// Do thread-specific cleanup.</span>
            <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> DLL_PROCESS_DETACH:

            <span class="hljs-keyword">if</span> (lpvReserved != <span class="hljs-literal">nullptr</span>)
            {
                <span class="hljs-keyword">break</span>; <span class="hljs-comment">// do not do cleanup if process termination scenario</span>
            }

         <span class="hljs-comment">// Perform any necessary cleanup.</span>
            <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> TRUE;  <span class="hljs-comment">// Successful DLL_PROCESS_ATTACH.</span>
}
</code></pre>
<p>When the <code>DLL</code> is loaded, the event <code>DLL_PROCESS_ATTACH</code> is used. The following code can be used to call the <code>DLL</code> main:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// pseudo code</span>

<span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">BOOL</span><span class="hljs-params">(WINAPI* LPDLLMAIN)</span><span class="hljs-params">(DWORD_PTR image_base, DWORD reason, LPVOID reserved)</span></span>;

LPDLLMAIN entryPoint = (LPDLLMAIN)startAddress + dllParsed-&gt;ntHeader-&gt;OptionalHeader.AddressOfEntryPoint);
<span class="hljs-keyword">if</span>(entrypoint) {
    BOOL status = entryPoint((HINSTANCE)dllParsed-&gt;baseAddress, DLL_PROCESS_ATTACH, <span class="hljs-literal">NULL</span>);
}
</code></pre>
<p>From now, the <code>DLL</code> should be fully loaded and the exported function can be used.</p>
<h1 id="getprocaddress">GetProcAddress</h1>
<p>The <code>Windows</code> <code>GetProcAddress</code> will not work with the loaded <code>DLL</code> and I wasn&apos;t able to understand why. Indeed, the <code>GetProcAddress</code> function requires a handle to the <code>DLL</code> (<code>HMODULE</code>). The <code>HMODULE</code> type simply represents the <code>DLL</code> base address. However, even when the loaded <code>DLL</code> base address is given to the <code>GetProcAddress</code> function, it cannot find the exported function.</p>
<p>Thus, a custom <code>GetProcAddress</code> function must be developed.</p>
<p>The <code>PE</code> header contains all the information needed to access to the exported function name and addresses. Indeed, the <code>DataDirectory</code> contains the <code>ExportDirectory</code> address that can be used to access to the <code>AddressOfFunctions</code>, <code>AddressOfNames</code> and <code>AddressOfNameOrdinals</code> tables.</p>
<p>The <code>AddressOfNames</code> is a table containing the names of the exported functions.
The <code>AddressOfFunctions</code> is a table containing the address of the exported functions.
The <code>AddressOfNameOrdinals</code> is a lookup table used to link the names from the <code>AddressOfNames</code> to the address from the <code>AddressOfFunctions</code>.</p>
<p>The following code can be used as a custom <code>GetProcAddress</code>:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// pseudo code</span>

DWORD exportDirectoryRVA = (DWORD)dllParsed-&gt;dataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress;
IMAGE_EXPORT_DIRECTORY exportDirectory = startAddress + exportDirectoryRVA;
LPDWORD AddressOfFunctions = startAddress + exportDirectory-&gt;AddressOfFunctions;
LPDWORD AddressOfNames = startAddress + exportDirectory-&gt;AddressOfNames;
LPWORD AddressOfNameOrdinals = startAddress + exportDirectory-&gt;AddressOfNameOrdinals;

<span class="hljs-keyword">for</span> (SIZE_T i = <span class="hljs-number">0</span>; i &lt; exportDirectory-&gt;NumberOfFunctions; i++) {
    <span class="hljs-keyword">char</span> *name = (<span class="hljs-keyword">char</span>*)((DWORD64)startAddress + AddressOfNames[i]);
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(name, functionName) == <span class="hljs-number">0</span>) {
        DWORD64 functionRVA = AddressOfFunctions[AddressOfNameOrdinals[i]];
        <span class="hljs-keyword">return</span> startAddress + functionRVA;
    }
}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Remote DLL Injection.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Remote DLL Injection">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Reflective DLL Injection","level":"1.4.10","depth":2,"next":{"title":"Pentest","level":"1.5","depth":1,"ref":"","articles":[{"title":"Cloud","level":"1.5.1","depth":2,"ref":"","articles":[{"title":"Azure","level":"1.5.1.1","depth":3,"path":"Pentest/Cloud/Azure.md","ref":"Pentest/Cloud/Azure.md","articles":[]}]},{"title":"Configuration Review","level":"1.5.2","depth":2,"ref":"","articles":[{"title":"Database","level":"1.5.2.1","depth":3,"path":"Pentest/Configuration review/Database.md","ref":"Pentest/Configuration review/Database.md","articles":[]},{"title":"Kubernetes","level":"1.5.2.2","depth":3,"path":"Pentest/Configuration review/Kubernetes.md","ref":"Pentest/Configuration review/Kubernetes.md","articles":[]},{"title":"KubernetesCIS","level":"1.5.2.3","depth":3,"path":"Pentest/Configuration review/KubernetesCIS.md","ref":"Pentest/Configuration review/KubernetesCIS.md","articles":[]}]},{"title":"Services","level":"1.5.3","depth":2,"ref":"","articles":[{"title":"AD","level":"1.5.3.1","depth":3,"path":"Pentest/Services/AD.md","ref":"Pentest/Services/AD.md","articles":[]},{"title":"Databases","level":"1.5.3.2","depth":3,"ref":"","articles":[{"title":"Oracle Database","level":"1.5.3.2.1","depth":4,"path":"Pentest/Services/Oracle database.md","ref":"Pentest/Services/Oracle database.md","articles":[]},{"title":"MSSQL","level":"1.5.3.2.2","depth":4,"path":"Pentest/Services/MSSQL.md","ref":"Pentest/Services/MSSQL.md","articles":[]}]},{"title":"DNS","level":"1.5.3.3","depth":3,"path":"Pentest/Services/DNS.md","ref":"Pentest/Services/DNS.md","articles":[]},{"title":"IPMI","level":"1.5.3.4","depth":3,"path":"Pentest/Services/IPMI.md","ref":"Pentest/Services/IPMI.md","articles":[]},{"title":"Kerberos","level":"1.5.3.5","depth":3,"path":"Pentest/Services/Kerberos.md","ref":"Pentest/Services/Kerberos.md","articles":[]},{"title":"LDAP","level":"1.5.3.6","depth":3,"path":"Pentest/Services/LDAP.md","ref":"Pentest/Services/LDAP.md","articles":[]},{"title":"Memcached","level":"1.5.3.7","depth":3,"path":"Pentest/Services/Memcached.md","ref":"Pentest/Services/Memcached.md","articles":[]},{"title":"NFS","level":"1.5.3.8","depth":3,"path":"Pentest/Services/NFS.md","ref":"Pentest/Services/NFS.md","articles":[]},{"title":"RPC","level":"1.5.3.9","depth":3,"path":"Pentest/Services/RPC.md","ref":"Pentest/Services/RPC.md","articles":[]},{"title":"SMB","level":"1.5.3.10","depth":3,"path":"Pentest/Services/SMB.md","ref":"Pentest/Services/SMB.md","articles":[]},{"title":"SNMP","level":"1.5.3.11","depth":3,"path":"Pentest/Services/SNMP.md","ref":"Pentest/Services/SNMP.md","articles":[]},{"title":"Tomcat","level":"1.5.3.12","depth":3,"path":"Pentest/Services/Tomcat.md","ref":"Pentest/Services/Tomcat.md","articles":[]},{"title":"WebDAV","level":"1.5.3.13","depth":3,"path":"Pentest/Services/WebDAV.md","ref":"Pentest/Services/WebDAV.md","articles":[]}]},{"title":"Techniques","level":"1.5.4","depth":2,"ref":"","articles":[{"title":"Abuse ADCS","level":"1.5.4.1","depth":3,"path":"Pentest/Techniques/ADCS abuses.md","ref":"Pentest/Techniques/ADCS abuses.md","articles":[]},{"title":"Abuse Tokens","level":"1.5.4.2","depth":3,"path":"Pentest/Techniques/Abuse tokens.md","ref":"Pentest/Techniques/Abuse tokens.md","articles":[]},{"title":"Abuse Trusts","level":"1.5.4.3","depth":3,"path":"Pentest/Techniques/Trusts abuses.md","ref":"Pentest/Techniques/Trusts abuses.md","articles":[]},{"title":"Buffer Overflow","level":"1.5.4.4","depth":3,"path":"Pentest/Techniques/Buffer overflow.md","ref":"Pentest/Techniques/Buffer overflow.md","articles":[]},{"title":"Command Injection","level":"1.5.4.5","depth":3,"path":"Pentest/Techniques/Command injection.md","ref":"Pentest/Techniques/Command injection.md","articles":[]},{"title":"Data Exfiltration","level":"1.5.4.6","depth":3,"path":"Pentest/Techniques/Data exfiltration.md","ref":"Pentest/Techniques/Data exfiltration.md","articles":[]},{"title":"Exploit handles","level":"1.5.4.7","depth":3,"path":"Pentest/Techniques/Exploit handles.md","ref":"Pentest/Techniques/Exploit handles.md","articles":[]},{"title":"Filtering","level":"1.5.4.8","depth":3,"path":"Pentest/Techniques/Filtering.md","ref":"Pentest/Techniques/Filtering.md","articles":[]},{"title":"Kioske Escape","level":"1.5.4.9","depth":3,"path":"Pentest/Techniques/Kioske escape.md","ref":"Pentest/Techniques/Kioske escape.md","articles":[]},{"title":"LFI","level":"1.5.4.10","depth":3,"path":"Pentest/Techniques/LFI.md","ref":"Pentest/Techniques/LFI.md","articles":[]},{"title":"Password Spraying","level":"1.5.4.11","depth":3,"path":"Pentest/Techniques/Password spraying.md","ref":"Pentest/Techniques/Password spraying.md","articles":[]},{"title":"Pivoting","level":"1.5.4.12","depth":3,"path":"Pentest/Techniques/Pivoting.md","ref":"Pentest/Techniques/Pivoting.md","articles":[]},{"title":"Privilege Escalation","level":"1.5.4.13","depth":3,"ref":"","articles":[{"title":"Windows","level":"1.5.4.13.1","depth":4,"path":"Pentest/Techniques/Privileges escalation/Windows.md","ref":"Pentest/Techniques/Privileges escalation/Windows.md","articles":[]},{"title":"Linux","level":"1.5.4.13.2","depth":4,"path":"Pentest/Techniques/Privileges escalation/Linux.md","ref":"Pentest/Techniques/Privileges escalation/Linux.md","articles":[]}]},{"title":"Reverse Shell","level":"1.5.4.14","depth":3,"path":"Pentest/Techniques/Reverse shell.md","ref":"Pentest/Techniques/Reverse shell.md","articles":[]},{"title":"Shellshock","level":"1.5.4.15","depth":3,"path":"Pentest/Techniques/Shellshock.md","ref":"Pentest/Techniques/Shellshock.md","articles":[]},{"title":"SQL Injection","level":"1.5.4.16","depth":3,"path":"Pentest/Techniques/SQL injection.md","ref":"Pentest/Techniques/SQL injection.md","articles":[]},{"title":"SSTI","level":"1.5.4.17","depth":3,"path":"Pentest/Techniques/SSTI.md","ref":"Pentest/Techniques/SSTI.md","articles":[]}]},{"title":"Technology","level":"1.5.5","depth":2,"ref":"","articles":[{"title":"AD","level":"1.5.5.1","depth":3,"path":"Pentest/Technology/AD.md","ref":"Pentest/Technology/AD.md","articles":[]},{"title":"IOS","level":"1.5.5.2","depth":3,"path":"Pentest/Technology/IOS.md","ref":"Pentest/Technology/IOS.md","articles":[]},{"title":"NAC","level":"1.5.5.3","depth":3,"path":"Pentest/Technology/NAC.md","ref":"Pentest/Technology/NAC.md","articles":[]},{"title":"Port Knocking","level":"1.5.5.4","depth":3,"path":"Pentest/Technology/Port Knocking.md","ref":"Pentest/Technology/Port Knocking.md","articles":[]},{"title":"SAML","level":"1.5.5.5","depth":3,"path":"Pentest/Technology/SAML.md","ref":"Pentest/Technology/SAML.md","articles":[]},{"title":"SAP","level":"1.5.5.6","depth":3,"path":"Pentest/Technology/SAP.md","ref":"Pentest/Technology/SAP.md","articles":[]}]},{"title":"Tools","level":"1.5.6","depth":2,"ref":"","articles":[{"title":"BloundHound","level":"1.5.6.1","depth":3,"path":"Pentest/Tools/BloundHound.md","ref":"Pentest/Tools/BloundHound.md","articles":[]},{"title":"CME","level":"1.5.6.2","depth":3,"path":"Pentest/Tools/CME.md","ref":"Pentest/Tools/CME.md","articles":[]},{"title":"Curl","level":"1.5.6.3","depth":3,"path":"Pentest/Tools/Curl.md","ref":"Pentest/Tools/Curl.md","articles":[]},{"title":"FFUF","level":"1.5.6.4","depth":3,"path":"Pentest/Tools/Ffuf.md","ref":"Pentest/Tools/Ffuf.md","articles":[]},{"title":"Find","level":"1.5.6.5","depth":3,"path":"Pentest/Tools/Find.md","ref":"Pentest/Tools/Find.md","articles":[]},{"title":"Hydra","level":"1.5.6.6","depth":3,"path":"Pentest/Tools/Hydra.md","ref":"Pentest/Tools/Hydra.md","articles":[]},{"title":"PowerView","level":"1.5.6.7","depth":3,"path":"Pentest/Tools/PowerView.md","ref":"Pentest/Tools/PowerView.md","articles":[]},{"title":"Powershell","level":"1.5.6.8","depth":3,"path":"Pentest/Tools/Powershell.md","ref":"Pentest/Tools/Powershell.md","articles":[]},{"title":"Responder","level":"1.5.6.9","depth":3,"path":"Pentest/Tools/Responder.md","ref":"Pentest/Tools/Responder.md","articles":[]},{"title":"Rubeus","level":"1.5.6.10","depth":3,"path":"Pentest/Tools/Rubeus.md","ref":"Pentest/Tools/Rubeus.md","articles":[]},{"title":"Strace","level":"1.5.6.11","depth":3,"path":"Pentest/Tools/Strace.md","ref":"Pentest/Tools/Strace.md","articles":[]},{"title":"Wfuzz","level":"1.5.6.12","depth":3,"path":"Pentest/Tools/Wfuzz.md","ref":"Pentest/Tools/Wfuzz.md","articles":[]}]}]},"previous":{"title":"Remote DLL Injection","level":"1.4.9","depth":2,"path":"Malware/Remote DLL Injection.md","ref":"Malware/Remote DLL Injection.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-sharing","collapsible-chapters@git+https://gitlab.dqr/gitbook-plugin/collapsible-chapters.git#main","copy-code-button@git+https://gitlab.dqr/gitbook-plugin/copy-code-button.git#main","hide-published-with","search-plus","simple-page-toc"],"pluginsConfig":{"github":{"url":"https://github.com/YoannDqr"},"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"hide-published-with":{},"fontsettings":{"theme":"white","family":"sans","size":2},"twitter":{"url":"https://twitter.com/HackerOtter"},"highlight":{},"copy-code-button":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Malware/Reflective DLL injection.md","mtime":"2022-09-01T09:30:51.408Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-01-22T17:41:15.543Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

